<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á°¨Èù∂Â∞àÊ•≠Ë®òÂàÜÊùø V73 (Èõô‰∫∫Ë≥ΩÊ©´ÂêëÊéíÁâàÂÑ™Âåñ)</title>
    <style>
        /* === ÂÖ®ÂüüÊ®£Âºè === */
        :root {
            --bg-color: #eef2f5; --panel-bg: #ffffff; --left-bg: #dfe4ea;
            --text-main: #1a1a1a; --text-sub: #555555;
            --p1-color: #007bff; --p2-color: #dc3545; 
            --line-color: #555; --line-width: 2px;
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; background-color: var(--bg-color); }
        body { display: flex; flex-direction: column; }
        #main-container { flex: 1; display: flex; height: 100%; overflow: hidden; }
        
        #left-panel { flex: 6; display: flex; justify-content: center; align-items: center; background: var(--left-bg); border-right: 1px solid #ccc; position: relative; }
        #right-panel { flex: 4; background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.05); z-index: 10; overflow-y: auto; }

        /* UI ÂÖÉ‰ª∂ */
        #bracket-btn { width: 100%; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; gap: 8px; font-size: 1rem; }
        .player-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 10px; margin-bottom: 12px; opacity: 0.7; transition: all 0.2s; position: relative; }
        .player-card.active { opacity: 1; background: #fff; border-width: 3px; transform: scale(1.01); }
        .player-card.active-p1 { border-color: var(--p1-color); } .player-card.active-p2 { border-color: var(--p2-color); }
        
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .player-name { font-size: 1.3rem; font-weight: 900; white-space: pre-wrap; line-height: 1.2; word-break: break-word; }
        .turn-indicator { font-size: 1.5rem; visibility: hidden; }
        .active .turn-indicator { visibility: visible; }

        .dart-slots { display: flex; gap: 5px; margin-bottom: 5px; height: 30px; }
        .dart-slot { flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; font-size: 1rem; }
        .dart-slot.filled { color: #000; border-color: #333; background: #e9ecef; }
        .dart-slot.miss { color: #dc3545; background: #fff0f0; border-color: #dc3545; }

        /* ÂàÜÊï∏ËàáÊï∏ÊìöÂçÄ */
        .score-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .stats-col { text-align: left; display: flex; flex-direction: column; justify-content: center; width: 40%; }
        .stat-label { font-size: 0.8rem; color: #888; font-weight: bold; text-transform: uppercase; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: #555; }
        .checkout-hint { font-size: 0.9rem; color: #d63031; font-weight: bold; margin-top: 4px; min-height: 1.2em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-big { font-size: 4.5rem; font-weight: 900; text-align: right; line-height: 1; width: 60%; }
        
        .round-display { font-size: 1.1rem; font-weight: bold; color: #666; text-align: right; margin-top: -5px; }
        
        #logo-placeholder { flex-grow: 1; display: flex; justify-content: center; align-items: center; border: 2px dashed #e0e0e0; border-radius: 12px; margin: 15px 0; color: #ccc; font-weight: bold; letter-spacing: 1px; min-height: 100px; }

        #control-panel { height: 60px; display: grid; grid-template-columns: 1fr 2.5fr; gap: 12px; margin-top: auto; }
        button { border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        button:active { transform: translateY(4px); box-shadow: none; }
        #btn-undo { background: #fff; color: #495057; border: 2px solid #ced4da; }
        #btn-next { background: #007bff; color: #fff; opacity: 0.5; pointer-events: none; }
        #btn-next.ready { opacity: 1; pointer-events: all; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #btn-miss-trigger {
            position: absolute; bottom: 20px; left: 20px; z-index: 50;
            background: #dc3545; color: white; width: 80px; height: 80px;
            border-radius: 50%; font-size: 1rem; font-weight: 900;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid white;
        }
        #btn-miss-trigger:active { transform: scale(0.95); }

        #board-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.85); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .overlay-text { color: #000; font-size: 2.5rem; font-weight: 900; }

        /* === Ë≥ΩÁ®ãË°®Ê®£Âºè === */
        #bracket-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f0f2f5; z-index: 200; display: none; flex-direction: column; }
        #bracket-header { background: #fff; border-bottom: 1px solid #ccc; padding: 15px 20px; display:flex; flex-direction:column; gap:10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 10px; }
        .header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap;}
        .label-text { font-weight: bold; color: #555; font-size: 0.9rem; }

        .view-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 5px; width: 100%; }
        .view-tab { padding: 8px 20px; border: 2px solid #ccc; background: #fff; color: #555; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .view-tab.active { background: #007bff; color: white; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        .view-tab:hover:not(.active) { background: #f0f0f0; }

        #bracket-content { flex: 1; overflow: auto; position: relative; background: #f8f9fa; }
        #bracket-scroll-view { position: relative; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; }
        
        #bracket-lines { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; width: 100%; height: 100%; }
        .connector-path { fill: none; stroke: var(--line-color); stroke-width: var(--line-width); shape-rendering: crispEdges; }
        
        .bracket-container { display: flex; gap: 80px; position: relative; z-index: 2; width: max-content; padding: 20px; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; padding-top: 50px; position: relative; min-width: 180px; }
        .round-header { position: absolute; top: 0; width: 100%; text-align: center; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .round-title { font-weight: bold; color: #555; font-size: 1rem; }
        
        /* ‚òÖ ‰øÆÊîπÔºöÁ®çÂæÆÂä†ÂØ¨Âç°ÁâáÔºåËÆìÈõô‰∫∫ÂêçÂ≠óÂèØ‰ª•Ê©´ÂêëÊîæÂæó‰∏ã */
        .match-card { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 8px; margin: 20px 0; width: 220px; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .match-card:hover { border-color: #007bff; transform: translateY(-2px); }
        .match-label { font-size: 0.75rem; color: #007bff; font-weight: bold; margin-bottom: 2px; }
        .team-block { display: flex; flex-direction: column; gap: 2px; margin-bottom: 6px; border: 1px solid #eee; padding: 4px; border-radius: 4px; background: #fcfcfc; }
        .bracket-input { width: 100%; box-sizing: border-box; border: none; border-bottom: 1px solid #eee; font-size: 16px; padding: 4px; text-align: left; background: transparent; }
        .vs-text { font-size: 0.65rem; color: #ccc; text-align: center; margin: 1px 0; font-weight: bold;}

        /* Â∞èÁµÑË≥Ω Grid */
        .group-stage-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px; 
            width: 100%; 
            max-width: 1200px;
            margin: 0 auto;
        }
        @media (min-width: 768px) { .group-stage-container { grid-template-columns: 1fr 1fr; } }

        .group-box { background: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 15px; width: 100%; border-top: 5px solid #007bff; box-sizing: border-box; }
        .group-header-text { font-size: 1.4rem; font-weight: 900; color: #333; margin-bottom: 10px; }
        
        .standings-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 15px; }
        .standings-table th { background: #f8f9fa; padding: 8px; text-align: center; color: #555; font-size: 0.8rem; border-bottom: 2px solid #ddd; }
        .standings-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: center; font-weight: bold; vertical-align: middle; }
        .standings-table td:first-child { text-align: left; }
        
        .name-input { width: 98%; border: none; border-bottom: 1px dashed #ccc; font-size: 0.95rem; font-weight: bold; color: #333; text-align: left; padding: 4px 2px; background: transparent; transition: 0.2s; }
        .name-input:focus { outline: none; border-bottom: 2px solid #007bff; background: #fff; }

        .double-input-group { display: flex; align-items: center; justify-content: space-between; }
        .name-input.half { width: 42%; text-align: center; }
        .separator { width: 10%; text-align: center; color: #999; font-weight: bold; }

        .rank-1 { color: #d63031; background: #fff5f5; } 
        .rank-2 { color: #0984e3; background: #f0f7ff; } 

        .schedule-container { width: 100%; max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        .schedule-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .schedule-table th { background: #343a40; color: #fff; padding: 12px; text-align: left; font-size: 0.9rem; }
        .schedule-table td { padding: 12px; border-bottom: 1px solid #eee; color: #333; font-weight: bold; vertical-align: middle; }
        .schedule-table tr:hover { background: #f8f9fa; }
        
        .time-input { border: 1px solid #ccc; border-radius: 4px; padding: 4px; font-family: inherit; width: 80px; text-align: center; }
        .score-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; background: #e9ecef; color: #555; min-width: 40px; text-align: center; }
        .score-tag.done { background: #28a745; color: white; }
        .play-btn { padding: 4px 12px; background: #007bff; color: white; border-radius: 4px; text-decoration: none; font-size: 0.85rem; cursor: pointer; display: inline-block; }
        .play-btn.disabled { background: #ccc; cursor: default; }

        .control-select { padding: 5px; font-size: 0.9rem; border: 2px solid #007bff; border-radius: 5px; color: #007bff; font-weight: bold; background: white; cursor: pointer; }

        svg#dartboard { max-width: 90%; max-height: 90%; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); }
        .area-black { fill: #212529; stroke: #6c757d; } .area-white { fill: #f8f9fa; stroke: #6c757d; }
        .area-red { fill: #e02e42; stroke: #6c757d; } .area-green { fill: #26a65b; stroke: #6c757d; }
        .text-label { font-size: 24px; font-weight: 900; fill: #fff; pointer-events: none; text-anchor: middle; dominant-baseline: central; alignment-baseline: central; text-shadow: 0 0 4px rgba(0,0,0,0.9); }
        .dart-marker { pointer-events: none; stroke: #fff; stroke-width: 1px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3)); transition: all 0.15s ease-out; }
        .dart-marker-1 { fill: #dc3545; } .dart-marker-2 { fill: #28a745; } .dart-marker-3 { fill: #007bff; } 

        /* ËªüÈù∂Ê®°ÂºèÊ®£Âºè */
        #btn-soft-tip {
            position: absolute; bottom: 20px; right: 20px; z-index: 50;
            background: #ff9f43; color: white; width: 80px; height: 80px;
            border-radius: 50%; font-size: 1rem; font-weight: 900;
            box-shadow: 0 4px 10px rgba(255, 159, 67, 0.4);
            cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; border: 4px solid white;
        }
        #btn-soft-tip:active { transform: scale(0.95); }

        /* ËªüÈù∂Á∞°ÊòìË®àÂàÜÊùø */
        #soft-tip-panel {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #2d3436; z-index: 300; /* ËìãÈÅé‰∏ÄÂàá */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .st-container { display: flex; align-items: center; gap: 40px; }
        .st-player-col { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .st-name { font-size: 2rem; font-weight: bold; }
        .st-score { font-size: 6rem; font-weight: 900; line-height: 1; }
        .st-btn-add {
            width: 80px; height: 80px; border-radius: 50%; border: none;
            font-size: 2.5rem; cursor: pointer; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.1s;
        }
        .st-btn-add:active { transform: scale(0.95); }
        .st-btn-p1 { background: #007bff; }
        .st-btn-p2 { background: #dc3545; }
        .st-vs { font-size: 3rem; font-weight: bold; color: #636e72; margin-top: -50px;}
        #st-close {
            position: absolute; top: 20px; right: 20px;
            padding: 10px 20px; background: transparent; border: 2px solid #aaa;
            color: #aaa; border-radius: 20px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="bracket-modal">
        <div id="bracket-header">
            <div class="top-bar">
                <div class="header-controls">
                    <span class="label-text">ÂàÜÊï∏Ôºö</span>
                    <select id="score-selector" class="control-select" onchange="changeTargetScore()">
                        <option value="301">301</option>
                        <option value="501" selected>501</option>
                        <option value="701">701</option>
                    </select>

                    <span class="label-text">Ê®°ÂºèÔºö</span>
                    <select id="mode-selector" class="control-select" onchange="changeGameMode()">
                        <option value="single">ÂÄã‰∫∫Ë≥Ω (Singles)</option>
                        <option value="double">Èõô‰∫∫Ë≥Ω (Doubles)</option>
                        <option value="team">ÂúòÈ´îË≥Ω (Team)</option>
                    </select>

                    <span class="label-text">Ë≥ΩÂà∂Ôºö</span>
                    <select id="format-selector" class="control-select" onchange="changeBracketFormat()">
                        <option value="knockout">ÂñÆÊ∑òÊ±∞Ë≥Ω (Knockout)</option>
                        <option value="group">Â∞èÁµÑÂæ™Áí∞Ë≥Ω (Round Robin)</option>
                    </select>
                    
                    <span class="label-text">Á∏Ω‰∫∫Êï∏Ôºö</span>
                    <select id="size-selector" class="control-select" onchange="changeBracketSize()">
                        <option value="4">4ÁµÑ (ÂàÜ1ÁµÑ)</option>
                        <option value="8" selected>8ÁµÑ (ÂàÜ2ÁµÑ)</option>
                        <option value="16">16ÁµÑ (ÂàÜ4ÁµÑ)</option>
                        <option value="32">32ÁµÑ (ÂàÜ8ÁµÑ)</option>
                        <option value="64">64ÁµÑ (ÂàÜ16ÁµÑ)</option>
                        <option value="128">128‰∫∫</option> 
                    </select>
                </div>
                <button id="close-bracket" onclick="closeBracket()" style="padding:5px 15px; cursor:pointer; background:#eee; color:#333; border:1px solid #ccc;">ÈóúÈñâ</button>
            </div>
            
            <div class="view-tabs" id="group-tabs" style="display:none;">
                <div class="view-tab active" onclick="setSubView('rankings')">üìä Á©çÂàÜÊ¶ú (Standings)</div>
                <div class="view-tab" onclick="setSubView('schedule')">üìÖ Ë≥ΩÁ®ãË°® (Schedule)</div>
            </div>
            
            <div class="view-tabs" id="knockout-tabs" style="display:none;">
                <div class="view-tab active" onclick="setSubView('bracket')">üå≥ Ê®πÁãÄÂúñ (Bracket)</div>
                <div class="view-tab" onclick="setSubView('schedule')">üìÖ Ë≥ΩÁ®ãË°® (Schedule)</div>
            </div>

            <div id="advance-btn-container" style="text-align:center; display:none; margin-top:10px;">
                <button onclick="generateKnockoutFromGroups()" style="background:#28a745; color:white; padding:8px 20px; border-radius:20px; font-size:1rem; font-weight:bold; border:none; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                    üèÜ ÁµêÁÆóÊàêÁ∏æ‰∏¶Áî¢ÁîüÊ±∫Ë≥ΩË°®
                </button>
            </div>
            
            <div id="back-to-group-container" style="text-align:center; display:none; margin-top:10px;">
                <button onclick="switchStageView('group')" style="background:#6c757d; color:white; padding:5px 15px; border-radius:15px; font-size:0.9rem; font-weight:bold; border:none; cursor:pointer;">
                    ‚Ü© ËøîÂõûÂ∞èÁµÑË≥Ω‰øÆÊîπÊàêÁ∏æ
                </button>
            </div>
        </div>
        
        <div id="bracket-content">
            <div id="bracket-scroll-view">
                <svg id="bracket-lines"></svg>
                <div id="group-stage-container" class="group-stage-container" style="display:none;"></div>
                <div id="group-schedule-container" class="schedule-container" style="display:none;"></div>
                <div id="bracket-container" class="bracket-container mode-single" style="display:none;"></div>
                <div id="knockout-schedule-container" class="schedule-container" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="left-panel">
            <svg id="dartboard" viewBox="-250 -250 500 500"></svg>
            <button id="btn-miss-trigger" onclick="handleMiss()"><div>MISS</div><div style="font-size:0.8rem">ËÑ´Èù∂</div></button>
            
            <button id="btn-soft-tip" onclick="toggleSoftTip(true)">
                <div>SOFT</div>
                <div style="font-size:0.8rem">ËªüÈù∂</div>
            </button>

            <div id="board-overlay">
                <div class="overlay-text">Ë´ãÊ†∏Â∞çÂàÜÊï∏</div>
                <div style="font-size:1.2rem; color:#555; font-weight:bold; margin-top:10px;">‰∏¶Êåâ‰∏ãÊèõ‰∫∫Èçµ</div>
            </div>
        </div>

        <div id="right-panel">
            <button id="bracket-btn" onclick="openBracket()">Ë≥ΩÁ®ãË°® / Êà∞Á∏æËº∏ÂÖ•</button>
            <div class="player-card active active-p1" id="p1-card">
                <div class="player-header"><div class="turn-indicator">üëâ</div><div class="player-name" id="p1-name">Player 1</div></div>
                <div class="dart-slots" id="p1-slots"><div class="dart-slot">-</div><div class="dart-slot">-</div><div class="dart-slot">-</div></div>
                <div class="score-row">
                    <div class="stats-col">
                        <div class="stat-label">AVG</div>
                        <div class="stat-value" id="p1-avg">0.00</div>
                        <div class="checkout-hint" id="p1-hint"></div>
                    </div>
                    <div class="score-big" id="p1-score">501</div>
                </div>
                <div class="round-display">Legs: <span id="p1-legs">0</span></div>
            </div>
            <div class="player-card" id="p2-card">
                <div class="player-header"><div class="turn-indicator">üëâ</div><div class="player-name" id="p2-name">Player 2</div></div>
                <div class="dart-slots" id="p2-slots"><div class="dart-slot">-</div><div class="dart-slot">-</div><div class="dart-slot">-</div></div>
                <div class="score-row">
                    <div class="stats-col">
                        <div class="stat-label">AVG</div>
                        <div class="stat-value" id="p2-avg">0.00</div>
                        <div class="checkout-hint" id="p2-hint"></div>
                    </div>
                    <div class="score-big" id="p2-score">501</div>
                </div>
                <div class="round-display">Legs: <span id="p2-legs">0</span></div>
            </div>
            <div id="logo-placeholder">LOGO / Ë≥Ω‰∫ãÂêçÁ®±</div>
            <div id="control-panel">
                <button id="btn-undo" onclick="undoLastDart()">Âæ©Âéü</button>
                <button id="btn-next" onclick="switchPlayer()">Êèõ‰∏ã‰∏Ä‰Ωç (NEXT)</button>
            </div>
        </div>
    </div>

    <div id="soft-tip-panel">
        <button id="st-close" onclick="toggleSoftTip(false)">ÂõûÁ°¨Èù∂Ê®°Âºè</button>
        <div style="font-size:1.5rem; color:#aaa; margin-bottom:20px;">ËªüÈù∂ / Á∞°ÊòìË®àÂàÜÊ®°Âºè</div>
        
        <div id="st-target-display" style="color: #ff9f43; font-weight: bold; margin-bottom: 20px; font-size: 1.2rem;"></div>

        <div class="st-container">
            <div class="st-player-col">
                <div class="st-name" id="st-p1-name">Player 1</div>
                <div class="st-score" id="st-p1-legs">0</div>
                <button class="st-btn-add st-btn-p1" onclick="manualAddLeg(1)">+</button>
            </div>

            <div class="st-vs">:</div>

            <div class="st-player-col">
                <div class="st-name" id="st-p2-name">Player 2</div>
                <div class="st-score" id="st-p2-legs">0</div>
                <button class="st-btn-add st-btn-p2" onclick="manualAddLeg(2)">+</button>
            </div>
        </div>
        <div style="margin-top:40px; color:#636e72;">ÈªûÊìä„Äå+„ÄçÁõ¥Êé•Â¢ûÂä†Â±ÄÊï∏ (Legs)</div>
    </div>

<script>
    window.onerror = function(message, source, lineno, colno, error) {
        alert("Á®ãÂºèÈåØË™§: " + message);
    };

    window.addEventListener('beforeunload', function (e) { e.preventDefault(); e.returnValue = ''; });

    let TOTAL_PLAYERS = 8;
    let matchesData = {};
    
    let currentStage = 'group'; // group or final
    let currentSubView = 'rankings'; // rankings, schedule, bracket
    let groupsData = {}; 
    let groupMatches = []; 
    let currentMatchId = null; 
    let targetLegs = 3;

    let GAME_MODE = 501; 
    
    let currentPlayer = 1, legStarter = 1, turnDarts = 0, isBoardLocked = false;
    let players = { 
        1: { score: GAME_MODE, legs: 0, roundHistory: [], matchTotalScore: 0, matchTotalDarts: 0 }, 
        2: { score: GAME_MODE, legs: 0, roundHistory: [], matchTotalScore: 0, matchTotalDarts: 0 } 
    };
    let throwHistory = [];
    let turnHitCounts = {}; 
    let markers = [];

    window.onload = function() { 
        createBoard(); 
        updateSizeOptions(); 
        setTimeout(initBracketStructure, 50); 
    };
    
    // === Ë¶ñÁ™óÊéßÂà∂ÂáΩÂºè ===
    function openBracket() {
        document.getElementById('bracket-modal').style.display = 'flex';
        if (currentSubView === 'bracket') {
            setTimeout(drawConnectors, 100); 
        }
    }

    function closeBracket() {
        document.getElementById('bracket-modal').style.display = 'none';
    }

    // === Êñ∞Â¢ûÔºöÊõ¥ÊîπÂàÜÊï∏Ê®°ÂºèÂáΩÂºè ===
    function changeTargetScore() {
        const val = document.getElementById('score-selector').value;
        GAME_MODE = parseInt(val);
        // Â¶ÇÊûúÁï∂ÂâçÈÅäÊà≤ÈÇÑÊ≤íÈñãÂßã (ÂàÜÊï∏ÈÇÑÊòØËàäÁöÑÈ†êË®≠ÂÄº)ÔºåÂ∞±È†Ü‰æøÈáçÁΩÆ‰∏Ä‰∏ã
        resetGame();
    }

    // === ËªüÈù∂Ê®°ÂºèÊéßÂà∂ÈÇèËºØ ===
    function toggleSoftTip(show) {
        const panel = document.getElementById('soft-tip-panel');
        if (show) {
            document.getElementById('st-p1-name').innerText = document.getElementById('p1-name').innerText;
            document.getElementById('st-p2-name').innerText = document.getElementById('p2-name').innerText;
            document.getElementById('st-p1-legs').innerText = players[1].legs;
            document.getElementById('st-p2-legs').innerText = players[2].legs;
            
            // ‚òÖ Êñ∞Â¢ûÔºöÈ°ØÁ§∫ÁõÆÊ®ôÂ±ÄÊï∏
            document.getElementById('st-target-display').innerText = `Ë≥ΩÂà∂ÔºöÊê∂ ${targetLegs} Âãù (Race to ${targetLegs})`;

            panel.style.display = 'flex';
        } else {
            panel.style.display = 'none';
            updateUI(); 
        }
    }

    function manualAddLeg(pid) {
        players[pid].legs++;
        document.getElementById(`st-p${pid}-legs`).innerText = players[pid].legs;
        
        if (players[pid].legs >= targetLegs) {
            setTimeout(() => {
                advanceWinner(pid); 
                toggleSoftTip(false); 
                resetGame(); 
            }, 100);
        }
    }
    // ===========================

    function updateSizeOptions() {
        const format = document.getElementById('format-selector').value;
        const sizeSelect = document.getElementById('size-selector');
        
        let currentValue = parseInt(sizeSelect.value);
        if(isNaN(currentValue)) currentValue = 8;

        sizeSelect.innerHTML = ''; 

        let options = [4, 8, 16, 32, 64];
        if (format === 'knockout') {
            options.push(128);
        }

        options.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            if (format === 'group') {
                const groupCount = Math.max(1, Math.ceil(val / 4));
                opt.text = `${val}‰∫∫ (ÂàÜ${groupCount}ÁµÑ)`;
            } else {
                opt.text = `${val}‰∫∫`;
            }
            sizeSelect.appendChild(opt);
        });

        if (options.includes(currentValue)) {
            sizeSelect.value = currentValue;
        } else {
            if (currentValue > 64 && format === 'group') currentValue = 64;
            else currentValue = 8;
            sizeSelect.value = currentValue;
        }
        TOTAL_PLAYERS = currentValue;
    }

    function changeGameMode() {
        if(confirm("ÂàáÊèõÊ®°ÂºèÂ∞áÈáçÁΩÆË≥ΩÁ®ãÔºåÁ¢∫ÂÆöÂóéÔºü")) {
            initBracketStructure();
        }
    }

    function changeBracketFormat() {
        const fmtEl = document.getElementById('format-selector');
        updateSizeOptions(); 
        initBracketStructure(); 
    }

    function changeBracketSize() {
        const sizeEl = document.getElementById('size-selector');
        TOTAL_PLAYERS = parseInt(sizeEl.value);
        initBracketStructure();
    }

    function initBracketStructure() {
        matchesData = {};
        const fmtEl = document.getElementById('format-selector');
        if (!fmtEl) return;
        const format = fmtEl.value;
        
        document.getElementById('advance-btn-container').style.display = 'none';
        document.getElementById('back-to-group-container').style.display = 'none';

        if (format === 'group') {
            if (TOTAL_PLAYERS > 4) {
                document.getElementById('advance-btn-container').style.display = 'block';
            }
            initGroupStage();
            switchStageView('group');
            setSubView('rankings'); 
        } else {
            switchStageView('final');
            renderKnockoutBracket(); 
            setSubView('bracket'); 
        }
    }

    function setSubView(sub) {
        currentSubView = sub;
        const isGroup = (currentStage === 'group');
        
        document.getElementById('group-stage-container').style.display = 'none';
        document.getElementById('group-schedule-container').style.display = 'none';
        document.getElementById('bracket-container').style.display = 'none';
        document.getElementById('knockout-schedule-container').style.display = 'none';
        document.getElementById('bracket-lines').style.display = 'none';

        const tabs = isGroup ? document.getElementById('group-tabs') : document.getElementById('knockout-tabs');
        const tabBtns = tabs.getElementsByClassName('view-tab');
        for(let btn of tabBtns) btn.classList.remove('active');
        
        if (isGroup) {
            if (sub === 'rankings') {
                document.getElementById('group-stage-container').style.display = 'grid';
                tabBtns[0].classList.add('active');
                renderGroupView(); 
            } else {
                document.getElementById('group-schedule-container').style.display = 'flex';
                tabBtns[1].classList.add('active');
                renderGroupSchedule(); 
            }
        } else {
            if (sub === 'bracket') {
                document.getElementById('bracket-container').style.display = 'flex';
                document.getElementById('bracket-lines').style.display = 'block';
                tabBtns[0].classList.add('active');
                requestAnimationFrame(() => { setTimeout(drawConnectors, 50); });
            } else {
                document.getElementById('knockout-schedule-container').style.display = 'flex';
                tabBtns[1].classList.add('active');
                renderKnockoutSchedule();
            }
        }
    }

    function initGroupStage() {
        groupsData = {};
        groupMatches = [];
        
        const mode = document.getElementById('mode-selector').value; 
        let namePrefix = "Player";
        if (mode === 'double') namePrefix = "Pair";
        if (mode === 'team') namePrefix = "Team";

        const playersPerGroup = 4;
        const numGroups = Math.max(1, Math.ceil(TOTAL_PLAYERS / playersPerGroup));
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        for (let g = 0; g < numGroups; g++) {
            const gName = alphabet[g]; 
            groupsData[gName] = [];
            
            for (let i = 1; i <= playersPerGroup; i++) {
                const globalId = (g * playersPerGroup) + i;
                if (globalId > TOTAL_PLAYERS) break; 
                groupsData[gName].push({ id: globalId, name: `${namePrefix} ${globalId}`, wins: 0, legsDiff: 0 });
            }

            const p = groupsData[gName];
            if (p.length >= 2) {
                const add = (p1, p2) => {
                    groupMatches.push({
                        id: `G-${gName}-${p1.id}-${p2.id}`,
                        group: gName, p1: p1.id, p2: p2.id,
                        winner: null, score: null, time: '' 
                    });
                };
                
                if (p.length === 4) {
                    add(p[0], p[1]); add(p[2], p[3]); 
                    add(p[0], p[2]); add(p[1], p[3]); 
                    add(p[0], p[3]); add(p[1], p[2]); 
                } else if (p.length === 2) {
                    add(p[0], p[1]);
                } else {
                     for (let i = 0; i < p.length; i++) {
                        for (let j = i + 1; j < p.length; j++) {
                            add(p[i], p[j]);
                        }
                     }
                }
            }
        }
    }

    function updateDoubleName(inputEl, group, pid, partIndex) {
        const container = inputEl.parentElement;
        const inputs = container.querySelectorAll('input');
        const val1 = inputs[0].value.trim();
        const val2 = inputs[1].value.trim();
        let combinedName = val1;
        if (val2) combinedName += ` / ${val2}`;
        else if (partIndex === 0 && !val1 && !val2) combinedName = "";
        if (partIndex === 0 && !val2 && val1) combinedName = val1; 
        if (val1 && val2) combinedName = `${val1} / ${val2}`;
        const player = groupsData[group].find(p => p.id === pid);
        if(player) player.name = combinedName;
    }

    function renderGroupView() {
        const container = document.getElementById('group-stage-container');
        container.innerHTML = '';
        const groupKeys = Object.keys(groupsData).sort();
        
        const mode = document.getElementById('mode-selector').value;
        let colTitle = "ÈÅ∏Êâã (ÂèØÁ∑®ËºØ)";
        let placeholderText = "ÂßìÂêç";
        if (mode === 'double') { colTitle = "Êê≠Êìã (Pair)"; }
        if (mode === 'team') { colTitle = "Èöä‰ºç (Team)"; placeholderText = "Ë´ãËº∏ÂÖ•ÈöäÂêç"; }

        groupKeys.forEach(gKey => {
            const gDiv = document.createElement('div');
            gDiv.className = 'group-box';
            
            let sortedPlayers = [...groupsData[gKey]].sort((a,b) => {
                if(b.wins !== a.wins) return b.wins - a.wins;
                return b.legsDiff - a.legsDiff;
            });

            let tableHtml = `<div class="group-header-text">Group ${gKey}</div>
            <table class="standings-table">
                <tr><th style="width:60%">${colTitle}</th><th>Âãù</th><th>Diff</th></tr>`;
            
            sortedPlayers.forEach((p, idx) => {
                let rankClass = idx < 2 ? `rank-${idx+1}` : '';
                let inputHtml = '';
                if (mode === 'double') {
                    let parts = p.name.split('/');
                    let v1 = parts[0] ? parts[0].trim() : '';
                    let v2 = parts[1] ? parts[1].trim() : '';
                    if (p.name.startsWith("Pair")) { v1 = p.name; v2 = ""; }
                    inputHtml = `<div class="double-input-group">
                        <input class="name-input half" value="${v1}" placeholder="ÈÅ∏ÊâãA" oninput="updateDoubleName(this, '${gKey}', ${p.id}, 0)">
                        <span class="separator">/</span>
                        <input class="name-input half" value="${v2}" placeholder="ÈÅ∏ÊâãB" oninput="updateDoubleName(this, '${gKey}', ${p.id}, 1)">
                    </div>`;
                } else {
                    inputHtml = `<input class="name-input" value="${p.name}" placeholder="${placeholderText}" oninput="updatePlayerName('${gKey}', ${p.id}, this.value)">`;
                }
                tableHtml += `<tr class="${rankClass}">
                    <td>${inputHtml}</td>
                    <td>${p.wins}</td>
                    <td>${p.legsDiff>0?'+'+p.legsDiff:p.legsDiff}</td>
                </tr>`;
            });
            tableHtml += `</table>`;
            gDiv.innerHTML = tableHtml;
            container.appendChild(gDiv);
        });
    }

    function renderGroupSchedule() {
        const container = document.getElementById('group-schedule-container');
        container.innerHTML = '';
        
        let html = `<table class="schedule-table">
            <thead><tr><th>Â†¥Ê¨°</th><th>ÊôÇÈñì</th><th>ÁµÑÂà•</th><th>Â∞çÊà∞ÁµÑÂêà</th><th>ÊØîÂàÜ</th><th>Êìç‰Ωú</th></tr></thead>
            <tbody>`;
            
        groupMatches.forEach((m, idx) => {
            const p1Data = groupsData[m.group].find(x=>x.id===m.p1);
            const p2Data = groupsData[m.group].find(x=>x.id===m.p2);
            
            const scoreDisplay = m.winner ? `<span class="score-tag done">${m.score}</span>` : `<span class="score-tag">-</span>`;
            const statusClass = m.winner ? 'play-btn disabled' : 'play-btn';
            
            html += `<tr>
                <td>#${idx+1}</td>
                <td><input class="time-input" value="${m.time||''}" placeholder="00:00" onchange="updateMatchTime('G', '${m.id}', this.value)"></td>
                <td>Group ${m.group}</td>
                <td>${p1Data.name} <span style="color:#999;font-size:0.8em">vs</span> ${p2Data.name}</td>
                <td>${scoreDisplay}</td>
                <td><div class="${statusClass}" onclick="loadGroupMatch('${m.id}')">ËºâÂÖ•</div></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function renderKnockoutSchedule() {
        const container = document.getElementById('knockout-schedule-container');
        container.innerHTML = '';
        
        let html = `<table class="schedule-table">
            <thead><tr><th>Â†¥Ê¨°</th><th>ÊôÇÈñì</th><th>Ë≥Ω‰∫ãÈöéÊÆµ</th><th>Â∞çÊà∞ÁµÑÂêà</th><th>ÊØîÂàÜ</th><th>Êìç‰Ωú</th></tr></thead>
            <tbody>`;
            
        let matches = Object.values(matchesData).sort((a,b) => a.id - b.id);
        
        matches.forEach(m => {
            const p1Val = getMatchInput(m.id, 1) || "ÂæÖÂÆö";
            const p2Val = getMatchInput(m.id, 2) || "ÂæÖÂÆö";
            
            html += `<tr>
                <td>M${m.id + 1}</td>
                <td><input class="time-input" value="${m.time||''}" placeholder="00:00" onchange="updateMatchTime('K', ${m.id}, this.value)"></td>
                <td>Round ${m.round+1}</td>
                <td>${p1Val} vs ${p2Val}</td>
                <td>-</td>
                <td><div class="play-btn" onclick="selectMatch(${m.id})">ËºâÂÖ•</div></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function updateMatchTime(type, id, val) {
        if (type === 'G') {
            const m = groupMatches.find(x => x.id === id);
            if(m) m.time = val;
        } else {
            if(matchesData[id]) matchesData[id].time = val;
        }
    }

    function updatePlayerName(group, pid, newName) {
        const player = groupsData[group].find(p => p.id === pid);
        if(player) player.name = newName;
    }

    function loadGroupMatch(mId) {
        const match = groupMatches.find(m => m.id === mId);
        if(match.winner) { alert("ÈÄôÂ†¥ÊØîË≥ΩÂ∑≤Á∂ìÁµêÊùü"); return; }
        const p1Data = groupsData[match.group].find(x=>x.id===match.p1);
        const p2Data = groupsData[match.group].find(x=>x.id===match.p2);
        if(confirm(`ËºâÂÖ• Group ${match.group} Â∞çÊà∞Ôºü\n${p1Data.name} vs ${p2Data.name}`)) {
            currentMatchId = mId; targetLegs = 2; 
            document.getElementById('p1-name').innerText = p1Data.name;
            document.getElementById('p2-name').innerText = p2Data.name;
            resetGame(); closeBracket();
        }
    }

    function generateKnockoutFromGroups() {
        const hasGames = Object.values(groupsData).some(grp => grp.some(p => p.wins > 0 || p.legsDiff !== 0));
        let confirmMsg = "Á¢∫ÂÆöË¶ÅÁî¢ÁîüÊ±∫Ë≥ΩË≥ΩÁ®ãË°®ÂóéÔºü";
        if (!hasGames) confirmMsg += "\n(ÁõÆÂâçÁÑ°Â∞èÁµÑË≥ΩÊàêÁ∏æÔºåÂ∞áÁî¢ÁîüÁ©∫ÁôΩË≥ΩÁ®ãË°®)";
        else confirmMsg += "\n(Â∞á‰æùÁÖßÁõÆÂâçÂ∞èÁµÑÊàêÁ∏æÔºåËá™ÂãïÂ°´ÂÖ•ÊôâÁ¥öÂêçÂñÆ)";

        if(!confirm(confirmMsg)) return;

        const groupKeys = Object.keys(groupsData).sort(); 
        const numGroups = groupKeys.length;
        
        let finalSize = numGroups * 2;
        if (numGroups === 1) finalSize = 2;

        TOTAL_PLAYERS = finalSize; 
        
        switchStageView('final');
        renderKnockoutBracket(); 

        if (hasGames) {
            setTimeout(() => {
                if (numGroups === 1) {
                     const g1 = groupKeys[0];
                     const top = [...groupsData[g1]].sort((a,b) => (b.wins-a.wins) || (b.legsDiff-a.legsDiff)).slice(0, 2);
                     if (top.length >= 2) {
                        setMatchInput(0, 1, top[0].name);
                        setMatchInput(0, 2, top[1].name);
                     }
                } else {
                    for (let i = 0; i < numGroups; i += 2) {
                        if (i + 1 >= numGroups) break; 
                        const g1 = groupKeys[i];
                        const g2 = groupKeys[i+1];
                        const getTop2 = (g) => [...groupsData[g]].sort((a,b) => (b.wins-a.wins) || (b.legsDiff-a.legsDiff)).slice(0, 2);
                        const top1 = getTop2(g1);
                        const top2 = getTop2(g2);
                        if (top1.length < 2 || top2.length < 2) continue;

                        const matchIndexBase = i; 
                        setMatchInput(matchIndexBase, 1, top1[0].name);
                        setMatchInput(matchIndexBase, 2, top2[1].name);
                        setMatchInput(matchIndexBase+1, 1, top2[0].name);
                        setMatchInput(matchIndexBase+1, 2, top1[1].name);
                    }
                }
                drawConnectors();
            }, 150);
        } else {
            setTimeout(drawConnectors, 150);
        }
    }

    function renderKnockoutBracket() {
        const container = document.getElementById('bracket-container');
        container.innerHTML = '';
        
        const scrollView = document.getElementById('bracket-scroll-view');
        scrollView.scrollLeft = 0;
        scrollView.scrollTop = 0;

        const mode = document.getElementById('mode-selector').value; 
        let defaultName = "Player";
        if (mode === 'double') defaultName = "Pair";
        if (mode === 'team') defaultName = "Team";

        const totalRounds = Math.log2(TOTAL_PLAYERS);
        let matchCounter = 0;
        let matchesInRound = TOTAL_PLAYERS / 2;

        for (let r = 0; r < totalRounds; r++) {
            const roundDiv = document.createElement('div');
            roundDiv.className = 'round-column';
            const header = document.createElement('div');
            header.className = 'round-header';
            
            let titleText = (r === totalRounds - 1) ? "Final (ÂÜ†ËªçË≥Ω)" : (matchesInRound === 2 ? "Semi-Final (Ê∫ñÊ±∫Ë≥Ω)" : `Round ${r+1}`);
            let defaultBo = (r === totalRounds - 1) ? 7 : (r > 0 ? 5 : 3);

            header.innerHTML = `<div class="round-title">${titleText}</div>
                <select id="fmt-r${r}" class="control-select" style="padding:0; font-size:0.8rem;">
                    <option value="3" ${defaultBo===3?'selected':''}>Bo3</option>
                    <option value="5" ${defaultBo===5?'selected':''}>Bo5</option>
                    <option value="7" ${defaultBo===7?'selected':''}>Bo7</option>
                </select>`;
            roundDiv.appendChild(header);

            for (let i = 0; i < matchesInRound; i++) {
                const mid = matchCounter++;
                matchesData[mid] = { id: mid, round: r, nextMatchId: null, time: '' };
                const card = document.createElement('div');
                card.className = `match-card`;
                card.id = `match-card-${mid}`;
                card.onclick = () => selectMatch(mid);
                
                // ‚òÖ ‰øÆÊîπËôïÔºöÂº∑Âà∂Èõô‰∫∫Ë≥ΩÊ©´ÂêëÊéíÂàó (flex-direction: row)
                const genInput = (tn) => {
                    if (mode === 'double') {
                         return `<div class="team-block" style="padding:2px; display:flex; flex-direction:row; align-items:center;">
                             <input id="m${mid}-t${tn}-p0" class="bracket-input" placeholder="ÈÅ∏ÊâãA" onclick="event.stopPropagation()" style="width: 40%; min-width:0; padding:2px; font-size:14px; text-align:center;">
                             <span style="flex:0 0 auto; margin:0 4px; font-weight:bold; color:#999;">/</span>
                             <input id="m${mid}-t${tn}-p1" class="bracket-input" placeholder="ÈÅ∏ÊâãB" onclick="event.stopPropagation()" style="width: 40%; min-width:0; padding:2px; font-size:14px; text-align:center;">
                         </div>`;
                    }
                    return `<div class="team-block"><input id="m${mid}-t${tn}-p0" class="bracket-input" placeholder="${r===0? defaultName :'Winner'}" onclick="event.stopPropagation()"></div>`;
                };
                
                card.innerHTML = `<div class="match-label">Match ${mid+1}</div>${genInput(1)}<div class="vs-text">VS</div>${genInput(2)}`;
                roundDiv.appendChild(card);
            }
            container.appendChild(roundDiv);
            matchesInRound /= 2;
        }

        let currentStartId = 0;
        let currentCount = TOTAL_PLAYERS / 2;
        for (let r = 0; r < totalRounds - 1; r++) {
            const nextRoundStartId = currentStartId + currentCount;
            for (let i = 0; i < currentCount; i++) {
                const currentId = currentStartId + i;
                const targetId = nextRoundStartId + Math.floor(i / 2);
                matchesData[currentId].nextMatchId = targetId;
            }
            currentStartId += currentCount;
            currentCount /= 2;
        }
        requestAnimationFrame(() => {
            setTimeout(drawConnectors, 50);
        });
    }

    // ‚òÖ Â∞èÂπ´ÊâãÂáΩÂºèÔºöË®≠ÂÆöÊØîË≥ΩÂêçÂ≠ó (ÊîØÊè¥ÈõôÊ¨Ñ‰Ωç)
    function setMatchInput(mid, teamNum, name) {
        const targetP0 = document.getElementById(`m${mid}-t${teamNum}-p0`);
        const targetP1 = document.getElementById(`m${mid}-t${teamNum}-p1`);
        if (targetP1) {
            let parts = name.split(' / ');
            if(parts.length < 2) parts = name.split(' & '); 
            targetP0.value = parts[0] || name;
            targetP1.value = parts[1] || "";
        } else {
            if(targetP0) targetP0.value = name;
        }
    }

    // ‚òÖ Â∞èÂπ´ÊâãÂáΩÂºèÔºöËÆÄÂèñÊØîË≥ΩÂêçÂ≠ó (ÊîØÊè¥ÈõôÊ¨Ñ‰ΩçÂêà‰Ωµ)
    function getMatchInput(mid, teamNum) {
        const targetP0 = document.getElementById(`m${mid}-t${teamNum}-p0`);
        const targetP1 = document.getElementById(`m${mid}-t${teamNum}-p1`);
        if (!targetP0) return "";
        
        let val = targetP0.value;
        if (targetP1 && targetP1.value) {
            val += ` / ${targetP1.value}`;
        }
        return val;
    }

    function switchStageView(stage) {
        currentStage = stage;
        const isGroupMode = document.getElementById('format-selector').value === 'group';
        
        document.getElementById('group-tabs').style.display = isGroupMode ? 'flex' : 'none';
        document.getElementById('knockout-tabs').style.display = isGroupMode ? 'none' : 'flex';

        if(stage === 'group') {
            document.getElementById('advance-btn-container').style.display = (TOTAL_PLAYERS > 4) ? 'block' : 'none';
            document.getElementById('back-to-group-container').style.display = 'none';
            setSubView('rankings'); 
        } else {
            document.getElementById('advance-btn-container').style.display = 'none';
            document.getElementById('back-to-group-container').style.display = isGroupMode ? 'block' : 'none';
            setSubView('bracket'); 
        }
    }

    function drawConnectors() {
        if (currentSubView !== 'bracket') return;

        const svg = document.getElementById('bracket-lines');
        const scrollView = document.getElementById('bracket-scroll-view');
        if(!scrollView || scrollView.offsetParent === null) return; 
        
        svg.style.width = scrollView.scrollWidth + "px";
        svg.style.height = scrollView.scrollHeight + "px";
        svg.innerHTML = ''; 
        
        const rootRect = scrollView.getBoundingClientRect();

        for (let key in matchesData) {
            const match = matchesData[key];
            if (match.nextMatchId !== null) {
                const currEl = document.getElementById(`match-card-${match.id}`);
                const nextEl = document.getElementById(`match-card-${match.nextMatchId}`);
                
                if (currEl && nextEl) {
                    const cRect = currEl.getBoundingClientRect();
                    const nRect = nextEl.getBoundingClientRect();
                    
                    if (cRect.width === 0 || nRect.width === 0) continue;

                    const startX = Math.round((cRect.left - rootRect.left) + cRect.width);
                    const startY = Math.round((cRect.top - rootRect.top) + cRect.height / 2);
                    const endX = Math.round(nRect.left - rootRect.left);
                    const endY = Math.round((nRect.top - rootRect.top) + nRect.height / 2);
                    const midX = Math.round(startX + (endX - startX) / 2);
                    
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", `M ${startX} ${startY} H ${midX} V ${endY} H ${endX}`);
                    path.setAttribute("class", "connector-path");
                    svg.appendChild(path);
                }
            }
        }
    }
    
    window.addEventListener('resize', () => { setTimeout(drawConnectors, 100); });

    function selectMatch(mid) {
        const n1 = getMatchInput(mid, 1) || "P1";
        const n2 = getMatchInput(mid, 2) || "P2";
        const fmtSelect = document.getElementById(`fmt-r${matchesData[mid].round}`);
        const legsNeeded = Math.ceil(parseInt(fmtSelect.value) / 2);

        if(confirm(`ËºâÂÖ• Match ${mid+1}?\n${n1} VS ${n2}\nÊê∂ ${legsNeeded} Âãù\nÊ®°Âºè: ${GAME_MODE}`)) {
            currentMatchId = mid; targetLegs = legsNeeded;
            document.getElementById('p1-name').innerText = n1;
            document.getElementById('p2-name').innerText = n2;
            resetGame(); closeBracket();
        }
    }

    function advanceWinner(winnerIdx) {
        if(currentMatchId === null) return;
        const wScore = players[winnerIdx].legs;
        const lScore = players[(winnerIdx===1?2:1)].legs;

        if (typeof currentMatchId === 'string' && currentMatchId.startsWith('G-')) {
            const match = groupMatches.find(m => m.id === currentMatchId);
            const wId = (winnerIdx === 1) ? match.p1 : match.p2;
            const lId = (winnerIdx === 1) ? match.p2 : match.p1;
            
            match.winner = wId; match.score = `${wScore}-${lScore}`;
            
            const findP = (g, id) => groupsData[g].find(x=>x.id===id);
            let wData = findP(match.group, wId);
            let lData = findP(match.group, lId);
            wData.wins += 1;
            wData.legsDiff += (wScore - lScore);
            lData.legsDiff += (lScore - wScore);

            alert(`Â∞èÁµÑË≥ΩÊõ¥Êñ∞Ôºö${wData.name} ÂãùÂá∫ÔºÅ`);
            renderGroupView(); 
            renderGroupSchedule(); 
        } 
        else {
            const match = matchesData[currentMatchId];
            const wName = document.getElementById(`p${winnerIdx}-name`).innerText;
            if (match.nextMatchId !== null) {
                const teamNum = (match.id % 2 === 0) ? 1 : 2;
                setMatchInput(match.nextMatchId, teamNum, wName);
                alert(`ÊÅ≠Âñú ${wName} ÊôâÁ¥öÔºÅ`);
                setTimeout(drawConnectors, 200);
            } else { 
                alert(`ÊÅ≠Âñú ${wName} Áç≤ÂæóÁ∏ΩÂÜ†ËªçÔºÅ`); 
            }
            renderKnockoutSchedule(); 
        }
        openBracket(); 
    }

    function getCheckoutText(score) {
        if (score > 170 || score < 2) return "";
        if (score <= 40 && score % 2 === 0) return `D${score/2}`;
        const checkouts = {
            170: "T20 T20 Bull", 167: "T20 T19 Bull", 164: "T20 T18 Bull",
            161: "T20 T17 Bull", 160: "T20 T20 D20", 158: "T20 T20 D19",
            156: "T20 T20 D18", 153: "T20 T19 D18", 150: "T20 T18 D18",
            140: "T20 T20 D10", 132: "T20 T20 D6", 121: "T20 T11 D14",
            100: "T20 D20", 90: "T20 D15", 82: "Bull D16", 60: "20 D20",
            50: "10 D20", 40: "D20", 32: "D16", 24: "D12", 36: "D18"
        };
        if(checkouts[score]) return checkouts[score];
        if(score <= 50 && score % 2 !== 0) return `${1} D${(score-1)/2}`; 
        return ""; 
    }

    function handleMiss() {
        if (isBoardLocked) return;
        const p = players[currentPlayer];
        turnDarts++;
        p.matchTotalDarts++; 
        let h = { id: 'Miss', score: 0, player: currentPlayer, turnIndex: turnDarts };
        p.roundHistory.push(h); throwHistory.push(h);
        updateUI();
        if (turnDarts >= 3) lockBoard();
    }

    function handleHit(e) {
        if (isBoardLocked) return;
        
        const scoreHit = parseInt(e.target.getAttribute("data-score"));
        const hitId = e.target.getAttribute("data-id") || scoreHit;
        
        let targetAngle = parseFloat(e.target.getAttribute("data-angle"));
        let targetRadius = parseFloat(e.target.getAttribute("data-radius"));
        let hitCount = (turnHitCounts[hitId] || 0) + 1;
        turnHitCounts[hitId] = hitCount;

        let finalRadius = targetRadius;
        if (hitId === 'B25') {
            finalRadius = 19; 
            if (hitCount === 1) targetAngle = -90;      
            else if (hitCount === 2) targetAngle = 0;   
            else if (hitCount === 3) targetAngle = 90;  
        } else if (hitId === 'B50') {
            if (hitCount === 2) finalRadius -= 5;
            if (hitCount === 3) finalRadius += 5;
        } else {
            const radialOffset = 8; 
            if (hitCount === 2) finalRadius = targetRadius - radialOffset;
            if (hitCount === 3) finalRadius = targetRadius + radialOffset;
        }

        const radian = targetAngle * Math.PI / 180;
        const finalX = finalRadius * Math.cos(radian);
        const finalY = finalRadius * Math.sin(radian);
        addDartMarker(finalX, finalY, turnDarts + 1, 4);

        const p = players[currentPlayer];
        const remaining = p.score - scoreHit;
        const isDouble = (typeof hitId === 'string' && hitId.startsWith('D')) || hitId === 'B50';

        // ÁàÜÈè¢Âà§Êñ∑
        if (remaining < 0 || remaining === 1 || (remaining === 0 && !isDouble)) {
            p.roundHistory.forEach(dart => { if(dart.score > 0) p.score += dart.score; }); 
            p.roundHistory.forEach(dart => { if(dart.score > 0) p.matchTotalScore -= dart.score; });
            
            turnDarts++;
            p.matchTotalDarts++;
            let h = { id: hitId, score: 0, player: currentPlayer, turnIndex: turnDarts, isBust: true };
            p.roundHistory.push(h); throwHistory.push(h);
            updateUI();
            setTimeout(() => { alert("ÁàÜÈè¢ (BUST)ÔºÅ\nÈúÄÈõôÂÄçÂçÄÁµêÊ®ô"); lockBoard(); }, 50);
            return; 
        }

        p.score -= scoreHit; turnDarts++;
        p.matchTotalScore += scoreHit; 
        p.matchTotalDarts++;
        let h = { id: hitId, score: scoreHit, player: currentPlayer, turnIndex: turnDarts };
        p.roundHistory.push(h); throwHistory.push(h);
        updateUI();

        if (p.score === 0) { 
            setTimeout(() => { 
                if(confirm(`Game Shot! \nÁ¢∫Ë™ç ${players[currentPlayer].name} ÁµêÊ®ôÁç≤ÂãùÔºü`)) {
                    handleLegWin(currentPlayer); 
                } else {
                    undoLastDart(); // ÊåâÂèñÊ∂àÔºåËá™ÂãïÂæ©Âéü‰∏ä‰∏ÄÈè¢
                }
            }, 100); 
            return; 
        }

        if (turnDarts >= 3) lockBoard();
    }
    
    function addDartMarker(x, y, dartNum, r) {
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        marker.setAttribute("cx", x); marker.setAttribute("cy", y); marker.setAttribute("r", r);
        marker.setAttribute("class", `dart-marker dart-marker-${dartNum}`);
        svg.appendChild(marker); markers.push(marker);
    }
    
    function clearMarkers() { markers.forEach(m => m.remove()); markers = []; turnHitCounts = {}; }

    function handleLegWin(winner) {
        players[winner].legs++;
        if(players[winner].legs >= targetLegs) { advanceWinner(winner); } 
        else {
            alert(`${players[winner].legs} - ${players[(winner===1?2:1)].legs}\n‰∏ã‰∏ÄÂ±ÄÈñãÂßã`);
            legStarter = (winner===1)?2:1; currentPlayer = legStarter;
            resetGameValues(); // Reset values for new leg
            clearMarkers(); updateUI(); updateActiveCard();
        }
    }

    function resetGame() {
        players[1].legs = 0; players[2].legs = 0;
        players[1].matchTotalScore = 0; players[1].matchTotalDarts = 0;
        players[2].matchTotalScore = 0; players[2].matchTotalDarts = 0;
        resetGameValues();
        currentPlayer = 1; legStarter = 1;
        clearMarkers(); updateUI(); updateActiveCard();
    }

    function resetGameValues() {
        players[1].score = GAME_MODE; players[2].score = GAME_MODE;
        players[1].roundHistory = []; players[2].roundHistory = [];
        throwHistory = []; turnDarts = 0; isBoardLocked = false;
    }

    function switchPlayer() { 
        isBoardLocked = false; turnDarts = 0; players[currentPlayer].roundHistory = []; 
        currentPlayer = (currentPlayer===1)?2:1; clearMarkers(); updateUI(); updateActiveCard(); 
    }
    
    function undoLastDart() { 
        if(throwHistory.length===0) return; 
        const last=throwHistory.pop(); 
        if(last.player!==currentPlayer){alert("ÁÑ°Ê≥ïÂæ©Âéü");return;} 
        
        const p = players[currentPlayer];

        if (!last.isBust) {
            p.score += last.score;
            p.matchTotalScore -= last.score; 
        } else {
             p.roundHistory.forEach(d => { if(d.score > 0) p.matchTotalScore += d.score; });
        }

        p.roundHistory.pop(); 
        p.matchTotalDarts--; 
        turnDarts--; isBoardLocked=false; 
        if (last.id !== 'Miss') {
            if(turnHitCounts[last.id] > 0) turnHitCounts[last.id]--;
            const lastMarker = markers.pop(); if(lastMarker) lastMarker.remove();
        }
        updateUI(); 
    }
    
    function updateUI() { 
        document.getElementById('p1-score').innerText = players[1].score; 
        document.getElementById('p2-score').innerText = players[2].score; 
        document.getElementById('p1-legs').innerText = players[1].legs; 
        document.getElementById('p2-legs').innerText = players[2].legs; 
        
        const updateStats = (pid) => {
            const p = players[pid];
            let avg = (p.matchTotalDarts > 0) ? (p.matchTotalScore / p.matchTotalDarts) * 3 : 0;
            document.getElementById(`p${pid}-avg`).innerText = avg.toFixed(2);
            document.getElementById(`p${pid}-hint`).innerText = getCheckoutText(p.score);
        };
        
        updateStats(1);
        updateStats(2);

        updateSlots(1); updateSlots(2);
        const overlay = document.getElementById('board-overlay');
        const btnNext = document.getElementById('btn-next');
        if(isBoardLocked) { overlay.style.display = 'flex'; btnNext.classList.add('ready'); } else { overlay.style.display = 'none'; btnNext.classList.remove('ready'); } 
    }

    function updateSlots(pid) {
        const hist = players[pid].roundHistory;
        const slots = document.getElementById(`p${pid}-slots`).getElementsByClassName('dart-slot');
        for(let s of slots) { s.innerText = '-'; s.classList.remove('filled', 'miss'); }
        hist.forEach((h, i) => { 
            if (slots[i]) { 
                slots[i].innerText = h.id; slots[i].classList.add('filled'); 
                if(h.id === 'Miss') slots[i].classList.add('miss'); 
            } 
        });
    }
    
    function updateActiveCard() { document.getElementById('p1-card').classList.remove('active', 'active-p1'); document.getElementById('p2-card').classList.remove('active', 'active-p2'); document.getElementById(`p${currentPlayer}-card`).classList.add('active', `active-p${currentPlayer}`); }
    function lockBoard() { isBoardLocked = true; updateUI(); }

    const svg = document.getElementById('dartboard');
    const SECTORS = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
    function createBoard() {
        const sectorAngle = 360 / 20;
        SECTORS.forEach((score, i) => {
            const start = (i * sectorAngle) - 90 - (sectorAngle/2);
            const end = start + sectorAngle;
            const isEven = i % 2 === 0;
            drawSector(start, end, 160, 195, isEven?'area-red':'area-green', `D${score}`, score*2);
            drawSector(start, end, 110, 160, isEven?'area-black':'area-white', `S${score}`, score);
            drawSector(start, end, 80, 110, isEven?'area-red':'area-green', `T${score}`, score*3);
            drawSector(start, end, 25, 80, isEven?'area-black':'area-white', `S${score}`, score);
            drawLabel(start + sectorAngle/2, 215, score);
        });
        drawCircle(25, 'area-green', 'B25', 25); drawCircle(12, 'area-red', 'B50', 50);
        updateUI(); updateActiveCard();
    }
    function drawSector(s, e, ir, or, cls, id, val) {
        const r1=s*Math.PI/180, r2=e*Math.PI/180;
        const x1=ir*Math.cos(r1), y1=ir*Math.sin(r1), x2=or*Math.cos(r1), y2=or*Math.sin(r1);
        const x3=or*Math.cos(r2), y3=or*Math.sin(r2), x4=ir*Math.cos(r2), y4=ir*Math.sin(r2);
        const d = `M${x1} ${y1}L${x2} ${y2}A${or} ${or} 0 0 1 ${x3} ${y3}L${x4} ${y4}A${ir} ${ir} 0 0 0 ${x1} ${y1}Z`;
        const p = document.createElementNS("http://www.w3.org/2000/svg","path");
        p.setAttribute("d",d); p.setAttribute("class",cls); p.setAttribute("data-id", id); p.setAttribute("data-score",val);
        const midAngle = (s + e) / 2; const midRadius = (ir + or) / 2;
        p.setAttribute("data-angle", midAngle); p.setAttribute("data-radius", midRadius);
        p.addEventListener('click', handleHit); svg.appendChild(p);
    }
    function drawCircle(r, cls, id, val) {
        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx",0); c.setAttribute("cy",0); c.setAttribute("r",r); c.setAttribute("class",cls); c.setAttribute("data-id", id); c.setAttribute("data-score",val);
        c.setAttribute("data-angle", 0); c.setAttribute("data-radius", 0);
        c.addEventListener('click', (e)=>{e.stopPropagation(); handleHit(e);}); svg.appendChild(c);
    }
    function drawLabel(angle, r, text) {
        const rad = angle * Math.PI / 180;
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", r*Math.cos(rad)); t.setAttribute("y", r*Math.sin(rad));
        t.setAttribute("class", "text-label"); t.textContent = text; svg.appendChild(t);
    }
</script>
</body>
</html>
