<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ç¡¬é¶è»Ÿé¶å°ˆæ¥­è¨˜åˆ†æ¿ V86ï¼ˆå®Œæˆç‰ˆï¼‰ï¼‰</title>
<style>
:root{
  --bg:#eef2f5; --panel:#fff; --left:#dfe4ea;
  --p1:#007bff; --p2:#dc3545;
  --line:#555; --linew:2px;
}
html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);overflow:hidden}
#main{display:flex;height:100%}
#left{flex:6;display:flex;align-items:center;justify-content:center;background:var(--left);position:relative;border-right:1px solid #ccc}
#right{flex:4;background:var(--panel);padding:15px;display:flex;flex-direction:column;overflow:auto;box-shadow:-5px 0 20px rgba(0,0,0,.05);z-index:10}
#bracketBtn{width:100%;padding:12px;margin-bottom:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;font-weight:800;cursor:pointer;font-size:1rem}
.player{background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;padding:10px;margin-bottom:12px;opacity:.7;transition:.2s;position:relative}
.player.active{opacity:1;background:#fff;border-width:3px;transform:scale(1.01)}
.player.active.p1{border-color:var(--p1)} .player.active.p2{border-color:var(--p2)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.turnTop{font-weight:900;color:#007bff;font-size:1.05rem;white-space:nowrap;}
.name{font-size:1.3rem;font-weight:900;white-space:pre-wrap;line-height:1.2;word-break:break-word}
.ind{font-size:1.5rem;visibility:hidden}
.player.active .ind{visibility:visible}
.slots{display:flex;gap:5px;margin-bottom:5px;height:30px}
.slot{flex:1;background:#fff;border:1px solid #ccc;border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#555}
.slot.filled{color:#000;border-color:#333;background:#e9ecef}
.slot.miss{color:#dc3545;background:#fff0f0;border-color:#dc3545}
.slot.editing{
  animation: blink 0.6s infinite;
  border-color:#007bff;
}

@keyframes blink{
  0%{opacity:1}
  50%{opacity:.2}
  100%{opacity:1}
}
.slot.editing{  background:#fff9c4;  border-color:#f1c40f;  animation: blink .7s infinite;}
.slotWrap{  position:relative;  flex:1;  display:flex;  align-items:center;}
.slotWrap .slot{  width:100%;}
.editBtn{
  position:absolute;
  right:3px;
  top:50%;
  transform:translateY(-50%);
  border:1px solid #bbb;
  background:#fff;
  color:#444;
  font-size:12px;
  font-weight:900;
  padding:2px 6px;
  border-radius:6px;
  cursor:pointer;
  opacity:.25;
}

.player.active .editBtn{
  opacity:.9;
}

.editBtn:active{
  transform:translateY(-50%) scale(.96);
}
.row{display:flex;justify-content:space-between;align-items:center;margin:5px 0}
.stats{width:40%;display:flex;flex-direction:column}
.lab{font-size:.8rem;color:#888;font-weight:900;text-transform:uppercase}
.val{font-size:1.5rem;font-weight:900;color:#555}
.hint{font-size:.9rem;color:#d63031;font-weight:900;margin-top:4px;min-height:1.2em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.big{width:60%;font-size:4.5rem;font-weight:900;text-align:right;line-height:1}
.round{font-size:1.1rem;font-weight:900;color:#666;text-align:right;margin-top:-5px}
#logo{flex-grow:1;min-height:100px;border:2px dashed #e0e0e0;border-radius:12px;margin:15px 0;display:flex;align-items:center;justify-content:center;color:#ccc;font-weight:900;letter-spacing:1px}
#controls{height:60px;display:grid;grid-template-columns:1fr 2.5fr;gap:12px;margin-top:auto}
button.ctrl{border:none;border-radius:10px;font-size:1.2rem;font-weight:900;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,.1)}
button.ctrl:active{transform:translateY(4px);box-shadow:none}
#undo{background:#fff;color:#495057;border:2px solid #ced4da}
#next{background:#007bff;color:#fff;opacity:.5;pointer-events:none}
#next.ready{opacity:1;pointer-events:all;animation:pulse 1.5s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

#missBtn,#softBtn{
  position:absolute;bottom:20px;z-index:50;width:80px;height:80px;border-radius:50%;
  font-size:1rem;font-weight:900;color:#fff;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;border:4px solid #fff;
  box-shadow:0 4px 10px rgba(0,0,0,.15)
}
#missBtn{left:20px;background:#dc3545;box-shadow:0 4px 10px rgba(220,53,69,.4)}
#softBtn{right:20px;background:#ff9f43;box-shadow:0 4px 10px rgba(255,159,67,.4)}
#missBtn:active,#softBtn:active{transform:scale(.95)}

#overlay{
  position:absolute;
  inset:0;
  display:none;
  pointer-events:none; /* ä¸æ“‹é»æ“Šï¼Œä¹Ÿä¸å½±éŸ¿çœ‹é¢é» */
  background: transparent; /* ä¸å†æ•´ç‰‡è®Šæš— */
  z-index: 100;
  align-items: flex-end;   /* æ–‡å­—æ”¾ä¸‹æ–¹ï¼Œé¿å…è“‹ä½é¢é» */
  justify-content: center;
  padding-bottom: 22px;
  text-align:center;
}
#overlay .t{
  display:inline-block;
  background: rgba(255,255,255,0.92);
  padding: 10px 18px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  color:#000;
  font-size: 2rem;
  font-weight: 900;
  line-height: 1.1;
}
#overlay .s{
  display:block;
  margin-top: 6px;
  font-size: 1.05rem;
  font-weight: 800;
  color:#555;
}
#overlay .t{font-size:2.5rem;font-weight:900;color:#000}

svg#dartboard{max-width:90%;max-height:90%;filter:drop-shadow(0 5px 15px rgba(0,0,0,.2))}
.area-black { fill: #111111; stroke: #6c757d; }
.area-white { fill: #f4f4f4; stroke: #6c757d; }
.area-red { fill: #b00020; stroke: #6c757d; }
.area-green { fill: #006b3f; stroke: #6c757d; }
.text-label{font-size:24px;font-weight:900;fill:#fff;pointer-events:none;text-anchor:middle;dominant-baseline:central;text-shadow:0 0 4px rgba(0,0,0,.9)}
.dart-marker{pointer-events:none;stroke:#fff;stroke-width:1px;filter:drop-shadow(0 1px 1px rgba(0,0,0,.3));transition:.15s}
.dart-marker-1{fill:#dc3545}.dart-marker-2{fill:#28a745}.dart-marker-3{fill:#007bff}

#bracketModal{position:fixed;inset:0;background:#f0f2f5;z-index:200;display:none;flex-direction:column}
#bHeader{background:#fff;border-bottom:1px solid #ccc;padding:15px 20px;display:flex;flex-direction:column;gap:10px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
.topbar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.hctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.lbl{font-weight:900;color:#555;font-size:.9rem}
.sel{padding:5px;font-size:.9rem;border:2px solid #007bff;border-radius:5px;color:#007bff;font-weight:900;background:#fff;cursor:pointer}
.tabs{display:flex;justify-content:center;gap:10px;margin-top:5px;width:100%}
.tab{padding:8px 20px;border:2px solid #ccc;background:#fff;color:#555;border-radius:20px;font-weight:900;cursor:pointer;transition:.2s}
.tab.active{background:#007bff;color:#fff;border-color:#007bff;box-shadow:0 2px 5px rgba(0,123,255,.3)}
#bContent{flex:1;overflow:auto;position:relative;background:#f8f9fa}
#scroll{position:relative;width:100%;height:100%;padding:20px;box-sizing:border-box}
#lines{position:absolute;inset:0;pointer-events:none;z-index:1}
.connector{fill:none;stroke:var(--line);stroke-width:var(--linew);shape-rendering:crispEdges}
.bracket{display:flex;gap:80px;position:relative;z-index:2;width:max-content;padding:20px}
.roundCol{display:flex;flex-direction:column;justify-content:space-around;padding-top:50px;position:relative;min-width:180px}
.roundHeader{position:absolute;top:0;width:100%;text-align:center;display:flex;flex-direction:column;gap:5px;align-items:center}
.roundTitle{font-weight:900;color:#555}
.match{background:#fff;border:1px solid #ccc;border-radius:6px;padding:8px;margin:20px 0;width:220px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.match:hover{border-color:#007bff;transform:translateY(-2px)}
.mlab{font-size:.75rem;color:#007bff;font-weight:900;margin-bottom:2px}
.team{display:flex;flex-direction:column;gap:2px;margin-bottom:6px;border:1px solid #eee;padding:4px;border-radius:4px;background:#fcfcfc}
.inp{width:100%;box-sizing:border-box;border:none;border-bottom:1px solid #eee;font-size:16px;padding:4px;text-align:left;background:transparent}
.vs{font-size:.65rem;color:#ccc;text-align:center;margin:1px 0;font-weight:900}

.groupGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;width:100%;max-width:1200px;margin:0 auto}
@media(min-width:768px){.groupGrid{grid-template-columns:1fr 1fr}}
.gbox{background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05);padding:15px;border-top:5px solid #007bff;box-sizing:border-box}
.gtitle{font-size:1.4rem;font-weight:900;color:#333;margin-bottom:10px}
.stand{width:100%;border-collapse:collapse;font-size:.9rem;margin-bottom:15px}
.stand th{background:#f8f9fa;padding:8px;text-align:center;color:#555;font-size:.8rem;border-bottom:2px solid #ddd}
.stand td{border-bottom:1px solid #eee;padding:8px;text-align:center;font-weight:900;vertical-align:middle}
.stand td:first-child{text-align:left}
.nameInput{width:98%;border:none;border-bottom:1px dashed #ccc;font-size:.95rem;font-weight:900;color:#333;text-align:left;padding:4px 2px;background:transparent}
.nameInput:focus{outline:none;border-bottom:2px solid #007bff;background:#fff}
.doubleRow{display:flex;align-items:center;justify-content:space-between;gap:6px}
.nameHalf{width:42%;text-align:center}
.sep{width:10%;text-align:center;color:#999;font-weight:900}
.rank1{color:#d63031;background:#fff5f5}.rank2{color:#0984e3;background:#f0f7ff}

.schWrap{width:100%;max-width:1000px;margin:0 auto;display:flex;flex-direction:column;gap:10px}
.table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.05)}
.table th{background:#343a40;color:#fff;padding:12px;text-align:left;font-size:.9rem}
.table td{padding:12px;border-bottom:1px solid #eee;color:#333;font-weight:900;vertical-align:middle}
.table tr:hover{background:#f8f9fa}
.time{border:1px solid #ccc;border-radius:4px;padding:4px;font-family:inherit;width:80px;text-align:center}
.tag{display:inline-block;padding:4px 8px;border-radius:4px;background:#e9ecef;color:#555;min-width:40px;text-align:center}
.tag.done{background:#28a745;color:#fff}
.play{padding:4px 12px;background:#007bff;color:#fff;border-radius:4px;font-size:.85rem;cursor:pointer;display:inline-block}
.play.disabled{background:#ccc;cursor:default}
.rulebar{display:none;width:100%;justify-content:center;gap:10px;align-items:center;flex-wrap:wrap}
.rulebar span.small{font-size:.9rem;font-weight:900;color:#888}
#advWrap,#backWrap{display:none;text-align:center;margin-top:10px}
</style>
</head>
<body>
<div id="bracketModal">
  <div id="bHeader">
    <div class="topbar">
      <div class="hctrl">
        <span class="lbl">é¶æ©Ÿï¼š</span>
        <select id="targetTypeSel" class="sel">
          <option value="hard">ç¡¬é¶ (Steel Tip)</option>
          <option value="soft">è»Ÿé¶ (Soft Tip)</option>
        </select>
        <span class="lbl">æ¨¡å¼ï¼š</span>
        <select id="modeSel" class="sel">
          <option value="single">å€‹äººè³½ (Singles)</option>
          <option value="double">é›™äººè³½ (Doubles)</option>
          <option value="team">åœ˜é«”è³½ (Team)</option>
        </select>

        <span class="lbl">è³½åˆ¶ï¼š</span>
        <select id="fmtSel" class="sel">
          <option value="knockout">å–®æ·˜æ±°è³½ (Knockout)</option>
          <option value="group">å°çµ„å¾ªç’°è³½ (Round Robin)</option>
        </select>

        <span class="lbl">ç¸½äººæ•¸ï¼š</span>
        <select id="sizeSel" class="sel"></select>
		<span class="lbl">æ¯çµ„ï¼š</span>
		<select id="perGroupSel" class="sel">
		  <option value="4" selected>4äºº</option>
		  <option value="3">3äºº</option>
		</select>
      </div>
      <button class="ctrl" style="padding:6px 16px;background:#eee;color:#333;border:1px solid #ccc" onclick="closeBracket()">é—œé–‰</button>
    </div>

    <div class="tabs" id="tabsGroup" style="display:none;">
      <div class="tab active" id="tabGroupRank" onclick="setSubView('rank')">ğŸ“Š ç©åˆ†æ¦œ</div>
      <div class="tab" id="tabGroupSch" onclick="setSubView('schedule')">ğŸ“… è³½ç¨‹è¡¨</div>
      <div class="tab" id="tabFinalBracket" style="display:none;" onclick="setSubView('bracket')">ğŸ† æ±ºè³½è³½ç¨‹è¡¨</div>
      <div class="tab" id="tabFinalSch" style="display:none;" onclick="setSubView('knockSchedule')">â±ï¸ æ±ºè³½æ™‚é–“è¡¨</div>
    </div>

    <div class="tabs" id="tabsKnock" style="display:none;">
      <div class="tab active" onclick="setSubView('bracket')">ğŸŒ³ æ¨¹ç‹€åœ–</div>
      <div class="tab" onclick="setSubView('schedule')">ğŸ“… è³½ç¨‹è¡¨</div>
    </div>

    <div id="groupRules" class="rulebar">
      <span class="lbl">å°çµ„è³½è¦å‰‡ï¼š</span>
      <select id="gBo" class="sel">
        <option value="3">Bo3</option><option value="5" selected>Bo5</option><option value="7">Bo7</option>
      </select>
      <select id="gScore" class="sel">
        <option value="301">301</option><option value="501" selected>501</option><option value="701">701</option>
      </select>
    </div>

    <div id="finalRules" class="rulebar">
      <span class="lbl">å°çµ„è³½è¦å‰‡ï¼š</span>
      <select id="fBo" class="sel">
        <option value="3" selected>Bo3</option><option value="5">Bo5</option><option value="7">Bo7</option>
      </select>
      <select id="fScore" class="sel">
        <option value="301">301</option><option value="501" selected>501</option><option value="701">701</option>
      </select>
    </div>

  </div>
  <div id="bContent">
    <div id="scroll">
      <svg id="lines"></svg>
      <div id="groupView" class="groupGrid" style="display:none;"></div>
      <div id="groupSchedule" class="schWrap" style="display:none;"></div>
      <div id="bracketView" class="bracket" style="display:none;"></div>
      <div id="knockSchedule" class="schWrap" style="display:none;"></div>
    </div>
  </div>
</div>

<div id="main">
  <div id="left">
    <svg id="dartboard" viewBox="-250 -250 500 500"></svg>
    <button id="missBtn" onclick="handleMiss()"><div>MISS</div><div style="font-size:.8rem">è„«é¶</div></button>
    <button id="softBtn" onclick="toggleSoft(true)"><div>SOFT</div><div style="font-size:.8rem">è»Ÿé¶</div></button>
    <div id="overlay"><div class="t">è«‹æ ¸å°åˆ†æ•¸</div><div style="font-size:1.2rem;color:#555;font-weight:900;margin-top:10px">ä¸¦æŒ‰ä¸‹æ›äººéµ</div></div>
  </div>
  <div id="right">
    <button id="bracketBtn" onclick="openBracket()">è³½ç¨‹è¡¨ / æˆ°ç¸¾è¼¸å…¥</button>

    <div class="player active p1" id="p1Card">
		<div class="header">
		  <div class="ind">ğŸ‘‰</div>
		  <div class="name" id="p1Name">Player 1</div>
		  <div class="turnTop">Turn: <span id="p1TurnTop">0</span></div>
		</div>
	<div class="slots" id="p1Slots">
	  <div class="slotWrap">
		<div class="slot">-</div>
		<button class="editBtn" onclick="editDart(1,0,event)">ä¿®æ­£</button>
	  </div>
	  <div class="slotWrap">
		<div class="slot">-</div>
		<button class="editBtn" onclick="editDart(1,1,event)">ä¿®æ­£</button>
	  </div>
	  <div class="slotWrap">
		<div class="slot">-</div>
		<button class="editBtn" onclick="editDart(1,2,event)">ä¿®æ­£</button>
	  </div>
	</div>
      <div class="row">
		<div class="stats">
		  <div class="lab">AVG</div>
		  <div class="val" id="p1Avg">0.00</div>
		  <div class="hint" id="p1Hint"></div>
		</div>
        <div class="big" id="p1Score">501</div>
      </div>
      <div class="round">Legs: <span id="p1Legs">0</span></div>
    </div>

    <div class="player" id="p2Card">
		<div class="header">
		  <div class="ind">ğŸ‘‰</div>
		  <div class="name" id="p2Name">Player 2</div>
		  <div class="turnTop">Turn: <span id="p2TurnTop">0</span></div>
		</div>
	<div class="slots" id="p2Slots">
	  <div class="slotWrap">
		<div class="slot">-</div>
		<button class="editBtn" onclick="editDart(2,0,event)">ä¿®æ­£</button>
	  </div>
	  <div class="slotWrap">
		<div class="slot">-</div>
		<button class="editBtn" onclick="editDart(2,1,event)">ä¿®æ­£</button>
	  </div>
	  <div class="slotWrap">
		<div class="slot">-</div>
		<button class="editBtn" onclick="editDart(2,2,event)">ä¿®æ­£</button>
	  </div>
	</div>
      <div class="row">
		<div class="stats">
		  <div class="lab">AVG</div>
		  <div class="val" id="p2Avg">0.00</div>
		  <div class="hint" id="p2Hint"></div>
		</div>
        <div class="big" id="p2Score">501</div>
      </div>
      <div class="round">Legs: <span id="p2Legs">0</span></div>
    </div>

    <div id="logo">LOGO / è³½äº‹åç¨±</div>

    <div id="controls">
      <button id="undo" class="ctrl" onclick="undoLast()">å¾©åŸ</button>
      <button id="next" class="ctrl" onclick="nextPlayer()">æ›ä¸‹ä¸€ä½ (NEXT)</button>
    </div>
  </div>
</div>

<!-- Soft tip panel (simple legs counter) -->
<div id="softPanel" style="position:fixed;inset:0;background:#2d3436;z-index:300;display:none;flex-direction:column;align-items:center;justify-content:center;color:#fff">
  <button class="ctrl" style="position:absolute;top:20px;right:20px;padding:10px 20px;background:transparent;border:2px solid #aaa;color:#aaa;border-radius:20px" onclick="toggleSoft(false)">å›ç¡¬é¶æ¨¡å¼</button>
  <div style="font-size:1.5rem;color:#aaa;margin-bottom:20px">è»Ÿé¶ / ç°¡æ˜“è¨ˆåˆ†æ¨¡å¼</div>
  <div id="softRule" style="color:#ff9f43;font-weight:900;margin-bottom:20px;font-size:1.2rem"></div>
  <div style="display:flex;align-items:center;gap:40px">
    <div style="display:flex;flex-direction:column;align-items:center;gap:20px">
      <div id="sP1Name" style="font-size:2rem;font-weight:900">Player 1</div>
      <div id="sP1Legs" style="font-size:6rem;font-weight:900;line-height:1">0</div>
      <button class="ctrl" style="width:80px;height:80px;border-radius:50%;font-size:2.5rem;background:#007bff;color:#fff" onclick="manualLeg(1)">+</button>
    </div>
    <div style="font-size:3rem;font-weight:900;color:#636e72;margin-top:-50px">:</div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:20px">
      <div id="sP2Name" style="font-size:2rem;font-weight:900">Player 2</div>
      <div id="sP2Legs" style="font-size:6rem;font-weight:900;line-height:1">0</div>
      <button class="ctrl" style="width:80px;height:80px;border-radius:50%;font-size:2.5rem;background:#dc3545;color:#fff" onclick="manualLeg(2)">+</button>
    </div>
  </div>
  <div style="margin-top:40px;color:#636e72">é»æ“Šã€Œ+ã€ç›´æ¥å¢åŠ å±€æ•¸ (Legs)</div>
</div>

<script>
/* ========= Error trap ========= */
window.onerror = function(message){ alert("ç¨‹å¼éŒ¯èª¤: " + message); };

/* ========= Dartboard rendering ========= */
const svg = document.getElementById('dartboard');
const SECTORS = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
const DEG = Math.PI/180;

function polar(r, angDeg){ const a=angDeg*DEG; return {x:r*Math.cos(a), y:r*Math.sin(a)}; }
function wedgePath(startDeg, endDeg, rIn, rOut){
  const p1=polar(rOut,startDeg), p2=polar(rOut,endDeg), p3=polar(rIn,endDeg), p4=polar(rIn,startDeg);
  const large = (endDeg-startDeg)>180 ? 1:0;
  return `M ${p1.x} ${p1.y} A ${rOut} ${rOut} 0 ${large} 1 ${p2.x} ${p2.y} L ${p3.x} ${p3.y} A ${rIn} ${rIn} 0 ${large} 0 ${p4.x} ${p4.y} Z`;
}

let markers=[];

function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
function addMarker(x,y,n,r){
  const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",r);
  c.setAttribute("class",`dart-marker dart-marker-${n}`);
  svg.appendChild(c); markers.push(c);
}
function getMissXY(n){
  const R = 225; // é¶å¤–åœˆè·é›¢ï¼ˆviewBox åŠå¾‘ 250ï¼Œ225 å¾ˆå®‰å…¨ï¼‰
  const angles = [240, 270, 300]; // å·¦ä¸‹/æ­£ä¸‹/å³ä¸‹
  const ang = angles[(n-1) % 3] * DEG;

  return {
    x: R * Math.cos(ang),
    y: R * Math.sin(ang)
  };
}
// âœ… å°±æ”¾åœ¨é€™è£¡ï¼ˆgetMissXY å¾Œé¢ï¼‰
function calcFixedDartPos(dartIndex, hitId, baseAngle, baseRadius){
// dartIndex: 1,2,3


if(hitId === "MISS"){
return getMissXY(dartIndex);
}


let r = baseRadius;
let ang = baseAngle;


const off = 8;
if(dartIndex === 2) r = baseRadius + off; // ä¸‹ç§»
if(dartIndex === 3) r = baseRadius - off; // ä¸Šç§»


if(hitId === "B25"){
r = 19;
if(dartIndex === 1) ang = -90;
if(dartIndex === 2) ang = 0;
if(dartIndex === 3) ang = 90;
}


if(hitId === "B50"){
if(dartIndex === 2) r = baseRadius - 5;
if(dartIndex === 3) r = baseRadius - 10;
}


const a = ang * DEG;
return { x: r * Math.cos(a), y: r * Math.sin(a) };
}

function createBoard(){
  while(svg.firstChild) svg.removeChild(svg.firstChild);

  const sectorAngle = 360/20;
  SECTORS.forEach((score,i)=>{
    const start = i*sectorAngle - 90 - sectorAngle/2;
    const end   = start + sectorAngle;

    // Single outer ring
    drawSector(start,end,110,160,i%2===0?'area-black':'area-white', String(score), score);
    // Triple ring
    drawSector(start,end,80,110,i%2===0?'area-red':'area-green', `T${score}`, score*3);
    // Single inner
    drawSector(start,end,25,80,i%2===0?'area-black':'area-white', String(score), score);
    // Double ring
    drawSector(start,end,160,195,i%2===0?'area-red':'area-green', `D${score}`, score*2);

    // Labels
    drawLabel(start + sectorAngle/2, 215, String(score));
  });

  // Bulls
  drawCircle(25,'B25',25,'area-green');
  drawCircle(12,'B50',50,'area-red');
}

function drawSector(start,end,rIn,rOut,cls,id,val){
  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d", wedgePath(start,end,rIn,rOut));
  p.setAttribute("class", cls);
  p.dataset.id=id; p.dataset.score=String(val);
  p.dataset.angle=String((start+end)/2);
  p.dataset.radius=String((rIn+rOut)/2);
  p.addEventListener('click', (e)=>window.handleHit(e));
  svg.appendChild(p);
}
function drawCircle(r,id,val,cls){
  const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx","0"); c.setAttribute("cy","0"); c.setAttribute("r",String(r));
  c.setAttribute("class",cls);
  c.dataset.id=id; c.dataset.score=String(val);
  c.dataset.angle="0"; c.dataset.radius=String(r/2);
  c.addEventListener('click',(e)=>{ e.stopPropagation(); window.handleHit(e);});
  svg.appendChild(c);
}
function drawLabel(ang,r,text){
  const t=document.createElementNS("http://www.w3.org/2000/svg","text");
  const p=polar(r,ang);
  t.setAttribute("x",p.x); t.setAttribute("y",p.y);
  t.setAttribute("class","text-label");
  t.textContent=text;
  svg.appendChild(t);
}

/* ========= Game state ========= */
const SCORE_OPTIONS=[301,501,701];

let GAME_MODE = 501;
let targetLegs = 3; // first to targetLegs legs
let currentPlayer = 1;
let legStarter = 1;
let turnDarts = 0;
let isBoardLocked = false;
let turnHitCounts = {};
let throwHistory = [];
let editTargetIdx = null;   // 0~2ï¼Œä»£è¡¨è¦ä¿®æ­£ç¬¬å¹¾é¢
let editTargetPid = null;   // 1 or 2ï¼Œä»£è¡¨è¦ä¿®æ­£èª°

let players = {
  1:{name:"Player 1", score:GAME_MODE, legs:0, turn:[], matchTotalScore:0, matchTotalDarts:0},
  2:{name:"Player 2", score:GAME_MODE, legs:0, turn:[], matchTotalScore:0, matchTotalDarts:0}
};

function syncNames(){
  players[1].name = document.getElementById('p1Name').innerText || "Player 1";
  players[2].name = document.getElementById('p2Name').innerText || "Player 2";
}

function resetLegValues(){
  players[1].score = GAME_MODE; players[2].score = GAME_MODE;
  players[1].turn = []; players[2].turn = [];
  turnDarts = 0; isBoardLocked = false; turnHitCounts = {};
  throwHistory = [];
  document.getElementById('overlay').style.display='none';
  setNextReady(false);
  updateUI();
  updateActiveCard();
}
function resetMatch(){
  syncNames();
  players[1].legs=0; players[2].legs=0;
  players[1].matchTotalScore=0; players[1].matchTotalDarts=0;
  players[2].matchTotalScore=0; players[2].matchTotalDarts=0;
  currentPlayer = 1; legStarter = 1;
  clearMarkers();
  resetLegValues();
}
function setNextReady(ready){
  const btn=document.getElementById('next');
  if(ready) btn.classList.add('ready'); else btn.classList.remove('ready');
}
function lockBoard(){
  isBoardLocked = true;
  document.getElementById('overlay').style.display='flex';
  setNextReady(true);
}
function showEditOverlay(idx){
  const ov = document.getElementById('overlay');
  if(!ov) return;

  ov.style.display = 'flex';
  ov.innerHTML = `
    <div class="t">ä¿®æ­£æ¨¡å¼</div>
    <div class="s">è«‹é»æ“Šæ­£ç¢ºé¶é¢åˆ†æ•¸ï¼ˆç¬¬ ${idx+1} é¢ï¼‰</div>
  `;
}
function hideEditOverlay(){
  const ov = document.getElementById('overlay');
  if(!ov) return;

  // âš ï¸ å¦‚æœç›®å‰é‚„æ˜¯é–é¶ç‹€æ…‹ï¼Œå°±ä¸è¦é—œæ‰æç¤ºï¼ˆè®“å®ƒç¶­æŒã€Œè«‹æŒ‰NEXTã€ï¼‰
  if(isBoardLocked){
    ov.innerHTML = `<div class="t">è«‹æ ¸å°åˆ†æ•¸</div><div style="font-size:1.2rem;color:#555;font-weight:900;margin-top:10px">ä¸¦æŒ‰ä¸‹æ›äººéµ</div>`;
    ov.style.display = 'flex';
  }else{
    ov.style.display = 'none';
  }
}
function updateActiveCard(){
  const p1=document.getElementById('p1Card'), p2=document.getElementById('p2Card');
  p1.classList.remove('active','p1'); p2.classList.remove('active','p2');
  if(currentPlayer===1){ p1.classList.add('active','p1'); } else { p2.classList.add('active','p2'); }
}
function updateSlots(){
  const p = players[currentPlayer];
  const slots = document.getElementById(currentPlayer===1?'p1Slots':'p2Slots').querySelectorAll('.slot');
  slots.forEach((s,i)=>{ s.className='slot'; s.textContent='-'; });
  p.turn.forEach((d,i)=>{
    if(i>=3) return;
    const s=slots[i];
    if(d.isMiss){ s.classList.add('miss'); s.textContent='MISS'; return; }
    if(d.isBust){ s.classList.add('miss'); s.textContent='BUST'; return; }
    s.classList.add('filled'); s.textContent = d.id;
  });
}
function getAvg(pid){
  const p=players[pid];
  if(p.matchTotalDarts===0) return 0;
  return (p.matchTotalScore / p.matchTotalDarts) * 3;
}

// âœ… åŠ åœ¨é€™è£¡ï¼ˆgetAvg çš„ä¸‹é¢ï¼ŒupdateUI çš„ä¸Šé¢ï¼‰
function getTurnTotal(pid){
  const p = players[pid];
  return (p.turn || []).reduce((sum,d)=>sum + (d.score||0),0);
}

function updateUI(){
  document.getElementById('p1Score').innerText = players[1].score;
  document.getElementById('p2Score').innerText = players[2].score;
  document.getElementById('p1Legs').innerText = players[1].legs;
  document.getElementById('p2Legs').innerText = players[2].legs;
  document.getElementById('p1Avg').innerText = getAvg(1).toFixed(2);
  document.getElementById('p2Avg').innerText = getAvg(2).toFixed(2);
	const p1TT = document.getElementById('p1TurnTop');
	if(p1TT) p1TT.innerText = getTurnTotal(1);
	const p2TT = document.getElementById('p2TurnTop');
	if(p2TT) p2TT.innerText = getTurnTotal(2);
  document.getElementById('p1Hint').innerText = getCheckoutText(players[1].score);
  document.getElementById('p2Hint').innerText = getCheckoutText(players[2].score);

  // Update both slot rows based on current turn owner
  // For simplicity, only show current player's darts on their row; other row shows '-'
  const resetRow=(id)=>{ document.getElementById(id).querySelectorAll('.slot').forEach(s=>{s.className='slot';s.textContent='-';}); };
  resetRow('p1Slots'); resetRow('p2Slots');
  updateSlots();
}

function getCheckoutText(score){
  if(score>170 || score<2) return "";
  const map = {
    170:"T20 T20 Bull",
    167:"T20 T19 Bull",
    164:"T20 T18 Bull",
    161:"T20 T17 Bull",
    160:"T20 T20 D20",
    158:"T20 T20 D19",
    157:"T20 T19 D20",
    156:"T20 T20 D18",
    155:"T20 T19 D19",
    154:"T20 T18 D20",
    153:"T20 T19 D18",
    152:"T20 T20 D16",
    151:"T20 T17 D20",
    150:"T20 T18 D18",
    149:"T20 T19 D16",
    148:"T20 T20 D14",
    147:"T20 T17 D18",
    146:"T20 T18 D16",
    145:"T20 T15 D20",
    144:"T20 T20 D12",
    141:"T20 T19 D12",
    140:"T20 T20 D10",
    138:"T20 T18 D12",
    137:"T20 T19 D10",
    136:"T20 T20 D8",
    135:"Bull T15 D20",
    134:"T20 T14 D16",
    133:"T20 T19 D8",
    132:"T20 T20 D6",
    131:"T20 T13 D16",
    130:"T20 T20 D5",
    127:"T20 T17 D8",
    126:"T19 T19 D6",
    125:"Bull T15 D10",
    120:"T20 20 D20",
    110:"T20 10 D20",
    100:"T20 D20"
  };
  if(map[score]) return map[score];
  if(score<=40 && score%2===0) return `D${score/2}`;
  if(score<=50 && score%2!==0) return `1 D${(score-1)/2}`;
  return "";
}

/* ========= Core actions ========= */
window.handleHit = function(e){

  // âœ… å…ˆæŠ“é¶é¢è³‡æ–™ï¼ˆä¸€å®šè¦åœ¨æœ€å‰é¢ï¼‰
  const scoreHit = parseInt(e.target.dataset.score || "0", 10);
  const hitId = e.target.dataset.id || String(scoreHit);
  let targetAngle = parseFloat(e.target.dataset.angle || "0");
  let targetRadius = parseFloat(e.target.dataset.radius || "0");

  // âœ… ä¿®æ­£æ¨¡å¼ï¼šå°±ç®—é–é¶ä¹Ÿå…è¨±ç›´æ¥æ”¹
  if(editTargetPid === currentPlayer && editTargetIdx !== null){
    applyEditDart(currentPlayer, editTargetIdx, hitId, scoreHit, targetAngle, targetRadius);

    // ä¿®å®Œç«‹åˆ»çµæŸä¿®æ­£ï¼ˆä¸€æ¬¡åªä¿®ä¸€é¢ï¼‰
    editTargetPid = null;
    editTargetIdx = null;
    return;
  }

  // âœ… ä¸€èˆ¬æ¨¡å¼æ‰æ“‹é–é¶
  if(isBoardLocked) return;

  // ======= ä»¥ä¸‹ä¿ç•™ä½ åŸæœ¬çš„æ­£å¸¸è¨ˆåˆ†æµç¨‹ï¼Œä¸ç”¨æ”¹ =======
  // spread markers within same segment
  // âœ… å›ºå®šä½ç½®ï¼šç¬¬1é¢ä¸­å¿ƒã€ç¬¬2é¢ä¸‹ç§»ã€ç¬¬3é¢ä¸Šç§»ï¼ˆä¸ç®¡åŒåˆ†ä¸åŒåˆ†ï¼‰
  const dartIndex = turnDarts + 1; // 1~3
  const pos = calcFixedDartPos(dartIndex, hitId, targetAngle, targetRadius);
  addMarker(pos.x, pos.y, dartIndex, 4);

  const p = players[currentPlayer];
  const remaining = p.score - scoreHit;
  const isDouble = (String(hitId).startsWith('D') || hitId==='B50');

  // bust rule (double-out)
  if(remaining<0 || remaining===1 || (remaining===0 && !isDouble)){
    p.turn.forEach(d=>{
      if(d.score>0){ p.score += d.score; p.matchTotalScore -= d.score; }
    });

    turnDarts++; p.matchTotalDarts++;
    p.turn.push({id:hitId,score:0,isBust:true});
    throwHistory.push({player:currentPlayer, dart:{id:hitId,score:0,isBust:true}});
    updateUI();
    setTimeout(()=>{ alert("çˆ†é¢ (BUST)ï¼\néœ€é›™å€å€çµæ¨™"); lockBoard(); }, 30);
    return;
  }

  p.score -= scoreHit;
  turnDarts++; p.matchTotalScore += scoreHit; p.matchTotalDarts++;
  p.turn.push({id:hitId,score:scoreHit});
  throwHistory.push({player:currentPlayer, dart:{id:hitId,score:scoreHit}});
  updateUI();

  if(p.score===0){
    setTimeout(()=>{
      syncNames();
      const winnerName = players[currentPlayer].name || (currentPlayer===1?"Player 1":"Player 2");
      if(confirm(`Game Shot!\nç¢ºèª ${winnerName} çµæ¨™ç²å‹ï¼Ÿ`)){
        handleLegWin(currentPlayer);
      } else {
        undoLast();
      }
    },80);
    return;
  }
  if(turnDarts>=3) lockBoard();
};

function handleMiss(){
  // âœ… ä¿®æ­£æ¨¡å¼ï¼šæŒ‰ MISS å°±ç›´æ¥æ›¿æ›é‚£ä¸€é¢ç‚º MISS
  if(editTargetPid === currentPlayer && editTargetIdx !== null){
    // ç”¨é¶å¤–åº§æ¨™é¡¯ç¤º missï¼ˆä¸é‡ç–Šï¼‰
    const pos = getMissXY(editTargetIdx+1);
    applyEditDart(currentPlayer, editTargetIdx, "MISS", 0, null, null, pos.x, pos.y);

    editTargetPid = null;
    editTargetIdx = null;
    return;
  }

  if(isBoardLocked) return;

  // âœ… æ­£å¸¸æŠ•æ“² MISSï¼šç•«åœ¨é¶å¤–ï¼Œä¸è¦ç•«ä¸­å¿ƒ
  const pos = getMissXY(turnDarts+1);
  addMarker(pos.x, pos.y, turnDarts+1, 4);

  const p = players[currentPlayer];
  turnDarts++;
  p.matchTotalDarts++;

  p.turn.push({id:'MISS', score:0, isMiss:true});
  throwHistory.push({player:currentPlayer, dart:{id:'MISS', score:0, isMiss:true}});

  updateUI();
  if(turnDarts>=3) lockBoard();
}

function undoLast(){
  if(throwHistory.length===0) return;

  const last = throwHistory.pop();
  const pid = last.player;
  const p = players[pid];
  const d = last.dart;

  // remove last marker
  const m = markers.pop();
  if(m) m.remove();

  // remove from turn list
  p.turn.pop();

  // revert score/darts totals
  if(d.score>0){
    p.score += d.score;
    p.matchTotalScore -= d.score;
  }
  p.matchTotalDarts = Math.max(0, p.matchTotalDarts-1);
  turnDarts = Math.max(0, turnDarts-1);

  // if we undid while board locked, unlock if <3 darts
  if(isBoardLocked && turnDarts<3){
    isBoardLocked=false;
    document.getElementById('overlay').style.display='none';
    setNextReady(false);
  }
  updateUI();
}
function applyEditDart(pid, idx, newId, newScore, targetAngle, targetRadius){

  const p = players[pid];
  if(!p || !p.turn || p.turn.length <= idx) return;

  const old = p.turn[idx];

  // âœ… å…ˆæŠŠèˆŠåˆ†æ•¸åŠ å›å»
  if(old.score > 0){
    p.score += old.score;
    p.matchTotalScore -= old.score;
  }

  // âœ… å†æ‰£æ‰æ–°åˆ†æ•¸ï¼ˆçˆ†é¢è¦å‰‡ï¼‰
  if(newScore > 0){
    const remaining = p.score - newScore;
    const isDouble = (String(newId).startsWith('D') || newId === "B50");

    if(remaining < 0 || remaining === 1 || (remaining === 0 && !isDouble)){
      alert("é€™å€‹ä¿®æ­£æœƒé€ æˆçˆ†é¢ï¼ˆBUSTï¼‰ï¼Œè«‹æ”¹å…¶ä»–é¶é¢");
      showEditOverlay(idx);
      return;
    }

    p.score -= newScore;
    p.matchTotalScore += newScore;
  }

  // âœ… æ›´æ–° turn è³‡æ–™ï¼ˆä¿ç•™ MISS/BUSTï¼‰
  const isMiss = (newId === "MISS");
  const isBust = (old && old.isBust) ? true : false; // ä¿®æ­£æ™‚ä¿ç•™ bust å±¬æ€§ï¼ˆå¯ä¾éœ€æ±‚æ‹¿æ‰ï¼‰
  p.turn[idx] = { id:newId, score:newScore, isMiss:isMiss, isBust:isBust };

  // âœ… ç§»é™¤èˆŠ marker
  if(markers[idx]){
    markers[idx].remove();
    markers[idx] = null;
  }

  // âœ… å›ºå®šä¸‰ä½ç½®ï¼šç¬¬1é¢ä¸­å¿ƒã€ç¬¬2é¢ä¸‹ç§»ã€ç¬¬3é¢ä¸Šç§»ï¼ˆä¸ç®¡åŒåˆ†ä¸åŒåˆ†ï¼‰
  const dartIndex = idx + 1; // 1~3

  let pos;

  if(isMiss){
    // MISS ä¸€å¾‹ç•«åœ¨é¶å¤–ï¼Œä¸‰é¢åˆ†æ•£
    pos = getMissXY(dartIndex);
  }else{
    // é˜²å‘†
    if(typeof targetAngle !== "number") targetAngle = 0;
    if(typeof targetRadius !== "number") targetRadius = 0;

    // âœ… æ ¸å¿ƒï¼šç”¨ dartIndex å›ºå®šä½ç½®ï¼Œä¸ç”¨ hitCount
    pos = calcFixedDartPos(dartIndex, newId, targetAngle, targetRadius);
  }

  // âœ… é‡æ–°ç•« markerï¼ˆä¸è¦ pushï¼Œç›´æ¥å¡å› markers[idx]ï¼‰
  const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx", pos.x);
  c.setAttribute("cy", pos.y);
  c.setAttribute("r", 4);
  c.setAttribute("class", `dart-marker dart-marker-${dartIndex}`);
  svg.appendChild(c);

  markers[idx] = c;

  // âœ… slot åœæ­¢é–ƒçˆ
  const slots = document.getElementById(pid===1?'p1Slots':'p2Slots').querySelectorAll('.slot');
  if(slots[idx]){
    slots[idx].classList.remove('editing');
  }

  // âœ… é—œé–‰æç¤º
  hideEditOverlay();

  updateUI();
}

function editDart(pid, idx, ev){
  ev.stopPropagation();

  // åªèƒ½ä¿®æ­£ç›®å‰å›åˆçš„äººï¼ˆé¿å…æ”¹åˆ°å¦ä¸€ä½ï¼‰
  if(pid !== currentPlayer){
    alert("åªèƒ½ä¿®æ­£ç›®å‰é€™ä½é¸æ‰‹çš„å›åˆ");
    return;
  }

  const p = players[pid];
  if(!p.turn || p.turn.length <= idx){
    alert("ç›®å‰é€™ä¸€é¢é‚„æ²’æŠ•å‡ºï¼Œç„¡æ³•ä¿®æ­£");
    return;
  }

  // âœ… é€²å…¥ä¿®æ­£æ¨¡å¼
  editTargetPid = pid;
  editTargetIdx = idx;

  // âœ… â‘ æç¤ºï¼šè«‹é»é¶é¢ä¿®æ­£
  showEditOverlay(idx);

  // âœ… â‘¡é‚£æ ¼è®Šç©ºç™½/é–ƒçˆï¼ˆå…ˆåšç©ºç™½ï¼‰
  const slots = document.getElementById(pid===1?'p1Slots':'p2Slots').querySelectorAll('.slot');
  if(slots[idx]){
    slots[idx].textContent = '';
    slots[idx].classList.add('editing');
  }
}
function nextPlayer(){
  if(!isBoardLocked) return;
  // clear current player's turn
  players[currentPlayer].turn = [];
  // switch player
  currentPlayer = (currentPlayer===1)?2:1;
  turnDarts = 0;
  isBoardLocked = false;
  turnHitCounts = {};
  document.getElementById('overlay').style.display='none';
  clearMarkers();
  setNextReady(false);
  updateUI();
  updateActiveCard();
}

function handleLegWin(winner){
  players[winner].legs++;
  const loser = (winner===1)?2:1;
  if(players[winner].legs>=targetLegs){
    advanceWinner(winner);
    return;
  }
  alert(`${players[winner].legs} - ${players[loser].legs}\nä¸‹ä¸€å±€é–‹å§‹`);
  legStarter = (winner===1)?2:1;
  currentPlayer = legStarter;
  clearMarkers();
  resetLegValues();
}

/* ========= Soft mode ========= */
function toggleSoft(on){
  const softPanel = document.getElementById('softPanel');
  softPanel.style.display = on ? 'flex' : 'none';
  
  if(on){
    // åŒæ­¥é¸æ‰‹åç¨±èˆ‡å±€æ•¸
    document.getElementById('sP1Name').innerText = players[1].name;
    document.getElementById('sP2Name').innerText = players[2].name;
    document.getElementById('sP1Legs').innerText = players[1].legs;
    document.getElementById('sP2Legs').innerText = players[2].legs;
    // é€™è£¡å¾®èª¿ä¸€ä¸‹è¦å‰‡é¡¯ç¤º logic
    const boRule = (targetLegs * 2 - 1);
    document.getElementById('softRule').innerText = `è»Ÿé¶æ¨¡å¼ï¼šBo${boRule} / ${GAME_MODE}`;
  }
}
function applyTargetType() {
  const typeSel = document.getElementById('targetTypeSel');
  if(!typeSel) return;
  
  const type = typeSel.value;

  if (type === 'soft') {
    // ç›´æ¥é–‹å•Ÿæ‚¨åŸæœ¬è¨­å®šçš„å…¨ç•«é¢è»Ÿé¶é¢æ¿
    toggleSoft(true); 
  } else {
    // å›åˆ°ç¡¬é¶æ¨¡å¼
    toggleSoft(false);
  }
}
function manualLeg(pid){
  // 1. å¢åŠ å±€æ•¸
  players[pid].legs++;
  
  // 2. æ›´æ–°è»Ÿé¶èˆ‡ä¸»ä»‹é¢é¡¯ç¤º
  document.getElementById(pid===1?'sP1Legs':'sP2Legs').innerText = players[pid].legs;
  document.getElementById(pid===1?'p1Legs':'p2Legs').innerText = players[pid].legs;
  
  // 3. åˆ¤æ–·æ˜¯å¦é”åˆ°å‹è³½é–€æª» (Bo3 æ¶ 2, Bo5 æ¶ 3...)
  // targetLegs åœ¨ç¨‹å¼ä¸­å·²ç¶“æ ¹æ“š Bo è³½åˆ¶è¨ˆç®—å¥½äº† (e.g., Bo3 æ™‚ targetLegs = 2)
  if(players[pid].legs >= targetLegs){
    const winnerName = players[pid].name;
    setTimeout(() => {
      alert(`æ¯”è³½çµæŸï¼æ­å–œ ${winnerName} ç²å¾—å‹åˆ©ï¼`);
      // å‘¼å«åŸæœ¬ç¨‹å¼ä¸­è™•ç†æ™‰ç´šçš„é‚è¼¯
      advanceWinner(pid); 
      // çµæŸå¾Œè‡ªå‹•é—œé–‰è»Ÿé¶é¢æ¿
      toggleSoft(false);
    }, 100);
  }
}

/* ========= Bracket logic ========= */
let TOTAL_PLAYERS = 8;
let currentStage = 'group'; // group|final
let subView = 'rank'; // rank|schedule|bracket
let groupRules = {bo:5, score:501};
let finalRules = {bo:3, score:501};
let knockoutRoundRules = {}; // roundIndex => {bo, score}

let groupsData = {}; // {A:[{id,name,wins,legsDiff}], ...}
let groupMatches = []; // [{id,group,p1,p2,winner,score,time}]
let matchesData = {}; // mid => {id,round,nextMatchId,time}
let currentMatchId = null; // string (group) or number (knockout)

function openBracket(){
  document.getElementById('bracketModal').style.display='flex';
  syncBars();
  if(subView==='bracket') setTimeout(drawConnectors,80);
}
function closeBracket(){ 
  document.getElementById('bracketModal').style.display='none'; 
  // é—œé–‰è³½ç¨‹è¡¨å¾Œï¼Œæ ¹æ“šé¸å–®æ±ºå®šè¦ç•™åœ¨ç¡¬é¶é‚„æ˜¯è·³åˆ°å…¨ç•«é¢è»Ÿé¶
  applyTargetType(); 
}

function initSizeOptions(){
  const sizeSel = document.getElementById('sizeSel');
  const fmt = document.getElementById('fmtSel').value;
  const cur = parseInt(sizeSel.value || "8", 10);

  sizeSel.innerHTML = '';

  if(fmt === 'group'){
    // âœ… å°çµ„å¾ªç’°è³½ï¼šå›ºå®šæ–¹æ¡ˆæ¸…å–®ï¼ˆç¸½äººæ•¸ / çµ„æ•¸ / æ¯çµ„äººæ•¸ï¼‰
    const plans = [
      { total: 3,  groups: 1,  per: 3 },
      { total: 4,  groups: 1,  per: 4 },
      { total: 6,  groups: 2,  per: 3 },
      { total: 8,  groups: 2,  per: 4 },
      { total: 12, groups: 4,  per: 3 },
      { total: 16, groups: 4,  per: 4 },
      { total: 24, groups: 8,  per: 3 },
      { total: 32, groups: 8,  per: 4 },
      { total: 48, groups: 16, per: 3 },
      { total: 64, groups: 16, per: 4 },
    ];

    plans.forEach(p=>{
      const o = document.createElement('option');
      o.value = String(p.total);
      o.textContent = `${p.total}äººï¼ˆåˆ†${p.groups}çµ„ï¼Œæ¯çµ„${p.per}äººï¼‰`;
      o.dataset.pergroup = String(p.per);   // âœ…æŠŠæ¯çµ„äººæ•¸ä¹Ÿè—åœ¨ option è£¡
      sizeSel.appendChild(o);
    });

  }else{
    // âœ… å–®æ·˜æ±°ï¼šå›ºå®š 2^n
    const opts = [4,8,16,32,64,128];
    opts.forEach(v=>{
      const o=document.createElement('option');
      o.value=String(v);
      o.textContent = `${v}äºº`;
      sizeSel.appendChild(o);
    });
  }

  // âœ… ä¿®æ­£é¸å€¼
  const values = [...sizeSel.options].map(o=>parseInt(o.value,10));
  sizeSel.value = values.includes(cur) ? String(cur) : String(values[0]);

  TOTAL_PLAYERS = parseInt(sizeSel.value, 10);

  // âœ… å¦‚æœæ˜¯ groupï¼Œå°±åŒæ­¥ perGroupSelï¼ˆè®“ç³»çµ±çŸ¥é“æ¯çµ„å¹¾äººï¼‰
  if(fmt === 'group'){
    const selOpt = sizeSel.options[sizeSel.selectedIndex];
    const per = parseInt(selOpt?.dataset?.pergroup || "4", 10);
    const perSel = document.getElementById('perGroupSel');
    if(perSel) perSel.value = String(per);
  }
}

function syncBars(){
  const fmtSel = document.getElementById('fmtSel');
  const fmt = fmtSel ? fmtSel.value : 'group';

  const sizeSel = document.getElementById('sizeSel');

  const tabsG = document.getElementById('tabsGroup');
  const tabsK = document.getElementById('tabsKnock');

  // åˆ†çµ„è³½ Tab
  const tabRank   = document.getElementById('tabGroupRank');
  const tabSch    = document.getElementById('tabGroupSch');
  const tabFinalB = document.getElementById('tabFinalBracket');
  const tabFinalS = document.getElementById('tabFinalSch');

  // è¦å‰‡åˆ—
  const gbar = document.getElementById('groupRules');
  const fbar = document.getElementById('finalRules');

  // âœ… 1) åˆ‡æ›ä¸Šæ–¹ Tabs é¡¯ç¤º
  if(tabsG) tabsG.style.display = (fmt === 'group') ? 'flex' : 'none';
  if(tabsK) tabsK.style.display = (fmt === 'knockout') ? 'flex' : 'none';

  // âœ… 2) å¼·åˆ¶éš±è— perGroupSelï¼ˆä½ ç¾åœ¨è¦çš„æ–¹æ¡ˆé¸å–®éƒ½æ”¾ sizeSel è£¡ï¼‰
  const perGroupSel = document.getElementById('perGroupSel');
  const perGroupLbl = perGroupSel?.previousElementSibling; // <span class="lbl">æ¯çµ„ï¼š</span>
  if(perGroupSel) perGroupSel.style.display = 'none';
  if(perGroupLbl) perGroupLbl.style.display = 'none';

  // âœ… 3) æŠŠã€Œç¸½äººæ•¸ã€é‚£å€‹ label æ”¹å­—ï¼šgroup -> æ¯çµ„ï¼›knockout -> ç¸½äººæ•¸
  // æ‰¾ sizeSel å‰ä¸€å€‹ span.lbl
  const sizeLbl = sizeSel?.previousElementSibling;
  if(sizeLbl && sizeLbl.classList.contains('lbl')){
    sizeLbl.innerText = (fmt === 'group') ? "æ¯çµ„ï¼š" : "ç¸½äººæ•¸ï¼š";
  }

  // âœ… 4) å…ˆé‡å»º sizeSel é¸å–®å…§å®¹ï¼ˆå¾ˆé‡è¦ï¼šå…ˆåšå†è®€ sizeï¼‰
  initSizeOptions();

  // âœ… 5) å–å¾—æœ€æ–° size
  const size = parseInt(sizeSel?.value || "0", 10);

  // âœ… 6) group æ¨¡å¼ä¸‹ï¼šä¾ç…§ size æ±ºå®šæ˜¯å¦é¡¯ç¤ºã€Œæ±ºè³½ã€åˆ†é 
  if(fmt === 'group'){
    if(size > 4){
      if(tabRank) tabRank.innerText = "ğŸ“Š é è³½åˆ†çµ„ç©åˆ†æ¦œ";
      if(tabSch)  tabSch.innerText  = "ğŸ“… é è³½æ™‚é–“è¡¨";
      if(tabFinalB) tabFinalB.style.display = "block";
      if(tabFinalS) tabFinalS.style.display = "block";
    }else{
      if(tabRank) tabRank.innerText = "ğŸ“Š ç©åˆ†æ¦œ";
      if(tabSch)  tabSch.innerText  = "ğŸ“… è³½ç¨‹è¡¨";
      if(tabFinalB) tabFinalB.style.display = "none";
      if(tabFinalS) tabFinalS.style.display = "none";
    }

    // group / final éšæ®µè¦å‰‡åˆ—é¡¯ç¤º
    if(currentStage === 'group'){
      if(gbar) gbar.style.display = 'flex';
      if(fbar) fbar.style.display = 'none';
    }else{
      if(gbar) gbar.style.display = 'none';
      if(fbar) fbar.style.display = 'flex';
    }
  }else{
    if(gbar) gbar.style.display = 'none';
    if(fbar) fbar.style.display = 'none';
  }

  // âœ… 7) åŒæ­¥è¦å‰‡æ•¸å€¼
  const gBo = document.getElementById('gBo');
  const gScore = document.getElementById('gScore');
  const fBo = document.getElementById('fBo');
  const fScore = document.getElementById('fScore');

  if(gBo) gBo.value = String(groupRules.bo);
  if(gScore) gScore.value = String(groupRules.score);
  if(fBo) fBo.value = String(finalRules.bo);
  if(fScore) fScore.value = String(finalRules.score);

  // backWrapï¼ˆä½ åŸæœ¬æœ‰ç•™è‘—ï¼‰
  const backWrap = document.getElementById('backWrap');
  if(backWrap) backWrap.style.display = (fmt === 'group' && currentStage === 'final') ? 'block' : 'none';
}

	// äº‹ä»¶ç›£è½éƒ¨åˆ†
	document.getElementById('modeSel').addEventListener('change', ()=>{
	  if(confirm("åˆ‡æ›æ¨¡å¼å°‡é‡ç½®è³½ç¨‹ï¼Œç¢ºå®šå—ï¼Ÿ")) initBracket();
	});

	document.getElementById('fmtSel').addEventListener('change', ()=>{
	  syncBars();     // âœ… ä¸€å®šè¦å…ˆåˆ‡æ›é¡¯ç¤º/é¸å–®
	  initBracket();  // âœ… å†é‡å»ºè³½ç¨‹
	});

	document.getElementById('sizeSel').addEventListener('change', ()=>{
	document.getElementById('sizeSel').addEventListener('change', ()=>{
	  const sizeSel = document.getElementById('sizeSel');
	  TOTAL_PLAYERS = parseInt(sizeSel.value,10);

	  const fmt = document.getElementById('fmtSel').value;
	  if(fmt === 'group'){
		const per = parseInt(sizeSel.selectedOptions[0]?.dataset?.pergroup || "4", 10);
		const perSel = document.getElementById('perGroupSel');
		if(perSel) perSel.value = String(per);
	  }

	  initBracket();
	});
	});

	document.getElementById('gBo').addEventListener('change', applyGroupRules);
	document.getElementById('gScore').addEventListener('change', applyGroupRules);
	document.getElementById('fBo').addEventListener('change', applyFinalRules);
	document.getElementById('fScore').addEventListener('change', applyFinalRules);
	
	// âœ… fmt=group æ‰é¡¯ç¤ºã€Œæ¯çµ„ã€é¸å–®ï¼ˆé¿å…ä¸€é–‹å§‹å°±è·‘å‡ºä¾†ï¼‰
	const fmtNow = document.getElementById('fmtSel').value;
	const perGroupSel = document.getElementById('perGroupSel');
	const perGroupLbl = perGroupSel?.previousElementSibling; // <span class="lbl">æ¯çµ„ï¼š</span>

	if(fmtNow === 'group'){
	  if(perGroupSel) perGroupSel.style.display = '';
	  if(perGroupLbl) perGroupLbl.style.display = '';
	}else{
	  if(perGroupSel) perGroupSel.style.display = 'none';
	  if(perGroupLbl) perGroupLbl.style.display = 'none';
	}

function switchStage(stage){
  currentStage = stage;
  // default subview
  subView = (stage==='group') ? 'rank' : (document.getElementById('fmtSel').value==='knockout'?'bracket':'bracket');
  setSubView(subView);
  syncBars();
}

function setSubView(view){
  subView = view;
  
  // 1. éš±è—æ‰€æœ‰è¦–åœ–å€å¡Šèˆ‡ç·šæ¢
  document.getElementById('groupView').style.display='none';
  document.getElementById('groupSchedule').style.display='none';
  document.getElementById('bracketView').style.display='none';
  document.getElementById('knockSchedule').style.display='none';
  document.getElementById('lines').style.display='none';

  // 2. è™•ç†è¦å‰‡åˆ—çš„é¡¯ç¤ºèˆ‡éš±è— (é—œéµä¿®æ­£)
  const gRules = document.getElementById('groupRules');
  const fRules = document.getElementById('finalRules');
  
  // åˆ¤æ–·ï¼šå¦‚æœæ˜¯æ±ºè³½ç›¸é—œåˆ†é  (bracket æˆ– knockSch)ï¼Œå°±éš±è—æ‰€æœ‰è¦å‰‡åˆ—
  if (view === 'bracket' || view === 'knockSch') {
      if (gRules) gRules.style.display = 'none';
      if (fRules) fRules.style.display = 'none';
  } else {
      // å¦‚æœå›åˆ°äº†é è³½åˆ†é ï¼Œå°±é¡¯ç¤ºé è³½è¦å‰‡
      if (gRules) gRules.style.display = 'flex';
      if (fRules) fRules.style.display = 'none'; // æ±ºè³½å…¨åŸŸè¦å‰‡åœ¨æ‚¨é€™è£¡ä¸éœ€è¦ï¼Œç¶­æŒéš±è—
  }

  // 3. è™•ç†æ¨™ç±¤é«˜äº® (Tab active)
  const fmt = document.getElementById('fmtSel').value;
  const tabs = (fmt==='group') ? document.getElementById('tabsGroup') : document.getElementById('tabsKnock');
  [...tabs.querySelectorAll('.tab')].forEach(t => t.classList.remove('active'));

  // 4. æ ¹æ“š view é¡¯ç¤ºå°æ‡‰å…§å®¹
  if(fmt==='group'){
    if(view==='rank'){ 
      tabs.children[0].classList.add('active'); 
      document.getElementById('groupView').style.display='grid'; 
      renderGroupView(); 
    } else { 
      tabs.children[1].classList.add('active'); 
      document.getElementById('groupSchedule').style.display='flex'; 
      renderGroupSchedule(); 
    }
  } else {
    // é€™è£¡è™•ç†ç´”å–®æ·˜æ±°æ¨¡å¼ (éå¾ªç’°è³½è½‰æ±ºè³½çš„æƒ…æ³)
    if(view==='bracket'){ 
      tabs.children[0].classList.add('active'); 
      document.getElementById('bracketView').style.display='flex'; 
      document.getElementById('lines').style.display='block'; 
      renderKnockoutBracket(); 
      setTimeout(drawConnectors, 60); 
    } else { 
      tabs.children[1].classList.add('active'); 
      document.getElementById('knockSchedule').style.display='flex'; 
      renderKnockoutSchedule(); 
    }
  }
  syncBars();
}


function initBracket(){
  matchesData={}; groupsData={}; groupMatches=[]; currentMatchId=null;
  knockoutRoundRules={};
  const fmt=document.getElementById('fmtSel').value;
  if(fmt==='group'){
    initGroupStage();
    applyGroupRules(); // ensures all matches use same bo/score
    switchStage('group');
    setSubView('rank');
  }else{
    switchStage('final');
    setSubView('bracket');
  }
  syncBars();
}

function initGroupStage(){
  const mode=document.getElementById('modeSel').value;
  let prefix = (mode==='single')?'Player':(mode==='double'?'Pair':'Team');
  const perGroup = parseInt(document.getElementById('sizeSel').selectedOptions[0]?.dataset?.pergroup || "4", 10);
  const numGroups=Math.max(1, Math.ceil(TOTAL_PLAYERS/perGroup));
  const alpha="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  for(let g=0; g<numGroups; g++){
    const gKey=alpha[g];
    groupsData[gKey]=[];
    for(let i=1;i<=perGroup;i++){
      const globalId = g*perGroup + i;
      if(globalId>TOTAL_PLAYERS) break;
      groupsData[gKey].push({id:globalId,name:`${prefix} ${globalId}`,wins:0,legsDiff:0});
    }
    // round robin matches
    const p=groupsData[gKey];
    const add=(a,b)=>{
      groupMatches.push({id:`G-${gKey}-${a.id}-${b.id}`,group:gKey,p1:a.id,p2:b.id,winner:null,score:null,time:'',bo:groupRules.bo,scoreMode:groupRules.score});
    };
    for(let i=0;i<p.length;i++){
      for(let j=i+1;j<p.length;j++) add(p[i],p[j]);
    }
  }
}

function updatePlayerName(gKey,pid,v){
  const p = groupsData[gKey].find(x=>x.id===pid);
  if(p) p.name=v;
}
function updateDoubleName(el,gKey,pid){
  const wrap=el.closest('.doubleRow');
  const ins=[...wrap.querySelectorAll('input')];
  const v1=ins[0].value.trim(), v2=ins[1].value.trim();
  const combined = v2 ? `${v1} / ${v2}` : v1;
  updatePlayerName(gKey,pid,combined);
}

function renderGroupView() {
  const cont = document.getElementById('groupView');
  cont.innerHTML = '';
  const keys = Object.keys(groupsData).sort();
  const mode = document.getElementById('modeSel').value;
  
  // 1. æ ¹æ“šæ¨¡å¼æ±ºå®šæ¨™é¡Œ
  let colTitle = "é¸æ‰‹ (å¯ç·¨è¼¯)";
  if(mode === 'double') colTitle = "æ­æ“‹ (Pair)";
  if(mode === 'team') colTitle = "éšŠä¼ (Team)";

  keys.forEach(k => {
    const box = document.createElement('div');
    box.className = 'gbox';

    // 2. å°ˆæ¥­æ’åºé‚è¼¯ï¼šå„ªå…ˆçœ‹ç©åˆ† (pts)ï¼Œå†çœ‹è…¿å·® (legsDiff)
    const sorted = [...groupsData[k]].sort((a,b) => (b.pts - a.pts) || (b.legsDiff - a.legsDiff));

    // 3. ä¿®æ”¹è¡¨æ ¼æ¨™é¡Œï¼Œå¢åŠ ã€Œè² ã€èˆ‡ã€Œç©åˆ†ã€
    let html = `<div class="gtitle">Group ${k}</div>
    <table class="stand">
      <tr>
        <th style="width:40%">${colTitle}</th>
        <th>å‹</th>
        <th>è² </th>
        <th>å±€æ•¸å·®</th>
        <th>ç©åˆ†</th>
      </tr>`;

    sorted.forEach((p, idx) => {
      const cls = idx === 0 ? 'rank1' : (idx === 1 ? 'rank2' : '');
      
      // 4. ä¿ç•™åŸæœ¬çš„ç·¨è¼¯è¼¸å…¥æ¡†é‚è¼¯
      let input = '';
      if(mode === 'double'){
        const parts = (p.name || '').split('/');
        const v1 = (parts[0] || '').trim(), v2 = (parts[1] || '').trim();
        input = `<div class="doubleRow">
          <input class="nameInput nameHalf" value="${escapeHtml(v1)}" placeholder="é¸æ‰‹A" oninput="updateDoubleName(this,'${k}',${p.id})">
          <span class="sep">/</span>
          <input class="nameInput nameHalf" value="${escapeHtml(v2)}" placeholder="é¸æ‰‹B" oninput="updateDoubleName(this,'${k}',${p.id})">
        </div>`;
      } else {
        input = `<input class="nameInput" value="${escapeHtml(p.name)}" placeholder="å§“å" oninput="updatePlayerName('${k}',${p.id},this.value)">`;
      }

      // 5. å¡«å…¥æ•¸æ“š (åŠ ä¸Š || 0 é˜²æ­¢ç©ºå€¼)
      html += `<tr class="${cls}">
        <td>${input}</td>
        <td>${p.wins || 0}</td>
        <td>${p.losses || 0}</td>
        <td>${p.legsDiff > 0 ? ('+' + p.legsDiff) : (p.legsDiff || 0)}</td>
        <td><b>${p.pts || 0}</b></td>
      </tr>`;
    });

    html += `</table>`;
    box.innerHTML = html;
    cont.appendChild(box);
  });
}
function renderGroupSchedule(){
  const cont=document.getElementById('groupSchedule');
  
  // é€™è£¡ç¶­æŒé¡¯ç¤ºã€Œç›®å‰é¸å–®è¨­å®šã€çš„è¦å‰‡æ¨™é¡Œ
  const globalRuleText = `Bo${document.getElementById('gBo').value} / ${document.getElementById('gScore').value}`;
  
  let html = `<div style="width:100%;max-width:1000px;margin:0 auto 10px;color:#666;font-weight:900">
    å°çµ„è³½çµ±ä¸€è¦å‰‡ï¼š<span style="color:#007bff">${globalRuleText}</span>
  </div>`;
  
  html += `<table class="table"><thead><tr>
    <th>å ´æ¬¡</th><th>æ™‚é–“</th><th>çµ„åˆ¥</th><th>å°æˆ°çµ„åˆ</th><th>è¦å‰‡</th><th>æ¯”åˆ†</th><th>æ“ä½œ</th>
  </tr></thead><tbody>`;
  
  groupMatches.forEach((m,idx)=>{
    const p1=groupsData[m.group].find(x=>x.id===m.p1);
    const p2=groupsData[m.group].find(x=>x.id===m.p2);
    
    // --- æ ¸å¿ƒä¿®æ­£é»ï¼šè®€å–å ´æ¬¡ç‰©ä»¶ m è£¡é¢çš„ bo èˆ‡ score ---
    // ä¸è¦ç”¨å…¨åŸŸçš„ ruleTextï¼Œæ”¹ç”¨ m.bo å’Œ m.score
    const matchRuleText = `Bo${m.bo || 5} / ${m.scoreMode || 501}`;
    
    const scoreDisp = m.winner ? `<span class="tag done">${m.score_display || '-'}</span>` : `<span class="tag">-</span>`;
    const btnCls = m.winner ? 'play disabled':'play';
    
    html += `<tr>
      <td>#${idx+1}</td>
      <td><input class="time" value="${escapeHtml(m.time||'')}" placeholder="00:00" onchange="updateMatchTime('G','${m.id}',this.value)"></td>
      <td>Group ${m.group}</td>
      <td>${escapeHtml(p1.name)} <span style="color:#999;font-size:.8em">vs</span> ${escapeHtml(p2.name)}</td>
      
      <td><span class="tag">${matchRuleText}</span></td>
      
      <td>${scoreDisp}</td>
      <td><div class="${btnCls}" onclick="loadGroupMatch('${m.id}')">è¼‰å…¥</div></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  cont.innerHTML=html;
}

function applyGroupRules(){
  groupRules.bo=parseInt(document.getElementById('gBo').value,10);
  groupRules.score=parseInt(document.getElementById('gScore').value,10);
  groupMatches.forEach(m=>{ m.bo=groupRules.bo; m.scoreMode=groupRules.score; });
  if(subView==='schedule' && currentStage==='group') renderGroupSchedule();
  syncBars();
}
function applyFinalRules(){
  finalRules.bo=parseInt(document.getElementById('fBo').value,10);
  finalRules.score=parseInt(document.getElementById('fScore').value,10);
  // if we are in final-from-groups stage, sync all round selects
  const rounds = Math.log2(TOTAL_PLAYERS)||0;
  for(let r=0;r<rounds;r++){ knockoutRoundRules[r]={bo:finalRules.bo,score:finalRules.score}; }
  if(subView==='schedule' && currentStage==='final') renderKnockoutSchedule();
  syncBars();
}

function loadGroupMatch(id){
  const m=groupMatches.find(x=>x.id===id);
  if(m.winner){ alert("é€™å ´æ¯”è³½å·²ç¶“çµæŸ"); return; }
  const p1=groupsData[m.group].find(x=>x.id===m.p1);
  const p2=groupsData[m.group].find(x=>x.id===m.p2);
  const legsNeeded = Math.ceil(groupRules.bo/2);
  if(!confirm(`è¼‰å…¥ Group ${m.group} å°æˆ°ï¼Ÿ\n${p1.name} vs ${p2.name}\nè¦å‰‡ï¼šBo${groupRules.bo}ï¼ˆæ¶ ${legsNeeded} å‹ï¼‰ / ${groupRules.score}`)) return;

  currentMatchId=id;
  targetLegs = legsNeeded;
  GAME_MODE = groupRules.score;
  document.getElementById('p1Name').innerText = p1.name;
  document.getElementById('p2Name').innerText = p2.name;
  players[1].name=p1.name; players[2].name=p2.name;
  document.getElementById('softRule').innerText = `Bo${groupRules.bo} / ${groupRules.score}`;
  resetMatch();
  closeBracket();
}

// è«‹å‹™å¿…èˆ‡ä¸Šè¿°å‡½å¼é…å¥—ä½¿ç”¨
function fillFinalNamesFromGroups(groupKeys) {
    let matchId = 0;
    // æ¯å…©çµ„é€²è¡Œäº¤å‰å°ä½ (A1 vs B2, B1 vs A2)
    for (let i = 0; i < groupKeys.length; i += 2) {
        if (i + 1 >= groupKeys.length) break;

        const g1 = groupKeys[i];
        const g2 = groupKeys[i + 1];

        // å–å¾—é è³½å‰äºŒå
        const getTop2 = (g) => [...groupsData[g]].sort((a, b) => (b.wins - a.wins) || (b.legsDiff - a.legsDiff)).slice(0, 2);
        
        const t1 = getTop2(g1);
        const t2 = getTop2(g2);

        // äº¤å‰å¡«å…¥æ±ºè³½å°æˆ°æ¡†
        if (t1[0]) setMatchName(matchId, 1, t1[0].name);
        if (t2[1]) setMatchName(matchId, 2, t2[1].name);

        if (t2[0]) setMatchName(matchId + 1, 1, t2[0].name);
        if (t1[1]) setMatchName(matchId + 1, 2, t1[1].name);

        matchId += 2;
    }
}

// 2. é€™æ˜¯æ–°å¢åŠ çš„è¼”åŠ©å‡½å¼ï¼Œè«‹æ”¾åœ¨ä¸Šè¿°å‡½å¼çš„ä¸‹æ–¹ï¼Œè² è²¬äº¤å‰å°ä½
function fillFinalNamesFromGroups(groupKeys) {
    let matchId = 0;
    // æ¯å…©çµ„ä¸€å°é€²è¡Œäº¤å‰å°ä½ (Aèˆ‡B, Cèˆ‡D...)
    for (let i = 0; i < groupKeys.length; i += 2) {
        if (i + 1 >= groupKeys.length) break;

        const g1 = groupKeys[i];
        const g2 = groupKeys[i + 1];

        // æ’åºä¸¦å–å¾—å„çµ„å‰å…©å
        const getTop2 = (g) => [...groupsData[g]].sort((a, b) => (b.wins - a.wins) || (b.legsDiff - a.legsDiff)).slice(0, 2);
        
        const t1 = getTop2(g1);
        const t2 = getTop2(g2);

        // äº¤å‰å°ä½é‚è¼¯ï¼š
        // ç¬¬ X å ´ï¼šG1ç¬¬ä¸€å vs G2ç¬¬äºŒå
        if (t1[0]) setMatchName(matchId, 1, t1[0].name);
        if (t2[1]) setMatchName(matchId, 2, t2[1].name);

        // ç¬¬ X+1 å ´ï¼šG2ç¬¬ä¸€å vs G1ç¬¬äºŒå
        if (t2[0]) setMatchName(matchId + 1, 1, t2[0].name);
        if (t1[1]) setMatchName(matchId + 1, 2, t1[1].name);

        matchId += 2;
    }
}

function renderKnockoutBracket(fromGroups=false){
  const cont=document.getElementById('bracketView');
  cont.innerHTML='';
  matchesData={};

  const mode=document.getElementById('modeSel').value;
  const defName = (mode==='single')?'Player':(mode==='double'?'Pair':'Team');

  const rounds=Math.log2(TOTAL_PLAYERS);
  let matchCounter=0;
  let matchesInRound = TOTAL_PLAYERS/2;

  // è¨˜éŒ„æº–æ±ºè³½çš„å…©å€‹ match idï¼Œä¹‹å¾Œè¦æŠŠæ•—è€…å°å…¥å­£è»è³½
  let semiFinalMatchIds = [];

  // æˆ‘å€‘æœƒåœ¨æœ€å¾Œæ–°å¢ä¸€å€‹ thirdPlaceMatchId
  let thirdPlaceMatchId = null;

  for(let r=0;r<rounds;r++){
    const col=document.createElement('div');
    col.className='roundCol';

    const header=document.createElement('div');
    header.className='roundHeader';
	let title =
	  (r===rounds-1) ? "å† ã€äºè»æˆ°" :
	  (matchesInRound===2) ? "æº–æ±ºè³½" :
	  `ç¬¬ ${r+1} è¼ª`;

    // defaults
    const defaultBo = fromGroups ? finalRules.bo : (r===rounds-1?7:(r>0?5:3));
    const defaultScore = fromGroups ? finalRules.score : 501;
    if(!knockoutRoundRules[r]) knockoutRoundRules[r] = {bo:defaultBo, score:defaultScore};

    header.innerHTML = `<div class="roundTitle">${title}</div>
      <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
        <select id="koBo${r}" class="sel" style="padding:0;font-size:.8rem" onchange="onRoundRuleChange(${r},${fromGroups})">
          <option value="3"${knockoutRoundRules[r].bo===3?' selected':''}>Bo3</option>
          <option value="5"${knockoutRoundRules[r].bo===5?' selected':''}>Bo5</option>
          <option value="7"${knockoutRoundRules[r].bo===7?' selected':''}>Bo7</option>
        </select>
        <select id="koSc${r}" class="sel" style="padding:0;font-size:.8rem" onchange="onRoundRuleChange(${r},${fromGroups})">
          <option value="301"${knockoutRoundRules[r].score===301?' selected':''}>301</option>
          <option value="501"${knockoutRoundRules[r].score===501?' selected':''}>501</option>
          <option value="701"${knockoutRoundRules[r].score===701?' selected':''}>701</option>
        </select>
      </div>`;
    col.appendChild(header);

    for(let i=0;i<matchesInRound;i++){
      const mid=matchCounter++;
      matchesData[mid]={id:mid,round:r,nextMatchId:null,time:'', status:'pending'};

      // è‹¥æ­¤è¼ªæ˜¯æº–æ±ºè³½ï¼ˆmatchesInRound===2ï¼‰ï¼Œè¨˜éŒ„æ­¤ match id
      if(matchesInRound===2) semiFinalMatchIds.push(mid);

      const card=document.createElement('div');
      card.className='match';
      card.id=`match-${mid}`;
      card.onclick=()=>selectMatch(mid);

      const teamInput=(tn)=>{
        if(mode==='double'){
          return `<div class="team" style="padding:2px;display:flex;flex-direction:row;align-items:center;justify-content:center;gap:4px">
            <input id="m${mid}t${tn}a" class="inp" placeholder="é¸æ‰‹A" onclick="event.stopPropagation()" style="width:40%;min-width:0;text-align:center;padding:2px;font-size:14px">
            <span style="flex:0 0 auto;font-weight:900;color:#999">/</span>
            <input id="m${mid}t${tn}b" class="inp" placeholder="é¸æ‰‹B" onclick="event.stopPropagation()" style="width:40%;min-width:0;text-align:center;padding:2px;font-size:14px">
          </div>`;
        }
        return `<div class="team"><input id="m${mid}t${tn}a" class="inp" placeholder="${r===0?defName:'Winner'}" onclick="event.stopPropagation()"></div>`;
      };

		// åˆ¤æ–·æ˜¯å¦ç‚ºå† è»è³½ï¼ˆæœ€å¾Œä¸€è¼ª round === rounds-1 ä¸” matchesInRound==1 çš„é‚£å€‹ midï¼‰
		const isFinalMatch = (r === rounds - 1);

		card.innerHTML = `<div class="mlab">${isFinalMatch ? 'å† ã€äºè»æˆ°' : ('Match ' + (mid+1))}</div>
		  ${teamInput(1)}<div class="vs">VS</div>${teamInput(2)}`;
      col.appendChild(card);
    }

    cont.appendChild(col);
    matchesInRound/=2;
  }

  // set next links
  let start=0, count=TOTAL_PLAYERS/2;
  for(let r=0;r<rounds-1;r++){
    const nextStart=start+count;
    for(let i=0;i<count;i++){
      const cid=start+i;
      const tid=nextStart+Math.floor(i/2);
      matchesData[cid].nextMatchId=tid;
    }
    start+=count;
    count/=2;
  }

  // ======= âœ… æ–°å¢å­£è»è³½ï¼ˆ3rd placeï¼‰ =======
  // æ¢ä»¶ï¼šè‡³å°‘ 4 äººæ‰æœ‰æ„ç¾©
  if(TOTAL_PLAYERS>=4){
    thirdPlaceMatchId = matchCounter++;
    // ä½¿ç”¨ "Final round index" ç•¶ä½œå­£è»è³½è¼ªæ¬¡ï¼ˆè¦–è¦ºèˆ‡è¦å‰‡åŒ Final æˆ– Semi çš†å¯ï¼‰
    const thirdRoundIndex = rounds-1;

	matchesData[thirdPlaceMatchId] = {
	  id: thirdPlaceMatchId,
	  round: thirdRoundIndex,
	  nextMatchId: null,
	  time: '',
	  status: 'third' // âœ…é€™è¡Œä¸€å®šè¦æœ‰
	};

    // å»ºç«‹ä¸€å€‹ç¨ç«‹æ¬„ä½é¡¯ç¤ºå­£è»è³½ï¼ˆæ”¾åœ¨æœ€å¾Œä¸€æ¬„å³å´ï¼‰
    const thirdCol=document.createElement('div');
    thirdCol.className='roundCol';

    const thirdHeader=document.createElement('div');
    thirdHeader.className='roundHeader';
	// âœ… å­£ã€æ®¿è»æˆ°ç¨ç«‹è¦å‰‡ï¼ˆé è¨­ Bo3 / 501ï¼‰
	if(!window.__thirdPlaceRules){
	  window.__thirdPlaceRules = { bo: 3, score: 501 };
	}

	thirdHeader.innerHTML = `
	  <div class="roundTitle">å­£ã€æ®¿è»æˆ°</div>
	  <div style="display:flex;gap:8px;justify-content:center;align-items:center;margin-top:6px;">
		<select id="thirdBo" class="sel" style="padding:0;font-size:.8rem" onchange="onThirdRuleChange()">
		  <option value="3"${window.__thirdPlaceRules.bo===3?' selected':''}>Bo3</option>
		  <option value="5"${window.__thirdPlaceRules.bo===5?' selected':''}>Bo5</option>
		  <option value="7"${window.__thirdPlaceRules.bo===7?' selected':''}>Bo7</option>
		</select>
		<select id="thirdSc" class="sel" style="padding:0;font-size:.8rem" onchange="onThirdRuleChange()">
		  <option value="301"${window.__thirdPlaceRules.score===301?' selected':''}>301</option>
		  <option value="501"${window.__thirdPlaceRules.score===501?' selected':''}>501</option>
		  <option value="701"${window.__thirdPlaceRules.score===701?' selected':''}>701</option>
		</select>
	  </div>
	`;
    thirdCol.appendChild(thirdHeader);

    const card=document.createElement('div');
    card.className='match';
    card.id=`match-${thirdPlaceMatchId}`;
    card.onclick=()=>selectMatch(thirdPlaceMatchId);

    const teamInput=(tn)=>{
      if(mode==='double'){
        return `<div class="team" style="padding:2px;display:flex;flex-direction:row;align-items:center;justify-content:center;gap:4px">
          <input id="m${thirdPlaceMatchId}t${tn}a" class="inp" placeholder="æº–æ±ºè³½æ•—è€…" onclick="event.stopPropagation()" style="width:40%;min-width:0;text-align:center;padding:2px;font-size:14px">
          <span style="flex:0 0 auto;font-weight:900;color:#999">/</span>
          <input id="m${thirdPlaceMatchId}t${tn}b" class="inp" placeholder="æº–æ±ºè³½æ•—è€…" onclick="event.stopPropagation()" style="width:40%;min-width:0;text-align:center;padding:2px;font-size:14px">
        </div>`;
      }
      return `<div class="team"><input id="m${thirdPlaceMatchId}t${tn}a" class="inp" placeholder="æº–æ±ºè³½æ•—è€…" onclick="event.stopPropagation()"></div>`;
    };

	card.innerHTML = `<div class="mlab">å­£ã€æ®¿è»æˆ°</div>${teamInput(1)}<div class="vs">VS</div>${teamInput(2)}`;	
    thirdCol.appendChild(card);

    cont.appendChild(thirdCol);

    // å°‡æº–æ±ºè³½å…©å ´çš„ match è³‡è¨Šä¸­è¨˜éŒ„ thirdMatchId èˆ‡å…¶æ•—è€…è¦å¡åˆ°å“ªå€‹ä½ç½®
    // ä¹‹å¾Œç”± advanceWinner() ä¾†å¡«å…¥
    window.__thirdPlace = {
      id: thirdPlaceMatchId,
      semiIds: semiFinalMatchIds.slice(0,2) // åªéœ€è¦å‰å…©å ´æº–æ±ºè³½
    };
  } else {
    window.__thirdPlace = null;
  }

  // if from groups, enforce all header selects to finalRules
  if(fromGroups){
    const rounds=Math.log2(TOTAL_PLAYERS)||0;
    for(let r=0;r<rounds;r++){
      const b = document.getElementById(`koBo${r}`);
      const s = document.getElementById(`koSc${r}`);
      if(b) b.value=String(finalRules.bo);
      if(s) s.value=String(finalRules.score);
    }
  }

  renderKnockoutSchedule();
}

function onRoundRuleChange(roundIdx, fromGroups){
  const bo=parseInt(document.getElementById(`koBo${roundIdx}`).value,10);
  const sc=parseInt(document.getElementById(`koSc${roundIdx}`).value,10);

  if(fromGroups){
    // sync finalRules + all rounds
    finalRules.bo=bo; finalRules.score=sc;
    const rounds=Math.log2(TOTAL_PLAYERS)||0;
    for(let r=0;r<rounds;r++){
      knockoutRoundRules[r]={bo:bo,score:sc};
      const b=document.getElementById(`koBo${r}`), s=document.getElementById(`koSc${r}`);
      if(b) b.value=String(bo);
      if(s) s.value=String(sc);
    }
    document.getElementById('fBo').value=String(bo);
    document.getElementById('fScore').value=String(sc);
  }else{
    knockoutRoundRules[roundIdx]={bo:bo,score:sc};
  }
  renderKnockoutSchedule();
}
function onThirdRuleChange(){
  const bo = parseInt(document.getElementById('thirdBo').value, 10);
  const sc = parseInt(document.getElementById('thirdSc').value, 10);
  window.__thirdPlaceRules = { bo, score: sc };
  renderKnockoutSchedule(); // è®“æ™‚é–“è¡¨åŒæ­¥æ›´æ–°é¡¯ç¤ºè¦å‰‡
}

function getTeamName(mid,team){
  const mode=document.getElementById('modeSel').value;
  if(mode==='double'){
    const a=document.getElementById(`m${mid}t${team}a`)?.value?.trim()||"";
    const b=document.getElementById(`m${mid}t${team}b`)?.value?.trim()||"";
    return b ? `${a} / ${b}` : a;
  }
  return document.getElementById(`m${mid}t${team}a`)?.value?.trim() || "";
}
function setMatchName(mid,team,name){
  const mode=document.getElementById('modeSel').value;
  if(mode==='double'){
    const parts=name.split('/');
    const a=(parts[0]||'').trim(); const b=(parts[1]||'').trim();
    const ia=document.getElementById(`m${mid}t${team}a`), ib=document.getElementById(`m${mid}t${team}b`);
    if(ia) ia.value=a;
    if(ib) ib.value=b;
  }else{
    const ia=document.getElementById(`m${mid}t${team}a`);
    if(ia) ia.value=name;
  }
}

function renderKnockoutSchedule(){
  const cont=document.getElementById('knockSchedule');
  let html = `<table class="table"><thead><tr>
    <th>å ´æ¬¡</th><th>æ™‚é–“</th><th>è³½äº‹éšæ®µ</th><th>å°æˆ°çµ„åˆ</th><th>è¦å‰‡</th><th>æ¯”åˆ†</th><th>æ“ä½œ</th>
  </tr></thead><tbody>`;
  const matches = Object.values(matchesData).sort((a,b)=>a.id-b.id);
  matches.forEach(m=>{
    const n1 = getTeamName(m.id,1) || "å¾…å®š";
    const n2 = getTeamName(m.id,2) || "å¾…å®š";
    const rule = knockoutRoundRules[m.round] || {bo:3,score:501};
    html += `<tr>
      <td>M${m.id+1}</td>
      <td><input class="time" value="${escapeHtml(m.time||'')}" placeholder="00:00" onchange="updateMatchTime('K','${m.id}',this.value)"></td>
      <td>Round ${m.round+1}</td>
      <td>${escapeHtml(n1)} vs ${escapeHtml(n2)}</td>
      <td><span class="tag">Bo${rule.bo} / ${rule.score}</span></td>
      <td>-</td>
      <td><div class="play" onclick="selectMatch(${m.id})">è¼‰å…¥</div></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  cont.innerHTML=html;
}

function selectMatch(mid){
  const n1 = getTeamName(mid,1) || "P1";
  const n2 = getTeamName(mid,2) || "P2";

  // å…ˆæ‹¿ä¸€èˆ¬æ·˜æ±°è³½è¦å‰‡ï¼ˆä¿åº•å€¼é¿å… undefinedï¼‰
  let rule = knockoutRoundRules[matchesData[mid].round] || { bo: 3, score: 501 };

  // âœ… å¦‚æœæ˜¯ã€Œå­£ã€æ®¿è»æˆ°ã€å°±æ”¹ç”¨ç¨ç«‹è¦å‰‡
  if(matchesData[mid] && matchesData[mid].status === 'third'){
    rule = window.__thirdPlaceRules || { bo: 3, score: 501 };
  }

  const legsNeeded = Math.ceil(rule.bo / 2);

  if(!confirm(`è¼‰å…¥ Match ${mid+1}?\n${n1} VS ${n2}\nè¦å‰‡ï¼šBo${rule.bo}ï¼ˆæ¶ ${legsNeeded} å‹ï¼‰ / ${rule.score}`)) return;

  currentMatchId = mid;
  targetLegs = legsNeeded;
  GAME_MODE = rule.score;

  document.getElementById('p1Name').innerText = n1;
  document.getElementById('p2Name').innerText = n2;
  players[1].name = n1;
  players[2].name = n2;

  resetMatch();
  closeBracket();
}

function advanceWinner(winnerIdx){
  if(currentMatchId===null) return;

  const wLegs = players[winnerIdx].legs;
  const lLegs = players[winnerIdx===1?2:1].legs;

  if(typeof currentMatchId === 'string'){
    // group match
    const m=groupMatches.find(x=>x.id===currentMatchId);
    const wId = (winnerIdx===1)? m.p1 : m.p2;
    const lId = (winnerIdx===1)? m.p2 : m.p1;
    m.winner = wId;
    m.score = `${wLegs}-${lLegs}`;

    const wP = groupsData[m.group].find(x=>x.id===wId);
    const lP = groupsData[m.group].find(x=>x.id===lId);
    wP.wins += 1;
    wP.legsDiff += (wLegs-lLegs);
    lP.legsDiff += (lLegs-wLegs);
    alert(`å°çµ„è³½æ›´æ–°ï¼š${wP.name} å‹å‡ºï¼`);
    renderGroupView();
    renderGroupSchedule();
    openBracket();
    return;
  }

  // knockout
  const match=matchesData[currentMatchId];
  const wName = (winnerIdx===1)?document.getElementById('p1Name').innerText:document.getElementById('p2Name').innerText;
  const lName = (winnerIdx===1)?document.getElementById('p2Name').innerText:document.getElementById('p1Name').innerText;

  // âœ… å¦‚æœæ˜¯å­£è»è³½æœ¬èº«
  if(match.status === 'third'){
    alert(`å­£è»è³½çµæŸï¼\nğŸ¥‰ ç¬¬ä¸‰åï¼š${wName}\nç¬¬4åï¼š${lName}`);
    renderKnockoutSchedule();
    openBracket();
    setTimeout(drawConnectors,120);
    return;
  }

  // æ­£å¸¸æ™‰ç´šåˆ°ä¸‹ä¸€è¼ª
  if(match.nextMatchId!==null){
    const teamNum = (match.id%2===0)?1:2;
    setMatchName(match.nextMatchId, teamNum, wName);

    // âœ… æº–æ±ºè³½æ•—è€… â†’ é€å­£è»è³½
    // åˆ¤æ–·æº–æ±ºè³½ï¼šä¸‹ä¸€å ´å°±æ˜¯ Finalï¼ˆä¹Ÿå°±æ˜¯ nextMatchId çš„ round æ˜¯æœ€å¾Œä¸€è¼ªï¼‰
    if(window.__thirdPlace && window.__thirdPlace.semiIds.includes(match.id)){
      const thirdId = window.__thirdPlace.id;

      // å“ªä¸€é‚Šå¡«å…¥å­£è»è³½ï¼šä¾ç…§æ˜¯ç¬¬1å ´æº–æ±ºè³½æ”¾ team1ï¼Œç¬¬2å ´æº–æ±ºè³½æ”¾ team2
      const idx = window.__thirdPlace.semiIds.indexOf(match.id);
      const thirdTeamNum = (idx === 0) ? 1 : 2;

      setMatchName(thirdId, thirdTeamNum, lName);
    }

    alert(`æ­å–œ ${wName} æ™‰ç´šï¼`);
  } else {
    // Final match end
    alert(`ğŸ† å† è»è³½çµæŸï¼\nğŸ¥‡ å† è»ï¼š${wName}\nğŸ¥ˆ äºè»ï¼š${lName}`);
  }

  renderKnockoutSchedule();
  openBracket();
  setTimeout(drawConnectors,120);
}

function drawConnectors(){
  const svgL = document.getElementById('lines');
  const scroll = document.getElementById('scroll');
  if(!svgL || !scroll) return;

  // 1. å¼·åˆ¶è¨­å®š SVG å¯¬é«˜ç‚ºæ»¾å‹•å€åŸŸçš„ã€Œå®Œæ•´å…§å®¹ã€å¤§å°
  // é€™æ¨£ç„¡è«– 16äººæˆ– 128äººï¼Œç·šæ¢å±¤éƒ½èƒ½è¦†è“‹åˆ°æœ€å³å´èˆ‡æœ€ä¸‹æ–¹
  const fullWidth = scroll.scrollWidth;
  const fullHeight = scroll.scrollHeight;
  svgL.setAttribute('width', fullWidth);
  svgL.setAttribute('height', fullHeight);
  
  svgL.innerHTML = '';

  const rounds = Math.log2(TOTAL_PLAYERS) || 0;
  if(rounds < 1) return;

  // å–å¾— scroll å®¹å™¨ç›¸å°æ–¼è¦–çª—çš„åç§»ï¼Œç”¨ä¾†è¨ˆç®—ç›¸å°åº§æ¨™
  const sr = scroll.getBoundingClientRect();

  Object.values(matchesData).forEach(m => {
    if(m.nextMatchId === null) return;
    const from = document.getElementById(`match-${m.id}`);
    const to = document.getElementById(`match-${m.nextMatchId}`);
    if(!from || !to) return;

    const fr = from.getBoundingClientRect();
    const tr = to.getBoundingClientRect();

    // 2. è¨ˆç®—åº§æ¨™æ™‚ï¼ŒåŠ ä¸Šå®¹å™¨ç›®å‰çš„æ»¾å‹•è·é›¢ (scrollLeft/scrollTop)
    // é€™æ¨£åœ¨å¤§å°ºå¯¸è³½ç¨‹è¡¨ä¸­ï¼Œå³ä½¿å·¦å³æ²å‹•ï¼Œç·šæ¢ä¹Ÿæœƒåœ¨æ­£ç¢ºçš„ä½ç½®
    const x1 = fr.right - sr.left + scroll.scrollLeft;
    const y1 = (fr.top + fr.bottom) / 2 - sr.top + scroll.scrollTop;
    const x2 = tr.left - sr.left + scroll.scrollLeft;
    const y2 = (tr.top + tr.bottom) / 2 - sr.top + scroll.scrollTop;

    const midx = (x1 + x2) / 2;
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute('class', 'connector');
    // ä½¿ç”¨ç›´è§’ç·šé€£æ¥
    path.setAttribute('d', `M ${x1} ${y1} L ${midx} ${y1} L ${midx} ${y2} L ${x2} ${y2}`);
    svgL.appendChild(path);
  });
}

function updateMatchTime(type,id,v){
  if(type==='G'){
    const m=groupMatches.find(x=>x.id===id);
    if(m) m.time=v;
  }else{
    const mid=parseInt(id,10);
    if(matchesData[mid]) matchesData[mid].time=v;
  }
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g,(c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/* ========= Init ========= */
/* ========= Init ========= */
	window.addEventListener('load', ()=>{
	  createBoard();
	  syncBars();        // âœ… å†æ§åˆ¶é¡¯ç¤ºç‹€æ…‹
	  initBracket();     // âœ… å»ºç«‹è³½ç¨‹
	  resetMatch();      // âœ… åˆå§‹åŒ–è¨ˆåˆ†æ¿

	  // âœ… éœ€è¦å°±é–‹è³½ç¨‹è¦–çª—ï¼Œä¸éœ€è¦å°±è¨»è§£æ‰
	  openBracket(); 
	});
    // å¼·åˆ¶è§£é–ä¸¦é‡æ–°ç¶å®šæ±ºè³½æŒ‰éˆ•
    const btnBracket = document.getElementById('tabFinalBracket');
    if (btnBracket) {
        btnBracket.onclick = function() { initFinalsFramework(); };
        btnBracket.style.display = "block"; // å¼·åˆ¶é¡¯ç¤º
    }

    const btnSch = document.getElementById('tabFinalSch');
    if (btnSch) {
        btnSch.onclick = function() { showFinalsView('schedule'); };
        btnSch.style.display = "block"; // å¼·åˆ¶é¡¯ç¤º
    }

/* ============================================================
   æ±ºè³½ç¨ç«‹æ¨¡çµ„ï¼šå–®æ·˜æ±°è³½æ¨¹ç‹€åœ–æ¡†æ¶
   ============================================================ */

// 1. åˆå§‹åŒ–æ±ºè³½æ¡†æ¶ (ç›®å‰å›ºå®šç‚º 8äººå–®æ·˜æ±°ä½œç‚ºç¯„ä¾‹)
function initFinalsFramework() {
    const keys = Object.keys(groupsData).sort();
    const numGroups = keys.length;
    
    // è¨ˆç®—æ±ºè³½äººæ•¸
    let finalSize = Math.max(4, numGroups * 2); 
    finalSize = Math.pow(2, Math.ceil(Math.log2(finalSize)));

    TOTAL_PLAYERS = finalSize;
    currentStage = 'final';

    // 1. ç¹ªè£½æ¨¹ç‹€åœ–
    renderKnockoutBracket(true);

    // 2. åŸ·è¡Œå…¨è‡ªå‹•å¡«å (åŒ…å« A1, B2 ä»£è™Ÿé‚è¼¯)
    autoLinkGroupResults();

    // 3. é¡¯ç¤ºè¦–åœ–èˆ‡ç•«ç·š
    showFinalsView('bracket');
}

// 2. å°ˆå±¬è¦–åœ–åˆ‡æ› (è§£æ±ºå°å‘éŒ¯èª¤å•é¡Œ)
function showFinalsView(sub) {
    // 1. éš±è—æ‰€æœ‰ä¸»è¦å…§å®¹å€å¡Š
    const views = ['groupView', 'groupSchedule', 'bracketView', 'knockSchedule'];
    views.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // 2. æ ¸å¿ƒä¿®æ­£ï¼šéš±è—ã€Œé è³½è¦å‰‡åˆ—ã€èˆ‡ã€Œå…¨åŸŸæ±ºè³½è¦å‰‡åˆ—ã€
    // ç•¶é€²å…¥æ±ºè³½è³½ç¨‹è¡¨æˆ–æ±ºè³½æ™‚é–“è¡¨æ™‚ï¼Œé€™äº›éƒ½ä¸éœ€è¦å‡ºç¾
    const gRules = document.getElementById('groupRules');
    const fRules = document.getElementById('finalRules');
    const returnBtn = document.querySelector('.btn-return'); // é †ä¾¿è™•ç†æ‰é‚£å€‹è¿”å›æŒ‰éˆ• (å¦‚æœæœ‰çš„è©±)

    if (gRules) gRules.style.display = 'none';
    if (fRules) fRules.style.display = 'none';
    if (returnBtn) returnBtn.style.display = 'none';

    if (document.getElementById('lines')) document.getElementById('lines').style.display = 'none';

    // 3. æ ¹æ“šå­é é¢é¡¯ç¤ºå…§å®¹
    if (sub === 'bracket') {
        document.getElementById('bracketView').style.display = 'flex';
        document.getElementById('lines').style.display = 'block';
        updateTabActive('tabFinalBracket');
        setTimeout(drawConnectors, 150);
    } else if (sub === 'schedule') {
        document.getElementById('knockSchedule').style.display = 'flex';
        updateTabActive('tabFinalSch');
    }
}

// 3. è‡ªå‹•é€£å‹•é è³½åå–® (å…¨è‡ªå‹•åˆ†å€ç‰ˆï¼šæ”¯æ´ 2, 4, 8, 16 çµ„ä»¥ä¸Š)
function autoLinkGroupResults() {
    const keys = Object.keys(groupsData).sort(); // ['A', 'B', 'C'..., 'P']
    const numGroups = keys.length;
    
    // 1. ç”Ÿæˆåˆ†å€å°ä½åºåˆ— (æ ¸å¿ƒç®—æ³•)
    // ç›®çš„ï¼šç¢ºä¿ç¬¬ i çµ„çš„ç¬¬ 1 åå°ä¸Šã€Œé ç«¯çµ„ã€çš„ç¬¬ 2 å
    // ä¾‹å¦‚ 16 çµ„æ™‚ï¼šA1 vs P2, B1 vs O2...
    let pattern = [];
    for (let i = 0; i < numGroups; i++) {
        // ä¸ŠåŠéƒ¨å°ä½é‚è¼¯ï¼šç¬¬ i çµ„ç¬¬ 1 å vs å€’æ•¸ç¬¬ i çµ„ç¬¬ 2 å
        // ä¸‹åŠéƒ¨å°ä½é‚è¼¯ï¼šå€’æ•¸ç¬¬ i çµ„ç¬¬ 1 å vs ç¬¬ i çµ„ç¬¬ 2 å
        // é€™æ¨£èƒ½å®Œç¾å¯¦ç¾æ‚¨è¦æ±‚çš„ã€Œåˆ†å€éš”é›¢ã€
        if (i < numGroups / 2) {
            // ä¸ŠåŠå€å ´æ¬¡
            pattern.push([i, 1]);              // çµ„åˆ¥ç´¢å¼•, åæ¬¡
            pattern.push([numGroups - 1 - i, 2]);
        } else {
            // ä¸‹åŠå€å ´æ¬¡
            let idx = i - (numGroups / 2);
            pattern.push([numGroups - 1 - idx, 1]);
            pattern.push([idx, 2]);
        }
    }

    // 2. ä¾ç…§ç”¢ç”Ÿçš„ pattern åŸ·è¡Œå¡«å
    // æ¯å…©å€‹ä¸€çµ„å¡«å…¥ä¸€å€‹ Match
    for (let i = 0; i < pattern.length * 2; i += 2) {
        const mId = Math.floor(i / 2);
        const p1Info = pattern[i];   
        const p2Info = pattern[i + 1];

        if (!p1Info || !p2Info) break;

        const name1 = getSmartName(keys[p1Info[0]], p1Info[1]);
        const name2 = getSmartName(keys[p2Info[0]], p2Info[1]);

        setMatchName(mId, 1, name1);
        setMatchName(mId, 2, name2);
    }
}

// æ™ºæ…§åç¨±åˆ¤æ–·ï¼šç¢ºä¿ A1, B2 ç­‰æ¨™ç±¤åœ¨ 64 äººæ¨¡å¼ä¸‹ä¹Ÿèƒ½å‡ºç¾
function getSmartName(groupKey, rank) {
    if (!groupKey) return "";
    const group = groupsData[groupKey];
    
    // å¦‚æœé€£çµ„åˆ¥è³‡æ–™éƒ½é‚„æ²’åˆå§‹åŒ–ï¼Œç›´æ¥å›å‚³æ¨™ç±¤
    if (!group) return `${groupKey}${rank}`;

    // æ’åºè©²çµ„åæ¬¡ (å‹å ´ > è…¿å·®)
    const ranked = [...group].sort((a, b) => (b.wins - a.wins) || (b.legsDiff - a.legsDiff));
    const target = ranked[rank - 1];

    // åˆ¤å®šï¼šå¦‚æœæœ‰æˆç¸¾å‰‡é¡¯ç¤ºäººåï¼Œå¦å‰‡é¡¯ç¤ºä»£è™Ÿ (å¦‚ P2)
    if (target && target.wins > 0) {
        return target.name;
    }
    return `${groupKey}${rank}`;
}

// è¼”åŠ©ï¼šæ›´æ–°æ¨™ç±¤ç‹€æ…‹
function updateTabActive(activeId) {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.remove('active'));
    const activeTab = document.getElementById(activeId);
    if (activeTab) activeTab.classList.add('active');
}

</script>
</body>
</html>

