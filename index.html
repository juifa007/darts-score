<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¡¬é¶å°ˆæ¥­è¨˜åˆ†æ¿ V25 (ä¿®æ­£é€£ç·šèˆ‡Boé¸å–®)</title>
    <style>
        /* === V25 æ¨£å¼ === */
        :root {
            --bg-color: #eef2f5; --panel-bg: #ffffff; --left-bg: #dfe4ea;
            --text-main: #1a1a1a; --text-sub: #555555;
            --p1-color: #007bff; --p2-color: #dc3545; 
            --line-color: #555; /* ç·šæ¢æ”¹æ·±ä¸€é»æ¯”è¼ƒæ¸…æ¥š */
            --line-width: 1.5px; /* ç·šæ¢ç´°ä¸€é»æ¯”è¼ƒç²¾ç·» */
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; overflow: hidden; background-color: var(--bg-color); }
        body { display: flex; flex-direction: column; }
        #main-container { flex: 1; display: flex; height: 100%; overflow: hidden; }
        #left-panel { flex: 6; display: flex; justify-content: center; align-items: center; background: var(--left-bg); border-right: 1px solid #ccc; position: relative; }
        #right-panel { flex: 4; background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.05); z-index: 10; overflow-y: auto; }

        /* UI */
        #bracket-btn { width: 100%; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
        .player-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 10px; margin-bottom: 12px; opacity: 0.7; transition: all 0.2s; }
        .player-card.active { opacity: 1; background: #fff; border-width: 3px; transform: scale(1.01); }
        .player-card.active-p1 { border-color: var(--p1-color); } .player-card.active-p2 { border-color: var(--p2-color); }
        .player-name { font-size: 1.4rem; font-weight: 900; }
        .score-big { font-size: 4.5rem; font-weight: 900; text-align: right; line-height: 1; }
        
        /* è³½ç¨‹è¡¨è¦–çª— */
        #bracket-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f0f2f5; z-index: 200; display: none; flex-direction: column; }
        #bracket-header { height: 60px; background: #fff; border-bottom: 1px solid #ccc; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        #bracket-content { flex: 1; overflow: auto; position: relative; background: #f8f9fa; }
        
        /* å…§å®¹å±¤èˆ‡ SVG */
        #bracket-scroll-view { position: relative; width: max-content; height: max-content; padding: 40px; }
        #bracket-lines { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; }
        
        /* V25: ä¿®æ­£ç·šæ¢æ¨£å¼ï¼Œä½¿ç”¨ crispEdges é¿å…æ¨¡ç³Š */
        .connector-path { fill: none; stroke: var(--line-color); stroke-width: var(--line-width); shape-rendering: crispEdges; }

        /* è³½ç¨‹å®¹å™¨ */
        .bracket-container { display: flex; gap: 80px; /* å¢åŠ é–“è·è®“ç·šæ¢æ›´å¥½çœ‹ */ position: relative; z-index: 2; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; min-width: 180px; padding-top: 50px; position: relative; }
        
        /* V25: æ¨™é¡Œèˆ‡ Bo é¸å–® */
        .round-header { position: absolute; top: 0; width: 100%; text-align: center; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .round-title { font-weight: bold; color: #555; font-size: 1rem; }
        .format-select { padding: 2px 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.8rem; color: #007bff; font-weight: bold; cursor: pointer; background: #fff; }

        .match-card {
            background: #fff; border: 1px solid #ccc; border-radius: 6px;
            width: 180px; padding: 8px; margin: 10px 0; 
            cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 90px;
        }
        .match-card:hover { border-color: #007bff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.2); }
        .match-label { font-size: 0.75rem; color: #007bff; font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .bracket-input { width: 95%; border: none; border-bottom: 1px solid #eee; font-size: 0.9rem; padding: 2px; text-align: center; background: transparent; }
        .bracket-input:focus { outline: none; border-bottom: 2px solid #007bff; background: #f0f8ff; }
        .vs-text { font-size: 0.7rem; color: #ccc; text-align: center; margin: 2px 0; }

        /* ç·Šæ¹Šæ¨¡å¼ (64/128äºº) */
        .compact-mode .match-card { height: 50px; margin: 6px 0; padding: 4px 8px; width: 160px; }
        .compact-mode .bracket-input { font-size: 0.8rem; border-bottom: none; text-align: left; }
        .compact-mode .vs-text { display: none; }
        .compact-mode .match-label { font-size: 0.65rem; margin-bottom: 0; }
        .compact-mode .load-badge { display: none; } /* çœç©ºé–“ */

        .load-badge { background: #007bff; color: white; padding: 1px 4px; border-radius: 3px; font-size: 0.6rem; }
        #size-selector { padding: 5px; font-size: 1rem; border: 2px solid #007bff; border-radius: 5px; color: #007bff; font-weight: bold; }

        /* Darts Board CSS */
        svg#dartboard { max-width: 90%; max-height: 90%; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); }
        .area-black { fill: #212529; stroke: #6c757d; } .area-white { fill: #f8f9fa; stroke: #6c757d; }
        .area-red { fill: #e02e42; stroke: #6c757d; } .area-green { fill: #26a65b; stroke: #6c757d; }
    </style>
</head>
<body>

    <div id="bracket-modal">
        <div id="bracket-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <select id="size-selector" onchange="changeBracketSize()">
                    <option value="4">4äºº (Semi)</option>
                    <option value="8" selected>8äºº (Quarter)</option>
                    <option value="16">16äºº (Last 16)</option>
                    <option value="32">32äºº (Last 32)</option>
                    <option value="64">64äºº (ç·Šæ¹Š)</option>
                    <option value="128">128äºº (è¶…ç·Šæ¹Š)</option>
                </select>
                <span style="font-weight:bold; color:#555;">è³½ç¨‹è¡¨</span>
            </div>
            <button id="close-bracket" onclick="closeBracket()" style="padding:5px 15px; cursor:pointer;">é—œé–‰</button>
        </div>
        
        <div id="bracket-content">
            <div id="bracket-scroll-view">
                <svg id="bracket-lines"></svg>
                <div id="bracket-container" class="bracket-container"></div>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="left-panel">
            <svg id="dartboard" viewBox="-250 -250 500 500"></svg>
            <div id="board-overlay">
                <div class="overlay-text">è«‹æ ¸å°åˆ†æ•¸</div>
                <div style="font-size:1.2rem; color:#555; font-weight:bold; margin-top:10px;">ä¸¦æŒ‰ä¸‹æ›äººéµ</div>
            </div>
        </div>
        <div id="right-panel">
            <button id="bracket-btn" onclick="openBracket()">è³½ç¨‹è¡¨ / è¼¸å…¥åå–®</button>
            <div class="player-card active active-p1" id="p1-card">
                <div class="turn-indicator">ğŸ‘‰</div>
                <div class="player-header"><div class="player-name" id="p1-name">Player 1</div></div>
                <div class="score-big" id="p1-score">501</div>
                <div class="round-display">Legs: <span id="p1-legs">0</span></div>
            </div>
            <div class="player-card" id="p2-card">
                <div class="turn-indicator">ğŸ‘‰</div>
                <div class="player-header"><div class="player-name" id="p2-name">Player 2</div></div>
                <div class="score-big" id="p2-score">501</div>
                <div class="round-display">Legs: <span id="p2-legs">0</span></div>
            </div>
            <div id="control-panel">
                <button id="btn-undo" onclick="undoLastDart()">å¾©åŸ</button>
                <button id="btn-next" onclick="switchPlayer()">æ›ä¸‹ä¸€ä½ (NEXT)</button>
            </div>
        </div>
    </div>

<script>
    let TOTAL_PLAYERS = 8;
    let matchesData = {};

    function changeBracketSize() {
        const val = document.getElementById('size-selector').value;
        TOTAL_PLAYERS = parseInt(val);
        const container = document.getElementById('bracket-container');
        if(TOTAL_PLAYERS >= 64) container.classList.add('compact-mode');
        else container.classList.remove('compact-mode');
        
        if(confirm(`ç¢ºå®šåˆ‡æ›ç‚º ${TOTAL_PLAYERS} äººåˆ¶ï¼Ÿ(è³½ç¨‹å°‡é‡ç½®)`)) {
            initBracketStructure();
        }
    }

    function initBracketStructure() {
        const container = document.getElementById('bracket-container');
        container.innerHTML = '';
        matchesData = {};

        const totalRounds = Math.log2(TOTAL_PLAYERS);
        let matchCounter = 0;
        let matchesInRound = TOTAL_PLAYERS / 2;

        for (let r = 0; r < totalRounds; r++) {
            const roundDiv = document.createElement('div');
            roundDiv.className = 'round-column';
            roundDiv.id = `round-${r}`;
            
            // === V25 ä¿®æ­£ï¼šæ‰¾å› Bo é¸å–® ===
            const header = document.createElement('div');
            header.className = 'round-header';
            let titleText = (r === totalRounds - 1) ? "Final" : `Round ${r+1}`;
            
            // é è¨­ Bo
            let defaultBo = 3;
            if (r === totalRounds - 1) defaultBo = 7; 
            else if (r > 0) defaultBo = 5;

            header.innerHTML = `
                <div class="round-title">${titleText}</div>
                <select id="fmt-r${r}" class="format-select">
                    <option value="1" ${defaultBo===1?'selected':''}>Bo1</option>
                    <option value="3" ${defaultBo===3?'selected':''}>Bo3</option>
                    <option value="5" ${defaultBo===5?'selected':''}>Bo5</option>
                    <option value="7" ${defaultBo===7?'selected':''}>Bo7</option>
                    <option value="9" ${defaultBo===9?'selected':''}>Bo9</option>
                </select>
            `;
            roundDiv.appendChild(header);

            for (let i = 0; i < matchesInRound; i++) {
                const mid = matchCounter++;
                const isFirstRound = (r === 0);
                
                matchesData[mid] = { id: mid, round: r, p1: isFirstRound?`P${mid*2+1}`:"", p2: isFirstRound?`P${mid*2+2}`:"", nextMatchId: null };

                const card = document.createElement('div');
                card.className = 'match-card';
                card.id = `match-card-${mid}`;
                card.onclick = () => selectMatch(mid);
                
                card.innerHTML = `
                    <div class="match-label">M${mid+1} <span class="load-badge">LOAD</span></div>
                    <input id="m${mid}-p1" class="bracket-input" value="${matchesData[mid].p1}" placeholder="${isFirstRound?'è¼ªç©ºå¡«Bye':'Win'}" ${isFirstRound?'':'readonly'} onclick="event.stopPropagation()">
                    <div class="vs-text">VS</div>
                    <input id="m${mid}-p2" class="bracket-input" value="${matchesData[mid].p2}" placeholder="${isFirstRound?'è¼ªç©ºå¡«Bye':'Win'}" ${isFirstRound?'':'readonly'} onclick="event.stopPropagation()">
                `;
                roundDiv.appendChild(card);
            }
            container.appendChild(roundDiv);
            matchesInRound /= 2;
        }

        // å»ºç«‹æ™‰ç´šé—œè¯
        let currentStartId = 0;
        let currentCount = TOTAL_PLAYERS / 2;
        for (let r = 0; r < totalRounds - 1; r++) {
            const nextRoundStartId = currentStartId + currentCount;
            for (let i = 0; i < currentCount; i++) {
                const currentId = currentStartId + i;
                const targetId = nextRoundStartId + Math.floor(i / 2);
                matchesData[currentId].nextMatchId = targetId;
            }
            currentStartId += currentCount;
            currentCount /= 2;
        }

        setTimeout(drawConnectors, 200);
    }

    // === V25 ä¿®æ­£ï¼šåƒç´ ç´šå°é½Šç•«ç·š ===
    function drawConnectors() {
        const svg = document.getElementById('bracket-lines');
        const scrollView = document.getElementById('bracket-scroll-view');
        
        svg.style.width = scrollView.scrollWidth + "px";
        svg.style.height = scrollView.scrollHeight + "px";
        svg.innerHTML = ''; 

        const rootRect = scrollView.getBoundingClientRect();

        for (let key in matchesData) {
            const match = matchesData[key];
            if (match.nextMatchId !== null) {
                const currEl = document.getElementById(`match-card-${match.id}`);
                const nextEl = document.getElementById(`match-card-${match.nextMatchId}`);
                
                if (currEl && nextEl) {
                    const cRect = currEl.getBoundingClientRect();
                    const nRect = nextEl.getBoundingClientRect();

                    // === V25 åº§æ¨™æ•´æ•¸åŒ– (Math.round) é¿å…æ¨¡ç³Š ===
                    // Start: ç•¶å‰å¡ç‰‡çš„å³é‚Šä¸­é–“
                    const startX = Math.round((cRect.left - rootRect.left) + cRect.width);
                    const startY = Math.round((cRect.top - rootRect.top) + cRect.height / 2);
                    
                    // End: ä¸‹ä¸€å¼µå¡ç‰‡çš„å·¦é‚Šä¸­é–“
                    const endX = Math.round(nRect.left - rootRect.left);
                    const endY = Math.round((nRect.top - rootRect.top) + nRect.height / 2);

                    // Mid: å…©è€…ä¸­é–“
                    const midX = Math.round(startX + (endX - startX) / 2);
                    
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    // ç¹ªè£½ M -> H -> V -> H è·¯å¾‘
                    const d = `M ${startX} ${startY} H ${midX} V ${endY} H ${endX}`;
                    path.setAttribute("d", d);
                    path.setAttribute("class", "connector-path");
                    svg.appendChild(path);
                }
            }
        }
    }

    window.onresize = drawConnectors;

    function openBracket() { 
        document.getElementById('bracket-modal').style.display = 'flex'; 
        if(Object.keys(matchesData).length === 0) initBracketStructure(); 
        setTimeout(drawConnectors, 100); 
    }
    function closeBracket() { document.getElementById('bracket-modal').style.display = 'none'; }

    let currentMatchId = null;
    let targetLegs = 3;

    function selectMatch(mid) {
        const p1Input = document.getElementById(`m${mid}-p1`);
        const p2Input = document.getElementById(`m${mid}-p2`);
        const p1Val = p1Input ? p1Input.value.trim() : "";
        const p2Val = p2Input ? p2Input.value.trim() : "";
        
        matchesData[mid].p1 = p1Val;
        matchesData[mid].p2 = p2Val;

        const match = matchesData[mid];
        const fmtSelect = document.getElementById(`fmt-r${match.round}`);
        const legsNeeded = Math.ceil(parseInt(fmtSelect.value) / 2);

        const checkBye = (n) => n.toLowerCase()==='bye' || n==='è¼ªç©º' || n==='';
        if(checkBye(p2Val) && !checkBye(p1Val)) { advanceWinnerByForce(mid, p1Val); return; }
        if(checkBye(p1Val) && !checkBye(p2Val)) { advanceWinnerByForce(mid, p2Val); return; }

        if(confirm(`è¼‰å…¥ Match ${mid+1} (${p1Val} vs ${p2Val})?\nè³½åˆ¶: æ¶ ${legsNeeded} å‹`)) {
            currentMatchId = mid;
            targetLegs = legsNeeded;
            document.getElementById('p1-name').innerHTML = `${p1Val} <span class="leg-badge">å…ˆæ”»</span>`;
            document.getElementById('p2-name').innerHTML = `${p2Val} <span class="leg-badge">å…ˆæ”»</span>`;
            resetGame();
            closeBracket();
        }
    }

    function advanceWinnerByForce(mid, wName) {
        const match = matchesData[mid];
        if (match.nextMatchId !== null) {
            const slot = (match.id % 2 === 0) ? 'p1' : 'p2';
            const el = document.getElementById(`m${match.nextMatchId}-${slot}`);
            if(el) { el.value = wName; matchesData[match.nextMatchId][slot] = wName; }
            alert(`${wName} è¼ªç©ºæ™‰ç´šï¼`);
        }
    }

    function advanceWinner(winnerIdx) {
        if(currentMatchId===null) return;
        const match = matchesData[currentMatchId];
        const wName = (winnerIdx===1) ? document.getElementById('p1-name').innerText.split('\n')[0] : document.getElementById('p2-name').innerText.split('\n')[0];
        
        if (match.nextMatchId !== null) {
            const slot = (match.id % 2 === 0) ? 'p1' : 'p2';
            const el = document.getElementById(`m${match.nextMatchId}-${slot}`);
            if(el) { el.value = wName; matchesData[match.nextMatchId][slot] = wName; }
            alert(`æ­å–œ ${wName} æ™‰ç´šï¼`);
        } else {
            alert(`æ­å–œ ${wName} ç²å¾—ç¸½å† è»ï¼`);
        }
    }

    // === Game Logic ===
    const GAME_MODE = 501;
    let currentPlayer = 1, legStarter = 1, turnDarts = 0, isBoardLocked = false;
    let players = { 1: { score: GAME_MODE, legs: 0, roundHistory: [] }, 2: { score: GAME_MODE, legs: 0, roundHistory: [] } };
    let throwHistory = [];

    window.onload = function() { createBoard(); initBracketStructure(); };

    function handleHit(e) {
        if (isBoardLocked) return;
        const scoreHit = parseInt(e.target.getAttribute("data-score"));
        const p = players[currentPlayer];
        if (p.score - scoreHit < 0 || p.score - scoreHit === 1) { alert("çˆ†é¢!"); lockBoard(); return; }
        p.score -= scoreHit; turnDarts++;
        let h = { score: scoreHit, player: currentPlayer, turnIndex: turnDarts };
        p.roundHistory.push(h); throwHistory.push(h);
        updateUI();
        if (p.score === 0) { setTimeout(() => { alert("Wins Leg!"); handleLegWin(currentPlayer); }, 100); return; }
        if (turnDarts >= 3) lockBoard();
    }

    function handleLegWin(winner) {
        players[winner].legs++;
        if(players[winner].legs >= targetLegs) { alert("Match Shot!"); advanceWinner(winner); }
        legStarter = (winner===1)?2:1; currentPlayer = legStarter;
        players[1].score = GAME_MODE; players[2].score = GAME_MODE;
        players[1].roundHistory = []; players[2].roundHistory = [];
        throwHistory = []; turnDarts = 0; isBoardLocked = false;
        updateUI(); updateActiveCard();
    }

    function resetGame() {
        players[1].score = GAME_MODE; players[2].score = GAME_MODE;
        players[1].legs = 0; players[2].legs = 0;
        players[1].roundHistory = []; players[2].roundHistory = [];
        throwHistory = []; turnDarts = 0; isBoardLocked = false;
        currentPlayer = 1; legStarter = 1;
        updateUI(); updateActiveCard();
    }

    function switchPlayer() { isBoardLocked = false; turnDarts = 0; players[currentPlayer].roundHistory = []; currentPlayer = (currentPlayer===1)?2:1; updateUI(); updateActiveCard(); }
    function undoLastDart() { if(throwHistory.length===0) return; const last=throwHistory.pop(); if(last.player!==currentPlayer){alert("ç„¡æ³•å¾©åŸ");return;} players[currentPlayer].score+=last.score; players[currentPlayer].roundHistory.pop(); turnDarts--; isBoardLocked=false; updateUI(); }
    function updateUI() { document.getElementById('p1-score').innerText = players[1].score; document.getElementById('p2-score').innerText = players[2].score; document.getElementById('p1-legs').innerText = players[1].legs; document.getElementById('p2-legs').innerText = players[2].legs; if(isBoardLocked) { document.getElementById('btn-next').classList.add('ready'); } else { document.getElementById('btn-next').classList.remove('ready'); } }
    function updateActiveCard() { document.getElementById('p1-card').classList.remove('active', 'active-p1'); document.getElementById('p2-card').classList.remove('active', 'active-p2'); document.getElementById(`p${currentPlayer}-card`).classList.add('active', `active-p${currentPlayer}`); }
    function lockBoard() { isBoardLocked = true; updateUI(); }

    const svg = document.getElementById('dartboard');
    const SECTORS = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
    function createBoard() {
        const sectorAngle = 360 / 20;
        SECTORS.forEach((score, i) => {
            const start = (i * sectorAngle) - 90 - (sectorAngle/2);
            const end = start + sectorAngle;
            const isEven = i % 2 === 0;
            drawSector(start, end, 160, 195, isEven?'area-red':'area-green', score*2);
            drawSector(start, end, 110, 160, isEven?'area-black':'area-white', score);
            drawSector(start, end, 80, 110, isEven?'area-red':'area-green', score*3);
            drawSector(start, end, 25, 80, isEven?'area-black':'area-white', score);
            drawLabel(start + sectorAngle/2, 220, score);
        });
        drawCircle(25, 'area-green', 25); drawCircle(12, 'area-red', 50);
        updateUI(); updateActiveCard();
    }
    function drawSector(s, e, ir, or, cls, val) {
        const r1=s*Math.PI/180, r2=e*Math.PI/180;
        const x1=ir*Math.cos(r1), y1=ir*Math.sin(r1), x2=or*Math.cos(r1), y2=or*Math.sin(r1);
        const x3=or*Math.cos(r2), y3=or*Math.sin(r2), x4=ir*Math.cos(r2), y4=ir*Math.sin(r2);
        const d = `M${x1} ${y1}L${x2} ${y2}A${or} ${or} 0 0 1 ${x3} ${y3}L${x4} ${y4}A${ir} ${ir} 0 0 0 ${x1} ${y1}Z`;
        const p = document.createElementNS("http://www.w3.org/2000/svg","path");
        p.setAttribute("d",d); p.setAttribute("class",cls); p.setAttribute("data-score",val);
        p.addEventListener('click', handleHit); svg.appendChild(p);
    }
    function drawCircle(r, cls, val) {
        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx",0); c.setAttribute("cy",0); c.setAttribute("r",r); c.setAttribute("class",cls); c.setAttribute("data-score",val);
        c.addEventListener('click', (e)=>{e.stopPropagation(); handleHit(e);}); svg.appendChild(c);
    }
    function drawLabel(angle, r, text) {
        const rad = angle * Math.PI / 180;
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", r*Math.cos(rad)); t.setAttribute("y", r*Math.sin(rad));
        t.setAttribute("class", "text-label"); t.textContent = text; svg.appendChild(t);
    }
</script>
</body>
</html>
