<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á°¨Èù∂Â∞àÊ•≠Ë®òÂàÜÊùø V60 (ÊéíÁâàÁµÇÊ•µ‰øÆÂæ©Áâà)</title>
    <style>
        /* === Âü∫Á§éÊ®£Âºè === */
        :root {
            --bg-color: #eef2f5; --panel-bg: #ffffff; --left-bg: #dfe4ea;
            --text-main: #1a1a1a; --text-sub: #555555;
            --p1-color: #007bff; --p2-color: #dc3545; 
            --line-color: #555; --line-width: 1.5px;
        }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; background-color: var(--bg-color); }
        body { display: flex; flex-direction: column; }
        
        #main-container { flex: 1; display: flex; height: 100%; overflow: hidden; }
        #left-panel { flex: 6; display: flex; justify-content: center; align-items: center; background: var(--left-bg); border-right: 1px solid #ccc; position: relative; }
        #right-panel { flex: 4; background: var(--panel-bg); padding: 15px; display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.05); z-index: 10; overflow-y: auto; }

        /* UI ÂÖÉ‰ª∂ */
        #bracket-btn { width: 100%; padding: 12px; margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
        .player-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 10px; margin-bottom: 12px; opacity: 0.7; transition: all 0.2s; position: relative; }
        .player-card.active { opacity: 1; background: #fff; border-width: 3px; transform: scale(1.01); }
        .player-card.active-p1 { border-color: var(--p1-color); } .player-card.active-p2 { border-color: var(--p2-color); }
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .player-name { font-size: 1.3rem; font-weight: 900; white-space: pre-wrap; line-height: 1.2; word-break: break-word; }
        .turn-indicator { font-size: 1.5rem; visibility: hidden; }
        .active .turn-indicator { visibility: visible; }
        
        .dart-slots { display: flex; gap: 5px; margin-bottom: 5px; height: 30px; }
        .dart-slot { flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; font-size: 1rem; }
        .dart-slot.filled { color: #000; border-color: #333; background: #e9ecef; }
        .dart-slot.miss { color: #dc3545; background: #fff0f0; border-color: #dc3545; }
        .score-big { font-size: 4.5rem; font-weight: 900; text-align: right; line-height: 1; margin: 5px 0; }
        .round-display { font-size: 1.1rem; font-weight: bold; color: #666; text-align: right; display: flex; justify-content: space-between; align-items: center; padding-top: 5px; border-top: 1px solid #eee; }
        
        .stat-badge { background: #e9ecef; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; color: #555; }
        .active .stat-badge { background: #343a40; color: #fff; }

        .turn-score-box { text-align: center; font-size: 1.4rem; font-weight: 900; margin: 8px 0; padding: 5px; background: #f1f3f5; border-radius: 8px; color: #adb5bd; border: 2px dashed #dee2e6; }
        .active .turn-score-box { background: #e7f5ff; color: #007bff; border: 2px solid #007bff; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .active-p2.active .turn-score-box { background: #fff5f5; color: #dc3545; border-color: #dc3545; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .checkout-hint { font-size: 0.9rem; color: #28a745; font-weight: bold; text-align: right; min-height: 1.2em; }

        #control-panel { height: 60px; display: grid; grid-template-columns: 1fr 2.5fr; gap: 12px; margin-top: auto; }
        button { border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        button:active { transform: translateY(4px); box-shadow: none; }
        #btn-undo { background: #fff; color: #495057; border: 2px solid #ced4da; }
        #btn-next { background: #007bff; color: #fff; opacity: 0.5; pointer-events: none; }
        #btn-next.ready { opacity: 1; pointer-events: all; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        #btn-miss-trigger { position: absolute; bottom: 20px; left: 20px; z-index: 50; background: #dc3545; color: white; width: 80px; height: 80px; border-radius: 50%; font-size: 1rem; font-weight: 900; box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid white; }
        #btn-miss-trigger:active { transform: scale(0.95); }
        #board-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.85); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .overlay-text { color: #000; font-size: 2.5rem; font-weight: 900; }

        /* === Ë≥ΩÁ®ãË¶ñÁ™óËàáÂàÜÈ†Å === */
        #bracket-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f0f2f5; z-index: 200; display: none; flex-direction: column; }
        #bracket-header { height: 100px; background: #fff; border-bottom: 1px solid #ccc; display: flex; flex-direction: column; }
        .header-top { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; }
        .header-tabs { height: 50px; display: flex; gap: 10px; padding: 0 20px; align-items: center; background: #f8f9fa; }
        .view-tab { padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; border: 1px solid transparent; color: #666; transition: all 0.2s; }
        .view-tab.active-tab { background: #007bff; color: white; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        .view-tab:hover:not(.active-tab) { background: #e9ecef; }
        
        #bracket-content { flex: 1; overflow: auto; position: relative; background: #f8f9fa; }
        
        /* ÂÆπÂô®ÊéíÁâàÊéßÂà∂ (ÈóúÈçµ‰øÆÊ≠£) */
        #bracket-scroll-view { position: relative; padding: 40px; box-sizing: border-box; }
        
        /* ÂñÆÊ∑òÊ±∞ÔºöÊ∞¥Âπ≥ÊéíÂàó (Flex) - ÈÅ©Áî®Êñº Canvas Ê®°Âºè */
        .layout-canvas #bracket-scroll-view { width: max-content; height: max-content; }
        .layout-canvas .bracket-container { display: flex; gap: 80px; }

        /* Âæ™Áí∞Ë≥ΩÔºöÁ∂≤Ê†ºÊéíÂàó (Block) - ÈÅ©Áî®Êñº Grid Ê®°Âºè */
        .layout-grid #bracket-scroll-view { width: 100%; height: auto; }
        .layout-grid .bracket-container { display: block; width: 100%; } /* V60 ‰øÆÂæ©ÔºöÂº∑Âà∂ÂçÄÂ°äÈ°ØÁ§∫ */

        .view-section { display: none; }
        .view-section.active-view { display: block; }

        #bracket-lines { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1; }
        .connector-path { fill: none; stroke: var(--line-color); stroke-width: var(--line-width); shape-rendering: crispEdges; }
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .control-select { padding: 5px; font-size: 0.9rem; border: 2px solid #007bff; border-radius: 5px; color: #007bff; font-weight: bold; cursor: pointer; }

        /* ÂñÆÊ∑òÊ±∞ÂÖÉ‰ª∂ */
        .bracket-container { position: relative; z-index: 2; margin-bottom: 40px; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; padding-top: 50px; position: relative; }
        .round-header { position: absolute; top: 0; width: 100%; text-align: center; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .round-title { font-weight: bold; color: #555; font-size: 1rem; }
        
        .match-card { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 8px; margin: 20px 0; width: 180px; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: auto; transition: width 0.3s; }
        .match-card:hover { border-color: #007bff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.2); }
        .match-card.card-wide-2 { width: 260px !important; }
        .match-card.card-wide-4 { width: 480px !important; }
        .match-label { font-size: 0.75rem; color: #007bff; font-weight: bold; margin-bottom: 2px; display: flex; justify-content: space-between; padding: 0 2px; }
        .bracket-input { width: 100%; box-sizing: border-box; border: none; border-bottom: 1px solid #eee; font-size: 16px; padding: 4px; text-align: left; background: transparent; white-space: nowrap; overflow: hidden; }
        .team-name-input { width: 100%; border: none; border-bottom: 1px solid #007bff; font-size: 0.9rem; font-weight: 800; color: #000; padding: 2px 4px; background: #f0f8ff; box-sizing: border-box; text-align: left; }
        .team-block { display: flex; flex-direction: column; gap: 2px; margin-bottom: 6px; border: 1px solid #eee; padding: 4px; border-radius: 4px; background: #fcfcfc; }
        .roster-row { display: flex; width: 100%; gap: 4px; margin-top: 2px; }
        .player-input { flex: 1; border: 1px dashed #ccc; border-radius: 3px; font-size: 0.8rem; padding: 3px; text-align: center; background: #fff; min-width: 0; }
        .vs-text { font-size: 0.65rem; color: #ccc; text-align: center; margin: 1px 0; font-weight: bold;}
        .status-badge { font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; margin-left: auto; }
        .status-pending { background: #eee; color: #777; }
        .status-playing { background: #ffc107; color: #333; }
        .status-finished { background: #007bff; color: white; }

        /* Âæ™Áí∞Ë≥ΩË°®Ê†º (Grid Layout) */
        .group-grid { 
            display: grid; 
            /* Êô∫ÊÖßÂ°´ÊªøÔºöÊØèÂÄãÊ†ºÂ≠êËá≥Â∞ë 320pxÔºåÁ©∫ÈñìÂ§†Â∞±Ëá™Âãï‰∏¶Êéí */
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
            padding: 0;
            width: 100%; 
            box-sizing: border-box;
        }
        .group-box { background: #fff; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .group-header { background: #343a40; color: #fff; padding: 8px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .group-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .group-table th { background: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 8px; text-align: center; font-size: 0.8rem; color: #555; }
        .group-table td { padding: 5px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle;}
        .group-table input { width: 100%; border: none; text-align: center; background: transparent; font-weight: bold; font-family: inherit; }
        .group-name-input { text-align: left !important; padding-left: 5px; width: 100%; box-sizing: border-box;}
        .stat-input { width: 40px !important; border-bottom: 1px solid #ddd !important; }
        .group-team-block { display: flex; flex-direction: column; gap: 2px; }
        .group-roster { display: flex; gap: 2px; }
        .group-roster input { border: 1px dashed #ccc; border-radius: 3px; font-size: 0.75rem; padding: 2px; width: 100%; color: #666; font-weight: normal; }
        
        #knockout-btn-area { width: 100%; text-align: center; margin: 30px 0; padding-bottom: 20px; }
        .btn-advance { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); border: none; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
        .btn-advance:hover { transform: scale(1.05); }

        /* Schedule List */
        #schedule-container { margin: 0; background: #fff; border: 2px solid #007bff; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 0; overflow: hidden; width: 100%; box-sizing: border-box; }
        .schedule-title { background: #007bff; color: white; padding: 10px 15px; font-size: 1.2rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .schedule-table { width: 100%; border-collapse: collapse; }
        .schedule-table th { background: #f1f3f5; padding: 10px; text-align: center; font-size: 0.9rem; border-bottom: 2px solid #dee2e6; color: #495057; }
        .schedule-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        .schedule-table tr:hover { background: #f8f9fa; }
        .schedule-table tr.row-playing { background: #fff3cd; border-left: 4px solid #ffc107; }
        .btn-load-match { background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .btn-load-match:hover { background: #218838; }
        .btn-load-match:disabled { background: #ccc; cursor: not-allowed; }
        .time-input, .board-input { width: 60px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; padding: 4px; font-size: 0.9rem; }
        .score-display { font-weight: 900; font-size: 1.1rem; padding: 0 10px; }
        .match-id-badge { display: inline-block; background: #6c757d; color: white; border-radius: 4px; padding: 3px 6px; font-size: 0.8rem; min-width: 40px; font-weight: bold; }

        svg#dartboard { max-width: 90%; max-height: 90%; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); }
        .area-black { fill: #212529; stroke: #6c757d; } .area-white { fill: #f8f9fa; stroke: #6c757d; }
        .area-red { fill: #e02e42; stroke: #6c757d; } .area-green { fill: #26a65b; stroke: #6c757d; }
        .text-label { font-size: 24px; font-weight: 900; fill: #fff; pointer-events: none; text-anchor: middle; dominant-baseline: central; alignment-baseline: central; text-shadow: 0 0 4px rgba(0,0,0,0.9); }
        .dart-marker { pointer-events: none; stroke: #fff; stroke-width: 1px; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3)); transition: all 0.15s ease-out; }
        .dart-marker-1 { fill: #dc3545; } .dart-marker-2 { fill: #28a745; } .dart-marker-3 { fill: #007bff; } 
    </style>
</head>
<body>

    <div id="bracket-modal" class="layout-canvas">
        <div id="bracket-header">
            <div class="header-top">
                <div class="header-controls">
                    <select id="mode-selector" class="control-select" onchange="changeBracketMode()">
                        <option value="1">1v1 ÂñÆ‰∫∫</option>
                        <option value="2">2v2 Èõô‰∫∫</option>
                        <option value="4">4v4 ÂúòÈ´î</option>
                    </select>
                    <select id="format-selector" class="control-select" onchange="changeBracketFormat()">
                        <option value="SINGLE_ELIM">ÂñÆÊïóÊ∑òÊ±∞</option>
                        <option value="ROUND_ROBIN">ÂàÜÁµÑÂæ™Áí∞ (Group)</option>
                    </select>
                    <select id="size-selector" class="control-select" onchange="changeBracketSize()">
                        <option value="4">4ÁµÑ/‰∫∫</option>
                        <option value="8" selected>8ÁµÑ/‰∫∫</option>
                        <option value="16">16ÁµÑ/‰∫∫</option>
                        <option value="32">32ÁµÑ/‰∫∫</option>
                        <option value="64">64ÁµÑ/‰∫∫</option>
                        <option value="128">128ÁµÑ/‰∫∫</option>
                    </select>
                </div>
                <button id="close-bracket" onclick="closeBracket()" style="padding:5px 15px; cursor:pointer;">ÈóúÈñâ (Close)</button>
            </div>
            <div class="header-tabs">
                <div id="tab-visual" class="view-tab active-tab" onclick="switchView('visual')">Ë≥ΩÁ®ãÂúñ (Bracket)</div>
                <div id="tab-schedule" class="view-tab" onclick="switchView('schedule')">ÊôÇÈñìË°® (Schedule)</div>
            </div>
        </div>
        
        <div id="bracket-content">
            <div id="bracket-scroll-view">
                <div id="view-visual" class="view-section active-view">
                    <svg id="bracket-lines"></svg>
                    <div id="bracket-container" class="bracket-container mode-single"></div>
                </div>
                <div id="view-schedule" class="view-section">
                    <div id="schedule-container">
                        <div class="schedule-title">
                            <div>Ë≥Ω‰∫ã‰∏≠ÊéßÂè∞ (Master Schedule)</div>
                            <div style="font-size:0.8rem; font-weight:normal;">ÈªûÊìä„ÄåËºâÂÖ•„ÄçÈÄ≤Ë°åË®àÂàÜÔºåÁµêÊùüÂæåËá™ÂãïÂõûÂ°´</div>
                        </div>
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th style="width:50px;">#</th>
                                    <th>ÊôÇÈñì (Time)</th>
                                    <th>Èù∂ÈÅì (Board)</th>
                                    <th style="text-align:right">Player 1</th>
                                    <th>Score</th>
                                    <th style="text-align:left">Player 2</th>
                                    <th>ÁãÄÊÖã/Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="left-panel">
            <svg id="dartboard" viewBox="-250 -250 500 500"></svg>
            <button id="btn-miss-trigger" onclick="handleMiss()"><div>MISS</div><div style="font-size:0.8rem">ËÑ´Èù∂</div></button>
            <div id="board-overlay">
                <div class="overlay-text">Ë´ãÊ†∏Â∞çÂàÜÊï∏</div>
                <div style="font-size:1.2rem; color:#555; font-weight:bold; margin-top:10px;">‰∏¶Êåâ‰∏ãÊèõ‰∫∫Èçµ</div>
            </div>
        </div>
        <div id="right-panel">
            <button id="bracket-btn" onclick="openBracket()">Ë≥ΩÁ®ãË°® / Ëº∏ÂÖ•ÂêçÂñÆ</button>
            <div class="player-card active active-p1" id="p1-card">
                <div class="player-header"><div class="turn-indicator">üëâ</div><div class="player-name" id="p1-name">Player 1</div></div>
                <div class="dart-slots" id="p1-slots"><div class="dart-slot">-</div><div class="dart-slot">-</div><div class="dart-slot">-</div></div>
                <div class="turn-score-box">Turn: <span id="p1-turn-score">0</span></div>
                <div class="score-big" id="p1-score">501</div>
                <div class="checkout-hint" id="p1-hint"></div>
                <div class="round-display">
                    <span>Legs: <span id="p1-legs">0</span></span>
                    <span class="stat-badge">Avg: <span id="p1-avg">0.00</span></span>
                </div>
            </div>
            <div class="player-card" id="p2-card">
                <div class="player-header"><div class="turn-indicator">üëâ</div><div class="player-name" id="p2-name">Player 2</div></div>
                <div class="dart-slots" id="p2-slots"><div class="dart-slot">-</div><div class="dart-slot">-</div><div class="dart-slot">-</div></div>
                <div class="turn-score-box">Turn: <span id="p2-turn-score">0</span></div>
                <div class="score-big" id="p2-score">501</div>
                <div class="checkout-hint" id="p2-hint"></div>
                <div class="round-display">
                    <span>Legs: <span id="p2-legs">0</span></span>
                    <span class="stat-badge">Avg: <span id="p2-avg">0.00</span></span>
                </div>
            </div>
            <div id="logo-placeholder">LOGO / Ë≥Ω‰∫ãÂêçÁ®±</div>
            <div id="control-panel">
                <button id="btn-undo" onclick="undoLastDart()">Âæ©Âéü</button>
                <button id="btn-next" onclick="switchPlayer()">Êèõ‰∏ã‰∏Ä‰Ωç (NEXT)</button>
            </div>
        </div>
    </div>

<script>
    window.addEventListener('beforeunload', function (e) { e.preventDefault(); e.returnValue = ''; });

    const STORAGE_KEY = 'dart_scorer_v60_data';
    let TOTAL_PLAYERS = 8;
    let TEAM_SIZE = 1; 
    let CURRENT_FORMAT = 'SINGLE_ELIM';
    let matchesData = {}; 
    let currentMatchId = null;
    let targetLegs = 3;

    let players = {
        1: { score: 501, legs: 0, roundHistory: [], totalScore: 0, totalDarts: 0, turnScore: 0 }, 
        2: { score: 501, legs: 0, roundHistory: [], totalScore: 0, totalDarts: 0, turnScore: 0 }
    };
    let currentPlayer = 1, legStarter = 1, turnDarts = 0, isBoardLocked = false;

    // === View & Layout Control (V60 FIX) ===
    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
        document.querySelectorAll('.view-tab').forEach(el => el.classList.remove('active-tab'));
        document.getElementById(`view-${viewName}`).classList.add('active-view');
        document.getElementById(`tab-${viewName}`).classList.add('active-tab');
        updateLayoutClass(viewName);
        if(viewName === 'visual') setTimeout(drawConnectors, 50);
    }
    
    function updateLayoutClass(viewName) {
        const modal = document.getElementById('bracket-modal');
        // V60 Fix: ‰ΩøÁî®‰∏ÄËá¥ÁöÑ class ÂêçÁ®± layout-grid / layout-canvas
        modal.classList.remove('layout-canvas', 'layout-grid');
        
        if (viewName === 'schedule' || CURRENT_FORMAT === 'ROUND_ROBIN') {
            modal.classList.add('layout-grid');
        } else {
            modal.classList.add('layout-canvas');
        }
    }

    // === Save / Load ===
    function saveGameData() {
        const data = {
            players, matchesData, currentMatchId, currentPlayer, legStarter, turnDarts, isBoardLocked,
            TOTAL_PLAYERS, TEAM_SIZE, CURRENT_FORMAT,
            bracketInputs: getBracketInputs(),
            scheduleInputs: getScheduleInputs()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function getBracketInputs() {
        const inputs = {};
        document.querySelectorAll('.bracket-input, .team-name-input, .player-input, .group-name-input, .stat-input').forEach(el => {
            if (el.id) inputs[el.id] = el.value;
        });
        return inputs;
    }
    
    function getScheduleInputs() {
        const inputs = {};
        document.querySelectorAll('.time-input, .board-input').forEach(el => {
            if (el.dataset.mid) inputs[`${el.classList[0]}-${el.dataset.mid}`] = el.value;
        });
        return inputs;
    }

    function loadGameData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            players = data.players || players;
            matchesData = data.matchesData || {};
            currentMatchId = data.currentMatchId || null;
            currentPlayer = data.currentPlayer;
            legStarter = data.legStarter;
            turnDarts = data.turnDarts;
            isBoardLocked = data.isBoardLocked;
            TOTAL_PLAYERS = data.TOTAL_PLAYERS || 8;
            TEAM_SIZE = data.TEAM_SIZE || 1;
            CURRENT_FORMAT = data.CURRENT_FORMAT || 'SINGLE_ELIM';

            document.getElementById('mode-selector').value = TEAM_SIZE;
            document.getElementById('size-selector').value = TOTAL_PLAYERS;
            document.getElementById('format-selector').value = CURRENT_FORMAT;
            
            initBracketStructure(); 
            
            setTimeout(() => {
                if(data.bracketInputs) {
                    for(let id in data.bracketInputs) {
                        const el = document.getElementById(id);
                        if(el) el.value = data.bracketInputs[id];
                        if(el && (el.className.includes('bracket-input')||el.className.includes('team-name-input'))) autoFitText(el);
                    }
                }
                if(data.scheduleInputs) {
                    for(let key in data.scheduleInputs) {
                        const parts = key.split('-');
                        const mid = parts[2];
                        const type = parts[0]; 
                        const el = document.querySelector(`.${type}-input[data-mid="${mid}"]`);
                        if(el) el.value = data.scheduleInputs[key];
                    }
                }
                if(CURRENT_FORMAT === 'ROUND_ROBIN') updateStandingsFromMatches();
                drawConnectors();
                updateUI();
                updateActiveCard();
            }, 100);
        } catch (e) { console.error(e); }
    }

    // === Core Bracket Logic ===
    function changeBracketSize() { 
        TOTAL_PLAYERS = parseInt(document.getElementById('size-selector').value); 
        if(confirm(`Á¢∫ÂÆöÂàáÊèõÁÇ∫ ${TOTAL_PLAYERS} ÁµÑÔºü(ËàäË≥ΩÁ®ãÂ∞áÈáçÁΩÆ)`)) {
            matchesData = {}; 
            initBracketStructure();
            saveGameData(); 
        }
    }
    function changeBracketMode() { 
        TEAM_SIZE = parseInt(document.getElementById('mode-selector').value); 
        if(confirm(`Á¢∫ÂÆöÂàáÊèõÁÇ∫ ${getModeName()} Ë≥ΩÂà∂Ôºü(ËàäË≥ΩÁ®ãÂ∞áÈáçÁΩÆ)`)) {
            matchesData = {}; 
            initBracketStructure(); 
            saveGameData(); 
        }
    }
    function changeBracketFormat() { 
        CURRENT_FORMAT = document.getElementById('format-selector').value; 
        if(confirm(`Á¢∫ÂÆöÂàáÊèõÁÇ∫ ${CURRENT_FORMAT}Ôºü(ËàäË≥ΩÁ®ãÂ∞áÈáçÁΩÆ)`)) {
            matchesData = {}; 
            initBracketStructure(); 
            saveGameData(); 
        }
    }

    function initBracketStructure() {
        const container = document.getElementById('bracket-container');
        container.innerHTML = '';
        
        const currentTab = document.querySelector('.view-tab.active-tab').id.replace('tab-', '');
        updateLayoutClass(currentTab);

        if(Object.keys(matchesData).length === 0) matchesData = {};

        switch(CURRENT_FORMAT) {
            case 'SINGLE_ELIM':
                generateSingleElimination();
                break;
            case 'ROUND_ROBIN':
                generateRoundRobin();
                break;
        }
        refreshScheduleDOM();
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', saveGameData);
        });
    }

    // --- Single Elim ---
    function generateSingleElimination() {
        const container = document.getElementById('bracket-container');
        const isNew = (Object.keys(matchesData).length === 0);
        const totalRounds = Math.log2(TOTAL_PLAYERS);
        let matchCounter = 0;
        let matchesInRound = TOTAL_PLAYERS / 2;

        for (let r = 0; r < totalRounds; r++) {
            const roundDiv = document.createElement('div');
            roundDiv.className = 'round-column';
            roundDiv.id = `round-${r}`;
            roundDiv.innerHTML = `<div class="round-header"><div class="round-title">${r === totalRounds - 1 ? "Final" : "Round "+(r+1)}</div></div>`;

            for (let i = 0; i < matchesInRound; i++) {
                const mid = matchCounter++;
                if(isNew || !matchesData[mid]) {
                    matchesData[mid] = { id: mid, type: 'tree', round: r, p1score: 0, p2score: 0, status: 'pending', nextMatchId: null };
                }
                const isFirstRound = (r === 0);
                let p1Html = (TEAM_SIZE > 1 && isFirstRound) ? generateFullTeamBlock(mid, 1) : generateSimpleBlock(mid, 1, isFirstRound);
                let p2Html = (TEAM_SIZE > 1 && isFirstRound) ? generateFullTeamBlock(mid, 2) : generateSimpleBlock(mid, 2, isFirstRound);
                let widthClass = (isFirstRound && TEAM_SIZE===2)?"card-wide-2":(isFirstRound && TEAM_SIZE===4)?"card-wide-4":"";

                const card = document.createElement('div');
                card.className = `match-card ${widthClass}`;
                card.id = `match-card-${mid}`;
                card.onclick = () => loadMatch(mid); 
                card.innerHTML = `<div class="match-label">M${mid+1} <span id="badge-${mid}" class="status-badge status-${matchesData[mid].status}">${matchesData[mid].status}</span></div>${p1Html}<div class="vs-text">VS</div>${p2Html}`;
                roundDiv.appendChild(card);
            }
            container.appendChild(roundDiv);
            matchesInRound /= 2;
        }
        setupConnectors(totalRounds);
        setTimeout(drawConnectors, 200);
    }

    function setupConnectors(totalRounds) {
        let currentStartId = 0;
        let currentCount = TOTAL_PLAYERS / 2;
        for (let r = 0; r < totalRounds - 1; r++) {
            const nextRoundStartId = currentStartId + currentCount;
            for (let i = 0; i < currentCount; i++) {
                const currentId = currentStartId + i;
                const targetId = nextRoundStartId + Math.floor(i / 2);
                matchesData[currentId].nextMatchId = targetId;
            }
            currentStartId += currentCount;
            currentCount /= 2;
        }
    }

    // --- Round Robin ---
    const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let groupStructure = []; 

    function generateRoundRobin() {
        const container = document.getElementById('bracket-container');
        document.getElementById('bracket-lines').innerHTML = '';
        
        let targetGroupSize = 4;
        let numGroups = Math.ceil(TOTAL_PLAYERS / targetGroupSize);
        if(numGroups < 1) numGroups = 1;
        let baseSize = Math.floor(TOTAL_PLAYERS / numGroups);
        let remainder = TOTAL_PLAYERS % numGroups;

        const grid = document.createElement('div');
        grid.className = 'group-grid';
        
        let globalPlayerCounter = 1;
        let matchCounter = 0;
        const isNew = (Object.keys(matchesData).length === 0);
        groupStructure = [];

        for (let g = 0; g < numGroups; g++) {
            const groupLetter = ALPHABET[g % 26];
            let currentGroupSize = baseSize + (g < remainder ? 1 : 0);
            groupStructure.push({ id: g, letter: groupLetter, size: currentGroupSize });
            
            const groupBox = document.createElement('div');
            groupBox.className = 'group-box';
            let rowsHtml = '';

            for (let i = 0; i < currentGroupSize; i++) {
                let globalPid = globalPlayerCounter++;
                let nameCellContent = '';
                if(TEAM_SIZE === 1) {
                    nameCellContent = `<input class="group-name-input" id="g${g}-p${i}-name" value="Player ${globalPid}" placeholder="Name">`;
                } else {
                    let membersHtml = '';
                    for(let k=0; k<TEAM_SIZE; k++) membersHtml += `<input id="g${g}-p${i}-m${k}" class="player-input" placeholder="P${k+1}">`;
                    nameCellContent = `<div class="group-team-block"><input class="group-name-input" id="g${g}-p${i}-name" value="Team ${globalPid}" placeholder="Team Name" style="font-weight:800; border-bottom:1px solid #007bff;"><div class="group-roster">${membersHtml}</div></div>`;
                }

                rowsHtml += `<tr>
                    <td style="color:#999;">${i+1}</td>
                    <td style="text-align:left;">${nameCellContent}</td>
                    <td><input type="number" class="stat-input" id="g${g}-p${i}-w" value="0" readonly></td>
                    <td><input type="number" class="stat-input" id="g${g}-p${i}-l" value="0" readonly></td>
                    <td><input type="number" class="stat-input" id="g${g}-p${i}-pt" value="0" readonly></td>
                </tr>`;
            }
            groupBox.innerHTML = `<div class="group-header"><span>Group ${groupLetter}</span></div><table class="group-table"><thead><tr><th>#</th><th>Name / Roster</th><th>W</th><th>L</th><th>Pt</th></tr></thead><tbody>${rowsHtml}</tbody></table>`;
            grid.appendChild(groupBox);

            if(isNew) {
                for(let i=0; i<currentGroupSize; i++) {
                    for(let j=i+1; j<currentGroupSize; j++) {
                        const mid = matchCounter++;
                        matchesData[mid] = { id: mid, type: 'group', groupIdx: g, p1idx: i, p2idx: j, p1score: 0, p2score: 0, status: 'pending' };
                    }
                }
            } else {
                matchCounter += (currentGroupSize * (currentGroupSize-1)) / 2;
            }
        }
        container.appendChild(grid);
        
        const btnArea = document.createElement('div');
        btnArea.id = 'knockout-btn-area';
        btnArea.innerHTML = `<button class="btn-advance" onclick="generateKnockoutFromGroups()">üèÜ ÁµêÊùüÂ∞èÁµÑË≥ΩÔºåÁî¢ÁîüÊ∑òÊ±∞Ë≥ΩÁ®ã</button>`;
        container.appendChild(btnArea);
    }

    function generateKnockoutFromGroups() {
        if(!confirm("Á¢∫ÂÆöË¶ÅÁµêÊùüÂæ™Áí∞Ë≥ΩÂóéÔºü\nÁ≥ªÁµ±Â∞áÊäìÂèñÂêÑÁµÑÂâç 2 ÂêçÔºåÁî¢ÁîüÊ±∫Ë≥ΩÊ®πÁãÄÂúñ„ÄÇ")) return;

        let qualifiedPlayers = [];
        groupStructure.forEach(g => {
            let playersInGroup = [];
            for(let i=0; i<g.size; i++) {
                const w = parseInt(document.getElementById(`g${g.id}-p${i}-w`).value) || 0;
                const pt = parseInt(document.getElementById(`g${g.id}-p${i}-pt`).value) || 0;
                const name = document.getElementById(`g${g.id}-p${i}-name`).value;
                let members = [];
                if(TEAM_SIZE > 1) {
                    for(let k=0; k<TEAM_SIZE; k++) {
                         let mEl = document.getElementById(`g${g.id}-p${i}-m${k}`);
                         if(mEl) members.push(mEl.value);
                    }
                }
                playersInGroup.push({ id: i, name: name, w: w, pt: pt, members: members });
            }
            playersInGroup.sort((a, b) => (b.w !== a.w) ? b.w - a.w : b.pt - a.pt);
            if(playersInGroup.length > 0) qualifiedPlayers.push(playersInGroup[0]);
            if(playersInGroup.length > 1) qualifiedPlayers.push(playersInGroup[1]);
        });

        if (qualifiedPlayers.length < 2) { alert("ÊôâÁ¥ö‰∫∫Êï∏‰∏çË∂≥ÔºåÁÑ°Ê≥ïÁî¢ÁîüË≥ΩÁ®ã"); return; }
        
        let newTotal = Math.pow(2, Math.ceil(Math.log2(qualifiedPlayers.length)));
        CURRENT_FORMAT = 'SINGLE_ELIM';
        TOTAL_PLAYERS = newTotal;
        document.getElementById('format-selector').value = 'SINGLE_ELIM';
        document.getElementById('size-selector').value = newTotal;

        matchesData = {}; 
        initBracketStructure(); 

        setTimeout(() => {
            qualifiedPlayers.forEach((p, idx) => {
                let nameInput = (TEAM_SIZE > 1) ? 
                    document.getElementById(`m${Math.floor(idx/2)}-t${(idx%2)+1}-name`) :
                    document.getElementById(`m${Math.floor(idx/2)}-t${(idx%2)+1}-p0`);
                if(nameInput) { nameInput.value = p.name; autoFitText(nameInput); }
                
                if(TEAM_SIZE > 1 && p.members) {
                    p.members.forEach((memName, k) => {
                         let memInput = document.getElementById(`m${Math.floor(idx/2)}-t${(idx%2)+1}-p${k}`);
                         if(memInput) memInput.value = memName;
                    });
                }
            });
            saveGameData(); 
            refreshScheduleDOM(); 
        }, 100);
    }

    // === Schedule DOM ===
    function refreshScheduleDOM() {
        const tbody = document.getElementById('schedule-body');
        tbody.innerHTML = '';
        const matchIds = Object.keys(matchesData).map(k=>parseInt(k)).sort((a,b)=>a-b);
        
        matchIds.forEach(mid => {
            const m = matchesData[mid];
            const row = document.createElement('tr');
            row.id = `sched-row-${mid}`;
            if(m.status === 'playing') row.classList.add('row-playing');
            
            let p1Name = "???", p2Name = "???";
            if(m.type === 'tree') {
                p1Name = getTeamNameText(mid, 1) || "Winner";
                p2Name = getTeamNameText(mid, 2) || "Winner";
            } else {
                p1Name = getGroupPlayerName(m.groupIdx, m.p1idx);
                p2Name = getGroupPlayerName(m.groupIdx, m.p2idx);
            }

            let defTime = (m.type === 'tree' && m.round === 0) ? "10:00" : ""; 
            let defBoard = (m.type === 'tree' && m.round === 0) ? (mid + 1) : "";

            row.innerHTML = `
                <td><span class="match-id-badge">${mid+1}</span></td>
                <td><input class="time-input" data-mid="${mid}" value="${defTime}" placeholder="Time"></td>
                <td><input class="board-input" data-mid="${mid}" value="${defBoard}" placeholder="Bd"></td>
                <td style="text-align:right; font-weight:bold; color:#007bff;">${p1Name}</td>
                <td><span class="score-display">${m.p1score} - ${m.p2score}</span></td>
                <td style="text-align:left; font-weight:bold; color:#dc3545;">${p2Name}</td>
                <td><button class="btn-load-match" onclick="loadMatch(${mid})" ${m.status==='finished'?'disabled':''}>${m.status==='playing'?'Ë®àÂàÜ‰∏≠...':(m.status==='finished'?'ÂÆåË≥Ω':'ËºâÂÖ•')}</button></td>
            `;
            tbody.appendChild(row);
        });
    }

    // === Helpers ===
    function generateFullTeamBlock(mid, t){
        let html = `<div class='team-block'><input class='team-name-input' id='m${mid}-t${t}-name' value='Team ${mid*2+t}' onclick="event.stopPropagation()">`;
        html += `<div class='roster-row'>`;
        for(let k=0; k<TEAM_SIZE; k++) html += `<input id="m${mid}-t${t}-p${k}" class="player-input" placeholder="P${k+1}" onclick="event.stopPropagation()">`;
        html += `</div></div>`;
        return html;
    }
    function generateSimpleBlock(mid, t, isFirst){return `<div class='team-block'><input id='m${mid}-t${t}-name' class='bracket-input' value='${isFirst?"Player "+(mid*2+t):""}' placeholder='${isFirst?"Name":"Winner"}' ${isFirst?"":"readonly"}></div>`;}
    function getTeamNameText(mid, t){ const el = document.getElementById(`m${mid}-t${t}-name`); return el?el.value:""; }
    function setNextRoundWinner(mid, t, name){ const el=document.getElementById(`m${mid}-t${t}-name`); if(el) el.value=name; }
    function getModeName() { if(TEAM_SIZE === 2) return 'Èõô‰∫∫ (2v2)'; if(TEAM_SIZE === 4) return 'ÂúòÈ´î (4v4)'; return 'ÂñÆ‰∫∫ (1v1)'; }
    function autoFitText(el) { const maxFontSize = 16; const minFontSize = 9; el.style.fontSize = maxFontSize + 'px'; while (el.scrollWidth > el.clientWidth && parseFloat(el.style.fontSize) > minFontSize) { el.style.fontSize = (parseFloat(el.style.fontSize) - 1) + 'px'; } }
    function openBracket() { document.getElementById('bracket-modal').style.display = 'flex'; if(document.getElementById('schedule-body').innerHTML==='') initBracketStructure(); setTimeout(drawConnectors,100);}
    function closeBracket() { document.getElementById('bracket-modal').style.display = 'none'; saveGameData(); }

    // === Match Logic ===
    function loadMatch(mid) {
        saveGameData();
        const m = matchesData[mid];
        let p1Name, p2Name;
        if(m.type === 'tree') {
            p1Name = getTeamNameText(mid, 1);
            p2Name = getTeamNameText(mid, 2);
            if(p2Name.includes('Bye') || p2Name === "") { alert("Ëº™Á©∫Â†¥Ê¨°ÁÑ°Ê≥ïËºâÂÖ•"); return; }
        } else {
            p1Name = getGroupPlayerName(m.groupIdx, m.p1idx);
            p2Name = getGroupPlayerName(m.groupIdx, m.p2idx);
        }
        if(confirm(`ËºâÂÖ•Â†¥Ê¨° #${mid+1} ?\n${p1Name} vs ${p2Name}`)) {
            if(currentMatchId !== null && matchesData[currentMatchId].status === 'playing') matchesData[currentMatchId].status = 'pending';
            currentMatchId = mid;
            m.status = 'playing';
            document.getElementById('p1-name').innerText = p1Name;
            document.getElementById('p2-name').innerText = p2Name;
            
            players[1].score = 501; players[2].score = 501;
            players[1].legs = m.p1score;
            players[2].legs = m.p2score;
            players[1].roundHistory = []; players[2].roundHistory = [];
            
            // V57: Reset Turn Scores
            players[1].turnScore = 0; players[2].turnScore = 0;
            document.getElementById('p1-turn-score').innerText = 0;
            document.getElementById('p2-turn-score').innerText = 0;

            turnDarts = 0; isBoardLocked = false; currentPlayer = 1; legStarter = 1;
            players[1].totalScore = 0; players[1].totalDarts = 0;
            players[2].totalScore = 0; players[2].totalDarts = 0;

            updateUI();
            refreshScheduleDOM(); 
            closeBracket();
        }
    }

    function finishMatch(winnerIdx) {
        if(currentMatchId === null) return;
        const m = matchesData[currentMatchId];
        m.status = 'finished'; 
        m.p1score = players[1].legs;
        m.p2score = players[2].legs;
        const winnerName = (winnerIdx === 1) ? document.getElementById('p1-name').innerText : document.getElementById('p2-name').innerText;
        alert(`ÊØîË≥ΩÁµêÊùüÔºÅÂãùËÄÖÔºö${winnerName}`);
        if(m.type === 'tree') {
            if(m.nextMatchId !== null) {
                const teamNum = (m.id % 2 === 0) ? 1 : 2;
                setNextRoundWinner(m.nextMatchId, teamNum, winnerName);
            } else { alert("ÂÜ†ËªçÁî¢ÁîüÔºÅ"); }
        } else { updateStandingsFromMatches(); }
        currentMatchId = null;
        refreshScheduleDOM();
        saveGameData();
        openBracket();
    }

    function updateStandingsFromMatches() {
        document.querySelectorAll('.stat-input').forEach(el => el.value = 0);
        for(let k in matchesData) {
            const m = matchesData[k];
            if(m.type === 'group' && m.status === 'finished') {
                const p1Win = m.p1score > m.p2score;
                const winnerIdx = p1Win ? m.p1idx : m.p2idx;
                const loserIdx = p1Win ? m.p2idx : m.p1idx;
                const g = m.groupIdx;
                incVal(`g${g}-p${winnerIdx}-w`);
                incVal(`g${g}-p${loserIdx}-l`);
                incVal(`g${g}-p${winnerIdx}-pt`);
            }
        }
    }
    function incVal(id) { const el = document.getElementById(id); if(el) el.value = parseInt(el.value) + 1; }
    function getGroupPlayerName(g, pIdx) { const el = document.getElementById(`g${g}-p${pIdx}-name`); return el ? el.value : `P${pIdx+1}`; }
    
    // === V59: Double Out Logic ===
    function handleHit(e) {
        if (isBoardLocked) return;
        
        const scoreHit = parseInt(e.target.getAttribute("data-score"));
        const hitId = e.target.getAttribute("data-id") || scoreHit;
        
        const midAngle = parseFloat(e.target.getAttribute("data-angle"));
        const midRadius = parseFloat(e.target.getAttribute("data-radius"));
        const isBull = (hitId === 'B50' || hitId === 'B25');

        let hitCount = (turnHitCounts[hitId] || 0) + 1;
        turnHitCounts[hitId] = hitCount;
        let finalRadius = midRadius;
        const radialOffset = 8; 
        if (!isBull) {
            if (hitCount === 2) { finalRadius = midRadius - radialOffset; } 
            if (hitCount === 3) { finalRadius = midRadius + radialOffset; } 
        } else {
            if (hitCount === 2) finalRadius -= 5;
            if (hitCount === 3) finalRadius += 5;
        }
        const radian = midAngle * Math.PI / 180;
        addDartMarker(finalRadius * Math.cos(radian), finalRadius * Math.sin(radian), turnDarts + 1, 4);

        const p = players[currentPlayer];
        const remaining = p.score - scoreHit;

        // V59: Double Out Logic
        if (remaining < 0 || remaining === 1) { 
            alert("ÁàÜÈè¢ (Bust)!"); 
            revertTurn(p); 
            lockBoard(); 
            return; 
        }

        if (remaining === 0) {
            const isDouble = (hitId.startsWith && hitId.startsWith('D')) || hitId === 'B50';
            if (!isDouble) {
                alert("Êú™ÈõôÂÄçÁµêÊ®ô (No Double)! ÁàÜÈè¢„ÄÇ");
                revertTurn(p);
                lockBoard();
                return;
            } else {
                p.score = 0;
                p.totalScore += scoreHit;
                p.totalDarts++;
                let h = { id: hitId, score: scoreHit, player: currentPlayer, turnIndex: turnDarts };
                p.roundHistory.push(h);
                
                updateUI();
                setTimeout(() => { alert("Game Shot!"); handleLegWin(currentPlayer); }, 100);
                return;
            }
        }
        
        p.score -= scoreHit; 
        turnDarts++;
        
        p.totalScore += scoreHit;
        p.totalDarts++;

        let h = { id: hitId, score: scoreHit, player: currentPlayer, turnIndex: turnDarts };
        p.roundHistory.push(h); 
        
        updateUI(); saveGameData(); 
        if (turnDarts >= 3) lockBoard();
    }

    function revertTurn(p) {
        let turnGain = 0;
        for(let i=0; i<turnDarts; i++) {
            let shot = p.roundHistory[p.roundHistory.length - 1 - i];
            turnGain += shot.score;
        }
        p.score += turnGain; 
    }

    function handleMiss() {
        if (isBoardLocked) return;
        const p = players[currentPlayer];
        turnDarts++;
        p.totalDarts++;
        let h = { id: 'Miss', score: 0, player: currentPlayer, turnIndex: turnDarts };
        p.roundHistory.push(h); 
        updateUI(); saveGameData(); 
        if (turnDarts >= 3) lockBoard();
    }

    function undoLastDart() { 
        const p = players[currentPlayer];
        if(p.roundHistory.length === 0) return; 
        const last = p.roundHistory.pop(); 
        p.score += last.score; 
        turnDarts--; isBoardLocked = false; 
        p.totalScore -= last.score;
        p.totalDarts--;
        if (last.id !== 'Miss') {
            if(turnHitCounts[last.id] > 0) turnHitCounts[last.id]--;
            const lastMarker = markers.pop();
            if(lastMarker) lastMarker.remove();
        }
        updateUI(); saveGameData();
    }

    function updateUI() { 
        document.getElementById('p1-score').innerText = players[1].score; 
        document.getElementById('p2-score').innerText = players[2].score; 
        document.getElementById('p1-legs').innerText = players[1].legs; 
        document.getElementById('p2-legs').innerText = players[2].legs; 
        updateSlots(1); updateSlots(2);
        
        calcPPR(1); calcPPR(2);
        
        let currentTurnScore = getTurnScore(currentPlayer);
        document.getElementById(`p${currentPlayer}-turn-score`).innerText = currentTurnScore;
        let otherPid = (currentPlayer===1)?2:1;
        document.getElementById(`p${otherPid}-turn-score`).innerText = "0";

        // V59: Update Checkout Hint
        updateCheckoutHint(1);
        updateCheckoutHint(2);

        const overlay = document.getElementById('board-overlay');
        const btnNext = document.getElementById('btn-next');
        if(isBoardLocked) { overlay.style.display = 'flex'; btnNext.classList.add('ready'); } else { overlay.style.display = 'none'; btnNext.classList.remove('ready'); } 
    }

    // V59: Checkout Table (Simple)
    const CHECKOUTS = {
        170: "T20 T20 Bull", 167: "T20 T19 Bull", 164: "T20 T18 Bull", 161: "T20 T17 Bull", 160: "T20 T20 D20",
        158: "T20 T20 D19", 156: "T20 T20 D18", 150: "T20 T18 D18", 140: "T20 T20 D10", 130: "T20 T20 D5",
        121: "T20 T11 D14", 120: "T20 S20 D20", 110: "T20 S10 D20", 100: "T20 D20", 
        60: "S20 D20", 50: "S10 D20", 40: "D20", 36: "D18", 32: "D16", 16: "D8", 8: "D4", 4: "D2", 2: "D1"
    };
    function updateCheckoutHint(pid) {
        const score = players[pid].score;
        let hint = "";
        if (score <= 170) {
            if (CHECKOUTS[score]) hint = CHECKOUTS[score];
            else if (score <= 40 && score % 2 === 0) hint = "D" + (score/2);
        }
        document.getElementById(`p${pid}-hint`).innerText = hint;
    }

    function getTurnScore(pid) {
        const p = players[pid];
        let total = 0;
        let count = turnDarts;
        if(count > 0) {
            for(let i=0; i<count; i++) {
                let idx = p.roundHistory.length - 1 - i;
                if(idx >= 0) total += p.roundHistory[idx].score;
            }
        }
        return total;
    }

    function calcPPR(pid) {
        const p = players[pid];
        let ppr = 0;
        if(p.totalDarts > 0) {
            ppr = (p.totalScore / p.totalDarts) * 3;
        }
        document.getElementById(`p${pid}-avg`).innerText = ppr.toFixed(2);
    }

    function handleLegWin(winner) {
        players[winner].legs++;
        let legsNeeded = 2; 
        if(players[winner].legs >= legsNeeded) {
            finishMatch(winner);
        } else {
            alert("Game Shot! Next Leg.");
            legStarter = (winner===1)?2:1; currentPlayer = legStarter;
            players[1].score = 501; players[2].score = 501;
            players[1].roundHistory = []; players[2].roundHistory = [];
            
            // V59: Reset Turn Stats for new leg
            players[1].turnScore = 0; players[2].turnScore = 0;
            turnDarts = 0; isBoardLocked = false;
            
            clearMarkers();
            updateUI(); updateActiveCard();
            saveGameData();
        }
    }

    // (ÂÖ∂È§òÈ£õÈè¢ÈÇèËºØ‰øùÊåÅ‰∏çËÆä)
    function addDartMarker(x, y, dartNum, r) {
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        marker.setAttribute("cx", x); marker.setAttribute("cy", y); marker.setAttribute("r", r);
        marker.setAttribute("class", `dart-marker dart-marker-${dartNum}`);
        document.getElementById('dartboard').appendChild(marker); markers.push(marker);
    }
    function clearMarkers() { markers.forEach(m => m.remove()); markers = []; turnHitCounts = {}; }
    function switchPlayer() { currentPlayer = currentPlayer===1?2:1; turnDarts=0; isBoardLocked=false; clearMarkers(); updateActiveCard(); updateUI(); saveGameData();}
    function updateSlots(pid) {
        const hist = players[pid].roundHistory;
        const slots = document.getElementById(`p${pid}-slots`).getElementsByClassName('dart-slot');
        for(let s of slots) { s.innerText = '-'; s.classList.remove('filled', 'miss'); }
        hist.forEach((h, i) => { if (slots[i]) { slots[i].innerText = h.id; slots[i].classList.add('filled'); if(h.id === 'Miss') slots[i].classList.add('miss'); } });
    }
    function updateActiveCard() { document.getElementById('p1-card').classList.remove('active', 'active-p1'); document.getElementById('p2-card').classList.remove('active', 'active-p2'); document.getElementById(`p${currentPlayer}-card`).classList.add('active', `active-p${currentPlayer}`); }
    function lockBoard() { isBoardLocked = true; updateUI(); }
    
    // È£õÈè¢Áõ§Áπ™Ë£Ω
    function drawConnectors() {
        if(CURRENT_FORMAT !== 'SINGLE_ELIM') return; 
        const svg = document.getElementById('bracket-lines');
        const scrollView = document.getElementById('bracket-scroll-view');
        const visualView = document.getElementById('view-visual');
        if(!scrollView || visualView.style.display === 'none') return;
        svg.style.width = scrollView.scrollWidth + "px";
        svg.style.height = scrollView.scrollHeight + "px";
        svg.innerHTML = ''; 
        const rootRect = scrollView.getBoundingClientRect();
        for (let key in matchesData) {
            const match = matchesData[key];
            if (match.nextMatchId !== null) {
                const currEl = document.getElementById(`match-card-${match.id}`);
                const nextEl = document.getElementById(`match-card-${match.nextMatchId}`);
                if (currEl && nextEl) {
                    const cRect = currEl.getBoundingClientRect();
                    const nRect = nextEl.getBoundingClientRect();
                    const startX = Math.round((cRect.left - rootRect.left) + cRect.width);
                    const startY = Math.round((cRect.top - rootRect.top) + cRect.height / 2);
                    const endX = Math.round(nRect.left - rootRect.left);
                    const endY = Math.round((nRect.top - rootRect.top) + nRect.height / 2);
                    const midX = Math.round(startX + (endX - startX) / 2);
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", `M ${startX} ${startY} H ${midX} V ${endY} H ${endX}`);
                    path.setAttribute("class", "connector-path");
                    svg.appendChild(path);
                }
            }
        }
    }
    window.onresize = drawConnectors;

    const SECTORS = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
    let turnHitCounts = {}; let markers = [];

    function createBoard() {
        const svg = document.getElementById('dartboard');
        const sectorAngle = 360 / 20;
        SECTORS.forEach((score, i) => {
            const start = (i * sectorAngle) - 90 - (sectorAngle/2);
            const end = start + sectorAngle;
            const isEven = i % 2 === 0;
            drawSector(svg, start, end, 160, 195, isEven?'area-red':'area-green', `D${score}`, score*2);
            drawSector(svg, start, end, 110, 160, isEven?'area-black':'area-white', `S${score}`, score);
            drawSector(svg, start, end, 80, 110, isEven?'area-red':'area-green', `T${score}`, score*3);
            drawSector(svg, start, end, 25, 80, isEven?'area-black':'area-white', `S${score}`, score);
            drawLabel(svg, start + sectorAngle/2, 215, score);
        });
        drawCircle(svg, 25, 'area-green', 'B25', 25); 
        drawCircle(svg, 12, 'area-red', 'B50', 50);
        updateUI(); updateActiveCard();
    }
    function drawSector(svg, s, e, ir, or, cls, id, val) {
        const r1=s*Math.PI/180, r2=e*Math.PI/180;
        const x1=ir*Math.cos(r1), y1=ir*Math.sin(r1), x2=or*Math.cos(r1), y2=or*Math.sin(r1);
        const x3=or*Math.cos(r2), y3=or*Math.sin(r2), x4=ir*Math.cos(r2), y4=ir*Math.sin(r2);
        const d = `M${x1} ${y1}L${x2} ${y2}A${or} ${or} 0 0 1 ${x3} ${y3}L${x4} ${y4}A${ir} ${ir} 0 0 0 ${x1} ${y1}Z`;
        const p = document.createElementNS("http://www.w3.org/2000/svg","path");
        p.setAttribute("d",d); p.setAttribute("class",cls); p.setAttribute("data-id", id); p.setAttribute("data-score",val);
        const midAngle = (s + e) / 2; const midRadius = (ir + or) / 2;
        p.setAttribute("data-angle", midAngle); p.setAttribute("data-radius", midRadius);
        p.addEventListener('click', handleHit); svg.appendChild(p);
    }
    function drawCircle(svg, r, cls, id, val) {
        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx",0); c.setAttribute("cy",0); c.setAttribute("r",r); c.setAttribute("class",cls); c.setAttribute("data-id", id); c.setAttribute("data-score",val);
        c.setAttribute("data-angle", 0); c.setAttribute("data-radius", 0);
        c.addEventListener('click', (e)=>{e.stopPropagation(); handleHit(e);}); svg.appendChild(c);
    }
    function drawLabel(svg, angle, r, text) {
        const rad = angle * Math.PI / 180;
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", r*Math.cos(rad)); t.setAttribute("y", r*Math.sin(rad));
        t.setAttribute("class", "text-label"); t.textContent = text; svg.appendChild(t);
    }
    window.onload = function() { createBoard(); loadGameData(); };
</script>
</body>
</html>
